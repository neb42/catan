---
phase: 12-resilience-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - libs/shared/src/schemas/room.ts
  - libs/shared/src/schemas/messages.ts
  - apps/api/src/handlers/lobby-handlers.ts
  - apps/web/src/components/Lobby.tsx
  - apps/web/src/components/LobbyPlayerList.tsx
autonomous: true

must_haves:
  truths:
    - 'Players can mark themselves ready/unready anytime in lobby'
    - 'Countdown starts when all 3-4 players are ready'
    - 'Unreadying resets countdown to full 5 seconds'
    - 'Countdown displays as big number in center of screen'
    - 'Game starts automatically when countdown reaches 0'
  artifacts:
    - path: 'libs/shared/src/schemas/room.ts'
      provides: 'Player ready field'
      contains: 'isReady.*boolean'
    - path: 'apps/api/src/handlers/lobby-handlers.ts'
      provides: 'Ready toggle and countdown logic'
      exports: ['handleToggleReady']
    - path: 'apps/web/src/components/Lobby.tsx'
      provides: 'Ready button and countdown UI'
      min_lines: 200
  key_links:
    - from: 'apps/web/src/components/Lobby.tsx'
      to: "sendMessage({type: 'toggle_ready'})"
      via: 'ready button click'
      pattern: 'toggle_ready'
    - from: 'apps/api/src/handlers/lobby-handlers.ts'
      to: 'setInterval.*countdown'
      via: 'start countdown when all ready'
      pattern: 'allReady.*setInterval'
---

<objective>
Implement lobby ready-up system with countdown timer that starts game when all players are ready.

Purpose: Give players control over when game starts and create anticipation with countdown.

Output: Players can toggle ready state, countdown triggers when all 3-4 players ready, displays big center number (5...4...3...2...1), unready resets countdown, game auto-starts at 0.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-resilience-polish/12-CONTEXT.md
@libs/shared/src/schemas/room.ts
@apps/api/src/handlers/lobby-handlers.ts
@apps/web/src/components/Lobby.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend ready state and countdown logic</name>
  <files>
    libs/shared/src/schemas/room.ts
    libs/shared/src/schemas/messages.ts
    apps/api/src/handlers/lobby-handlers.ts
    apps/api/src/managers/RoomManager.ts
  </files>
  <action>
Add ready state to players and implement server-side countdown that starts game.

**In room.ts:**
Add isReady field to Player schema:

```typescript
isReady: z.boolean().default(false),
```

**In messages.ts:**
Add message schemas:

```typescript
toggle_ready: z.object({
  type: z.literal('toggle_ready'),
  roomId: z.string(),
}),

countdown_tick: z.object({
  type: z.literal('countdown_tick'),
  secondsRemaining: z.number(),
}),
```

**In RoomManager.ts:**
Add field to ManagedRoom:

```typescript
countdownTimer: NodeJS.Timeout | null; // for countdown setInterval
```

Add methods:

```typescript
startCountdown(roomId: string): void
cancelCountdown(roomId: string): void
```

**In lobby-handlers.ts:**
Create handleToggleReady function:

1. Get room, find player by context.playerId
2. Toggle player.isReady boolean
3. Broadcast room_state with updated player ready status
4. Check if all players (3-4) are ready AND game not started:
   - If yes: start 5-second countdown
   - If no (someone unreadied): cancel countdown
5. Countdown logic:
   - Use setInterval(1000ms) to decrement from 5 to 0
   - Broadcast countdown_tick message each second
   - At 0: cancel interval, call existing game start logic (generate board, start placement phase)
6. Store countdown timer in room.countdownTimer so it can be cancelled

Countdown duration: 5 seconds (per user decision). Require 3-4 players minimum (use MIN_PLAYERS constant).

If player unreadies during countdown, cancel countdown immediately and broadcast countdown_tick with secondsRemaining: -1 (signal to frontend to hide countdown).
</action>
<verify>
npx nx test api
Check Player schema has isReady field
Check handleToggleReady exists and handles countdown logic
Check countdown timer stored in RoomManager
</verify>
<done>
Players have isReady boolean, toggle_ready message toggles state, countdown starts when all 3-4 players ready, countdown broadcasts tick messages every second, unready cancels countdown, game starts automatically at 0.
</done>
</task>

<task type="auto">
  <name>Task 2: Frontend ready button and countdown UI</name>
  <files>
    apps/web/src/components/Lobby.tsx
    apps/web/src/components/LobbyPlayerList.tsx
    apps/web/src/handlers/index.ts
  </files>
  <action>
Add ready button to lobby and display countdown as big center number when all players ready.

**In Lobby.tsx state:**
Add countdown state (already exists from Phase 1):

```typescript
const [countdown, setCountdown] = useState<number | null>(null);
```

**In handlers/index.ts:**
Add handler for countdown_tick:

```typescript
case 'countdown_tick':
  if (message.secondsRemaining < 0) {
    context.setCountdown(null); // Hide countdown
  } else {
    context.setCountdown(message.secondsRemaining);
  }
  break;
```

**In Lobby.tsx (lobby view section):**
Add ready button below player list (or in player card for current player):

```typescript
<Button
  fullWidth
  size="lg"
  onClick={() => sendMessage({ type: 'toggle_ready', roomId: room.id })}
  color={currentPlayer?.isReady ? 'gray' : 'teal'}
>
  {currentPlayer?.isReady ? 'Not Ready' : 'Ready'}
</Button>
```

Add countdown display (only show when countdown !== null):

```typescript
{countdown !== null && countdown >= 0 && (
  <div style={{
    position: 'fixed',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%, -50%)',
    zIndex: 1000,
  }}>
    <Title order={1} size="120px" ta="center">
      {countdown}
    </Title>
  </div>
)}
```

Use HUGE text (120px or larger) for countdown display (per user decision "big number in center of screen").

**In LobbyPlayerList.tsx:**
Add ready indicator next to each player:

```typescript
{player.isReady && (
  <Badge color="teal" size="sm">Ready</Badge>
)}
```

Show ready/unready status for all players so everyone can see who's ready. Button only controls current player's ready state.

Countdown appears OVER lobby UI (position: fixed, high z-index). Everything else still visible behind it.
</action>
<verify>
Check Lobby.tsx has ready button that sends toggle_ready message
Check countdown displays as large centered number when not null
Check LobbyPlayerList shows ready badges next to ready players
Check handlers handle countdown_tick message
</verify>
<done>
Ready button toggles current player's ready state, ready badges show next to each ready player, countdown displays as 120px number in center of screen when all ready, countdown disappears when cancelled, game starts automatically when countdown reaches 0.
</done>
</task>

</tasks>

<verification>
Test ready system:
1. Join lobby with 3 players
2. Mark each player ready one by one
3. Countdown should start when all 3 are ready
4. Unready one player — countdown should cancel
5. Ready again — countdown restarts from 5
6. Let countdown reach 0 — game should start
</verification>

<success_criteria>

- Player schema has isReady boolean field
- Toggle_ready message toggles player ready state
- Backend starts 5-second countdown when all 3-4 players ready
- Backend cancels countdown if anyone unreadies
- Countdown_tick messages broadcast every second
- Frontend displays countdown as 120px centered number
- Ready button changes color/text based on ready state
- Ready badges show next to ready players
- Game auto-starts when countdown reaches 0
  </success_criteria>

<output>
After completion, create `.planning/phases/12-resilience-polish/12-03-SUMMARY.md`
</output>
