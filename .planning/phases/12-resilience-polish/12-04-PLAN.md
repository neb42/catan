---
phase: 12-resilience-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/GameLog.tsx
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/handlers/index.ts
  - apps/web/src/components/Board.tsx
autonomous: true

must_haves:
  truths:
    - 'All game actions logged (dice, builds, trades, cards, robber, disconnects)'
    - 'Log displays in collapsible side panel'
    - 'Log entries show player name + action (no timestamps or turn numbers)'
    - 'Log is scrollable with oldest first (chat-style)'
  artifacts:
    - path: 'apps/web/src/components/GameLog.tsx'
      provides: 'Collapsible log panel UI'
      min_lines: 80
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'Game log array'
      contains: "gameLog.*string\\[\\]"
    - path: 'apps/web/src/handlers/index.ts'
      provides: 'Log event handlers for all message types'
      min_lines: 400
  key_links:
    - from: 'apps/web/src/handlers/index.ts'
      to: 'gameStore.addLogEntry'
      via: 'log actions on messages'
      pattern: 'addLogEntry.*built.*road'
    - from: 'apps/web/src/components/GameLog.tsx'
      to: 'gameStore.gameLog'
      via: 'display log entries'
      pattern: 'useGameStore.*gameLog'
---

<objective>
Implement comprehensive game log that records all player actions and displays them in a collapsible side panel.

Purpose: Provide transparency and history so players can review what happened during the game.

Output: Every dice roll, build, trade, card play, robber action, and disconnect/reconnect logged with player name, displayed in scrollable side panel (oldest first), no timestamps or turn numbers.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-resilience-polish/12-CONTEXT.md
@apps/web/src/stores/gameStore.ts
@apps/web/src/handlers/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand game log to capture all actions</name>
  <files>
    apps/web/src/stores/gameStore.ts
    apps/web/src/handlers/index.ts
  </files>
  <action>
Ensure all game actions are logged to gameStore.gameLog array.

**In gameStore.ts:**
Verify gameLog exists (already added in Phase 7):

```typescript
gameLog: string[]; // array of log entries
addLogEntry: (entry: string) => set((state) => ({
  gameLog: [...state.gameLog, entry],
})),
```

If missing, add it. Keep simple string array (no timestamps, no metadata).

**In handlers/index.ts:**
Add addLogEntry calls for ALL message types that represent player actions. Format: "[Player name] [action]"

Required log events:

- **Dice roll:** "Alice rolled 6 (3 + 3)"
- **Build road:** "Bob built a road"
- **Build settlement:** "Alice built a settlement"
- **Build city:** "Bob upgraded to a city"
- **Trade domestic:** "Alice traded 2 wood for 1 brick with Bob"
- **Trade maritime:** "Bob traded 4 sheep for 1 ore (bank 4:1)" or "Alice traded 2 wood for 1 brick (2:1 port)"
- **Buy dev card:** "Alice bought a development card"
- **Play Knight:** "Bob played a Knight"
- **Play Road Building:** "Alice played Road Building"
- **Play Year of Plenty:** "Bob played Year of Plenty (took wheat and ore)"
- **Play Monopoly:** "Alice played Monopoly (took all brick)"
- **Move robber:** "Bob moved the robber"
- **Steal resource:** "Alice stole 1 card from Bob"
- **Discard:** "Bob discarded 3 cards"
- **Disconnect:** "Alice disconnected"
- **Reconnect:** "Alice reconnected"
- **Victory:** "Bob won with 10 points!"

For each message type in the switch statement, add:

```typescript
useGameStore.getState().addLogEntry(`${playerName} ${action}`);
```

Use player nickname from message or from gameStore.players map. Keep descriptions simple and concise.

Do NOT add timestamps or turn numbers (per user decision). Just player name + action.
</action>
<verify>
Check gameStore has gameLog array and addLogEntry action
Check handlers/index.ts has addLogEntry calls for dice_rolled, placement_confirmed, build messages, trade messages, dev card messages, robber messages, game_paused, game_resumed, victory
Count at least 15 different log entry types
</verify>
<done>
All major game actions logged to gameStore.gameLog with format "[Player] [action]", no timestamps or turn numbers, comprehensive coverage of dice, builds, trades, cards, robber, and connection events.
</done>
</task>

<task type="auto">
  <name>Task 2: Create collapsible game log panel UI</name>
  <files>
    apps/web/src/components/GameLog.tsx
    apps/web/src/components/Board.tsx
  </files>
  <action>
Create collapsible side panel that displays game log entries in scrollable list.

**Create GameLog.tsx:**

```typescript
import { useState } from 'react';
import { ActionIcon, Paper, ScrollArea, Text, Title } from '@mantine/core';
import { IconChevronLeft, IconChevronRight } from '@tabler/icons-react';
import { useGameLog } from '../stores/gameStore';

export function GameLog() {
  const [isOpen, setIsOpen] = useState(true);
  const gameLog = useGameLog();

  return (
    <div style={{
      position: 'fixed',
      right: 0,
      top: 0,
      bottom: 0,
      width: isOpen ? '300px' : '40px',
      transition: 'width 0.3s ease',
      zIndex: 100,
    }}>
      <Paper h="100%" shadow="md" p={isOpen ? 'md' : 0}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
          {isOpen && <Title order={4}>Game Log</Title>}
          <ActionIcon onClick={() => setIsOpen(!isOpen)} variant="subtle">
            {isOpen ? <IconChevronRight /> : <IconChevronLeft />}
          </ActionIcon>
        </div>

        {isOpen && (
          <ScrollArea h="calc(100% - 40px)" mt="sm">
            {gameLog.map((entry, i) => (
              <Text key={i} size="sm" mb="xs">
                {entry}
              </Text>
            ))}
          </ScrollArea>
        )}
      </Paper>
    </div>
  );
}
```

Position on RIGHT side (Claude's discretion per user decision). Width 300px when open, 40px when collapsed (just icon). Use smooth width transition for collapse animation.

Oldest entries at top, newest at bottom (chat-style per user decision). Use Mantine ScrollArea for scrollable content.

**In Board.tsx (or main game component):**
Add GameLog component:

```typescript
import { GameLog } from './GameLog';

// In render:
<>
  {/* existing game UI */}
  <GameLog />
  {/* other overlays */}
</>
```

Render at top level so it persists across all game states. Panel should overlay game board but not block critical UI elements (z-index: 100).

Use Mantine Paper for panel styling, ActionIcon for toggle button, ScrollArea for scrollable log. Icon should be chevron pointing right when open (to collapse), left when closed (to expand).
</action>
<verify>
Check GameLog.tsx component exists and renders log entries
Check Board.tsx imports and renders GameLog
Open game in browser, verify panel visible on right side
Click collapse icon, verify panel closes to 40px width
Check log entries appear in order (oldest first)
</verify>
<done>
Game log panel renders on right side of screen, collapses to 40px icon, expands to 300px panel showing all log entries, entries scroll oldest-first, panel overlays game board without blocking critical UI.
</done>
</task>

</tasks>

<verification>
Play test game and verify log captures:
1. Dice rolls with both dice values
2. All building actions (road, settlement, city)
3. Trade offers and acceptances
4. Development card purchases and plays
5. Robber moves and steals
6. Disconnect/reconnect events
7. Victory announcement

Check log panel can be collapsed and expanded smoothly.
</verification>

<success_criteria>

- gameStore.gameLog array stores all log entries as strings
- addLogEntry calls in handlers for 15+ message types
- Log entries format: "[Player] [action]" (no timestamps)
- GameLog component renders on right side (fixed position)
- Panel width 300px when open, 40px when collapsed
- Collapse/expand animation smooth (0.3s transition)
- Log entries scrollable with ScrollArea
- Oldest entries at top, newest at bottom
- Panel visible at all times during game
  </success_criteria>

<output>
After completion, create `.planning/phases/12-resilience-polish/12-04-SUMMARY.md`
</output>
