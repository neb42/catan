---
phase: 12-resilience-polish
plan: 02
type: execute
wave: 2
depends_on: ['12-01']
files_modified:
  - apps/web/src/services/websocket.ts
  - apps/web/src/components/DisconnectOverlay.tsx
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/hooks/useWebSocket.ts
autonomous: true

must_haves:
  truths:
    - 'Disconnected player sees auto-reconnect spinner after 2-3 seconds'
    - "Other players see 'Waiting for [player name] to reconnect' overlay"
    - 'Reconnection happens automatically without user action'
    - 'Room code persists in localStorage for easy rejoin'
  artifacts:
    - path: 'apps/web/src/components/DisconnectOverlay.tsx'
      provides: 'Full-screen blocking overlay showing disconnect state'
      min_lines: 50
    - path: 'apps/web/src/services/websocket.ts'
      provides: 'Enhanced reconnection with 2-3s initial delay'
      contains: 'INITIAL_RECONNECT_DELAY.*2000'
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'Pause state management'
      contains: 'isPaused.*boolean'
  key_links:
    - from: 'apps/web/src/hooks/useWebSocket.ts'
      to: 'localStorage.setItem'
      via: 'persist room code and nickname'
      pattern: "localStorage\\.setItem.*roomId"
    - from: 'apps/web/src/components/DisconnectOverlay.tsx'
      to: 'gameStore.isPaused'
      via: 'show overlay when paused'
      pattern: 'isPaused.*true'
---

<objective>
Implement client-side auto-reconnection with localStorage persistence and full-screen disconnect overlay UI.

Purpose: Provide seamless reconnection experience for disconnected players and clear waiting state for other players.

Output: Disconnected players see reconnecting spinner after 2-3 seconds, other players see waiting overlay with disconnected player's name, and room code/nickname persist in localStorage for page refresh scenarios.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-resilience-polish/12-CONTEXT.md
@.planning/phases/12-resilience-polish/12-01-SUMMARY.md
@apps/web/src/services/websocket.ts
@apps/web/src/stores/gameStore.ts
@apps/web/src/hooks/useWebSocket.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance auto-reconnect and add localStorage persistence</name>
  <files>
    apps/web/src/services/websocket.ts
    apps/web/src/hooks/useWebSocket.ts
    apps/web/src/components/Lobby.tsx
  </files>
  <action>
Modify WebSocket client to support 2-3 second initial reconnect delay and persist room state to localStorage.

**In websocket.ts:**
Change INITIAL_RECONNECT_DELAY from 1000ms to 2000ms (2 seconds, per user decision "after 2-3 seconds").

**In useWebSocket.ts or Lobby.tsx:**
Add localStorage persistence when joining/creating room:

```typescript
// On successful room join (room_joined message):
localStorage.setItem('catan_roomId', roomId);
localStorage.setItem('catan_nickname', nickname);

// On component mount:
const savedRoomId = localStorage.getItem('catan_roomId');
const savedNickname = localStorage.getItem('catan_nickname');
// Auto-fill these in join form if present

// On disconnect from room (user leaves):
localStorage.removeItem('catan_roomId');
localStorage.removeItem('catan_nickname');
```

Use keys `catan_roomId` and `catan_nickname` to avoid conflicts with other apps.

Do NOT auto-reconnect on page load — just pre-fill the form. User still clicks "Join Room" button.
</action>
<verify>
Check websocket.ts has INITIAL_RECONNECT_DELAY = 2000
Check localStorage keys are set after joining room
Open browser DevTools > Application > Local Storage and verify keys exist
</verify>
<done>
WebSocket reconnects after 2 seconds on connection loss, room ID and nickname persist in localStorage for page refresh scenarios, and join form auto-fills with saved values.
</done>
</task>

<task type="auto">
  <name>Task 2: Create disconnect overlay UI</name>
  <files>
    apps/web/src/components/DisconnectOverlay.tsx
    apps/web/src/stores/gameStore.ts
    apps/web/src/handlers/index.ts
    apps/web/src/components/Board.tsx
  </files>
  <action>
Create full-screen blocking overlay that displays when game is paused due to disconnect.

**In gameStore.ts:**
Add state fields:

```typescript
isPaused: boolean; // default false
disconnectedPlayerNickname: string | null; // default null

// Actions:
setGamePaused: (paused: boolean, nickname: string | null) => void;
```

**In handlers/index.ts:**
Add handlers for game_paused and game_resumed messages:

```typescript
case 'game_paused':
  useGameStore.getState().setGamePaused(true, message.disconnectedPlayerNickname);
  break;
case 'game_resumed':
  useGameStore.getState().setGamePaused(false, null);
  // Show toast: "[nickname] reconnected" (using Mantine notifications)
  break;
```

**Create DisconnectOverlay.tsx:**

```typescript
export function DisconnectOverlay() {
  const isPaused = useGameStore(s => s.isPaused);
  const disconnectedNickname = useGameStore(s => s.disconnectedPlayerNickname);

  if (!isPaused || !disconnectedNickname) return null;

  return (
    <div style={{
      position: 'fixed',
      top: 0, left: 0, right: 0, bottom: 0,
      backgroundColor: 'rgba(0, 0, 0, 0.85)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 10000,
    }}>
      <div style={{ textAlign: 'center', color: 'white' }}>
        <Loader size="xl" />
        <Title order={2} mt="xl">
          Waiting for {disconnectedNickname} to reconnect...
        </Title>
        <Text size="sm" c="dimmed" mt="md">
          Game will resume when they return
        </Text>
      </div>
    </div>
  );
}
```

**In Board.tsx (or main game component):**
Render DisconnectOverlay at top level (after game UI, before modals):

```typescript
return (
  <>
    {/* existing game UI */}
    <DisconnectOverlay />
    {/* modals */}
  </>
);
```

Show player name only, no timer (per user decision). Use rgba background for dim but not fully black overlay.

For disconnected player themselves, they see the WebSocket client's auto-reconnect in progress (no special UI needed — reconnection is automatic).
</action>
<verify>
Check DisconnectOverlay.tsx renders when isPaused = true
Check gameStore has isPaused and disconnectedPlayerNickname fields
Check handlers handle game_paused and game_resumed messages
Test by manually setting isPaused in React DevTools
</verify>
<done>
Full-screen overlay displays "Waiting for [player name] to reconnect..." when game pauses, overlay blocks all interaction, game_resumed shows toast notification, and disconnected player experiences automatic reconnection with no additional UI.
</done>
</task>

</tasks>

<verification>
Test disconnect flow:
1. Start game with 3 players
2. Simulate disconnect (close browser tab for one player)
3. Other players should see overlay with disconnected player's name
4. Reopen browser, rejoin with same nickname
5. Game should resume automatically, overlay should disappear
6. Check localStorage persists room code across page refresh
</verification>

<success_criteria>

- WebSocket client uses 2-second initial reconnect delay
- Room ID and nickname saved to localStorage on join
- Join form auto-fills from localStorage on mount
- DisconnectOverlay renders when isPaused = true
- Overlay shows disconnected player's nickname
- Overlay blocks all game interaction (z-index: 10000)
- Game_resumed message triggers toast notification
- Reconnection happens automatically without user action
  </success_criteria>

<output>
After completion, create `.planning/phases/12-resilience-polish/12-02-SUMMARY.md`
</output>
