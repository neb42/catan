---
phase: 02-core-game-loop
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/game/Board/HexGrid.tsx
  - apps/web/src/game/Board/HexTile.tsx
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/Lobby.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can click on valid vertex locations to place settlements during initial placement"
    - "User can click on valid edge locations to place roads during initial placement"
    - "Client sends place_settlement and place_road WebSocket messages when user clicks"
    - "Valid placement locations are highlighted when it's user's turn"
  artifacts:
    - path: "apps/web/src/game/Board/HexGrid.tsx"
      provides: "Vertex and edge click handlers"
      min_lines: 150
    - path: "apps/web/src/game/Board/HexTile.tsx"
      provides: "Renders clickable vertices and edges"
      min_lines: 100
    - path: "apps/web/src/stores/gameStore.ts"
      provides: "Selection state for vertices/edges"
      exports: ["selectedVertex", "selectedEdge", "setSelectedVertex", "setSelectedEdge"]
  key_links:
    - from: "apps/web/src/game/Board/HexTile.tsx"
      to: "apps/web/src/stores/gameStore.ts"
      via: "setSelectedVertex/setSelectedEdge on click"
      pattern: "setSelected(Vertex|Edge)"
    - from: "apps/web/src/game/Board/HexGrid.tsx"
      to: "WebSocket place_settlement/place_road"
      via: "sendMessage when vertex/edge selected"
      pattern: "sendMessage.*place_(settlement|road)"
---

<objective>
Wire client-side placement UI to enable initial settlement and road placement during snake draft.

Purpose: Close gap preventing users from completing initial placement flow. Server validation exists, but no client UI sends placement actions.

Output: Interactive board with clickable vertices/edges that send WebSocket placement messages, enabling the 8-round snake draft to complete end-to-end.
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-game-loop/02-CONTEXT.md
@.planning/phases/02-core-game-loop/02-RESEARCH.md

@.planning/phases/02-core-game-loop/02-02-SUMMARY.md
@.planning/phases/02-core-game-loop/02-03-SUMMARY.md

@apps/web/src/game/Board/HexGrid.tsx
@apps/web/src/game/Board/HexTile.tsx
@apps/web/src/stores/gameStore.ts
@apps/web/src/components/Lobby.tsx
@apps/api/src/game/PlacementValidator.ts
@apps/api/src/game/geometry.ts
@libs/shared/src/schemas/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vertex click handlers to HexTile</name>
  <files>apps/web/src/game/Board/HexTile.tsx</files>
  <action>
Each hex has 6 vertices at corners. Render small circles (radius 8-10px) at each vertex position. Use apps/api/src/game/geometry.ts vertex key format: `${q}:${r}:${v}` where v is 0-5 (corner index).

When phase is `initial_placement` and it's the current player's turn and awaiting settlement placement:
- Highlight valid vertex positions (use PlacementValidator logic client-side or show all vertices and let server reject)
- On vertex click, call gameStore.setSelectedVertex(vertexId) and highlight selected vertex
- Only show/enable vertices when placement is expected (not during "pending road" state)

Use existing player color from gameStore for highlighting. Add hover effects for better UX.

Reference existing Settlement.tsx for vertex position math.
  </action>
  <verify>Inspect HexTile.tsx - vertex circles render at corners with click handlers calling setSelectedVertex</verify>
  <done>Vertices are clickable during initial placement, selection state stored in gameStore</done>
</task>

<task type="auto">
  <name>Task 2: Add edge click handlers to HexTile</name>
  <files>apps/web/src/game/Board/HexTile.tsx</files>
  <action>
Each hex has 6 edges. Render thin lines (stroke-width 6-8px for clickability) along each edge. Use apps/api/src/game/geometry.ts edge key format: `${q1}:${r1}-${q2}:${r2}` where (q1,r1) and (q2,r2) are adjacent hex coords.

When phase is `initial_placement` and it's current player's turn and awaiting road placement (pendingRoad state):
- Highlight valid edge positions
- On edge click, call gameStore.setSelectedEdge(edgeId) and highlight selected edge
- Only show/enable edges when road placement is expected

Use existing player color from gameStore for highlighting. Reference existing Road.tsx for edge position math.
  </action>
  <verify>Inspect HexTile.tsx - edge lines render with click handlers calling setSelectedEdge</verify>
  <done>Edges are clickable during road placement, selection state stored in gameStore</done>
</task>

<task type="auto">
  <name>Task 3: Wire placement actions in HexGrid</name>
  <files>apps/web/src/game/Board/HexGrid.tsx, apps/web/src/stores/gameStore.ts</files>
  <action>
In HexGrid.tsx, watch for gameStore.selectedVertex and gameStore.selectedEdge changes using Zustand subscription or useEffect.

When selectedVertex changes and is non-null:
- Call gameStore.sendMessage({ type: 'place_settlement', vertexId: selectedVertex })
- Clear selectedVertex after sending
- Show brief confirmation feedback ("Placing settlement...")

When selectedEdge changes and is non-null:
- Call gameStore.sendMessage({ type: 'place_road', edgeId: selectedEdge })
- Clear selectedEdge after sending
- Show brief confirmation feedback ("Placing road...")

Server responds with updated game_state. If placement is invalid, server sends error - handle gracefully with toast/message.

In gameStore.ts, add setSelectedVertex and setSelectedEdge actions if not already present (verification report indicates they exist but aren't used).
  </action>
  <verify>Test: Click vertex → WebSocket message sent, click edge → WebSocket message sent. Check browser DevTools network tab for WebSocket frames</verify>
  <done>Clicking vertices/edges sends place_settlement/place_road messages to server, enabling initial placement flow</done>
</task>

</tasks>

<verification>
Run development servers and start a game with 3-4 players. Verify:

1. **Vertex highlighting:** When initial placement begins, vertices show as clickable circles
2. **Settlement placement:** Click vertex → settlement appears, game_state updates
3. **Edge highlighting:** After settlement placed, edges become clickable
4. **Road placement:** Click edge → road appears, turn advances to next player
5. **Snake draft:** 8 rounds complete (1→4, 4→1) with all players placing settlements+roads
6. **Starting resources:** After second settlement, resources appear in player's hand

Check WebSocket messages in DevTools confirm `place_settlement` and `place_road` are sent.
</verification>

<success_criteria>
- User can complete initial placement end-to-end in snake draft order
- Vertices are clickable during settlement placement phase
- Edges are clickable during road placement phase
- WebSocket messages sent for both placement actions
- Server validation works (invalid placements show errors)
- BOARD-04 requirement satisfied: Initial placement works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-game-loop/02-06-SUMMARY.md`
</output>
