---
phase: 02-core-game-loop
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/game/Board/HexGrid.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Settlements render at correct hex vertex positions on the board"
    - "Roads render along correct hex edge positions on the board"
    - "Initial placement is visually playable end-to-end"
  artifacts:
    - path: "apps/web/src/game/Board/HexGrid.tsx"
      provides: "Layout configured with flat={true} to match geometry.ts formulas"
      min_lines: 204
      contains: "flat={true}"
  key_links:
    - from: "apps/web/src/game/Board/HexGrid.tsx"
      to: "apps/web/src/game/Board/geometry.ts"
      via: "Layout orientation matches axialToPixel formulas"
      pattern: "flat=\\{true\\}"
---

<objective>
Fix coordinate system mismatch causing settlements and roads to render off-board.

Purpose: Unblock initial placement flow by aligning react-hexgrid Layout orientation with geometry.ts coordinate calculations.
Output: Settlements and roads render at correct hex vertices/edges after one-line configuration change.
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-game-loop/02-RESEARCH.md
@.planning/phases/02-core-game-loop/02-VERIFICATION.md
@.planning/debug/settlement-road-coordinates-wrong.md

# Existing implementation
@apps/web/src/game/Board/HexGrid.tsx
@apps/web/src/game/Board/geometry.ts
@apps/web/src/game/Board/Settlement.tsx
@apps/web/src/game/Board/Road.tsx
</context>

<tasks>

<task type="auto">
  <name>Fix hex orientation mismatch in HexGrid Layout</name>
  <files>apps/web/src/game/Board/HexGrid.tsx</files>
  <action>
Change react-hexgrid Layout from pointy-top to flat-top orientation to match geometry.ts calculations.

Current state (line 134):
```tsx
<Layout size={{ x: 10, y: 10 }} flat={false} spacing={1.05}>
```

Change to:
```tsx
<Layout size={{ x: 10, y: 10 }} flat={true} spacing={1.05}>
```

Why: 
- geometry.ts uses flat-top formulas (axialToPixel, getHexCornerPositions) with -30° angle offset
- react-hexgrid flat={false} means pointy-top hexagons (vertex at top)
- react-hexgrid flat={true} means flat-top hexagons (edge at top)
- Mismatch causes all Settlement.tsx and Road.tsx positions to render incorrectly

This single-line change aligns the Layout orientation with the coordinate system used throughout the codebase.

Do NOT modify:
- geometry.ts formulas (they're correct for flat-top)
- Settlement.tsx or Road.tsx components (they use geometry correctly)
- Any hex size or spacing values
  </action>
  <verify>
1. Start game and create room
2. Place settlements and roads during initial placement
3. Run: `git diff apps/web/src/game/Board/HexGrid.tsx` should show flat={false} changed to flat={true}
4. Visual verification: Settlements appear at hex vertices (corners), roads appear along hex edges
  </verify>
  <done>
- HexGrid.tsx line 134 changed from flat={false} to flat={true}
- Settlements render at correct vertex positions on board
- Roads render along correct edge positions on board
- Initial placement is visually correct
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Coordinate orientation fix enabling correct settlement and road rendering</what-built>
  <how-to-verify>
1. Start both servers:
   ```bash
   npx nx serve api  # Terminal 1
   npx nx serve web  # Terminal 2
   ```

2. Open http://localhost:5173 in browser

3. Create game room and start with 2+ players

4. Complete initial placement round:
   - Player 1: Click hex vertex → settlement appears at clicked vertex
   - Player 1: Click hex edge adjacent to settlement → road appears along clicked edge
   - Player 2: Repeat placement
   - Verify all pieces render ON the board at correct positions

5. Expected behavior:
   - Settlements appear as circles at hex corners (vertices)
   - Roads appear as rectangles along hex edges
   - All pieces visible within board boundaries
   - Clicking vertices/edges places pieces at clicked locations

6. If settlements still render off-board or at wrong positions, report exact visual behavior
  </how-to-verify>
  <resume-signal>Type "approved" if placements render correctly, or describe what's still wrong</resume-signal>
</task>

</tasks>

<verification>
After task completion:

1. Code verification:
   ```bash
   grep -n "flat=" apps/web/src/game/Board/HexGrid.tsx
   # Should show: flat={true}
   ```

2. Build verification:
   ```bash
   npx nx build web
   # Should compile without errors
   ```

3. Human verification (checkpoint):
   - Settlements render at hex vertices
   - Roads render along hex edges
   - Initial placement flow visually correct
</verification>

<success_criteria>
- [ ] HexGrid Layout uses flat={true} matching geometry.ts orientation
- [ ] Code change committed with atomic feat commit
- [ ] No TypeScript or build errors
- [ ] Human verification confirms settlements/roads render correctly
- [ ] Gap #2 from VERIFICATION.md resolved
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-game-loop/02-08-SUMMARY.md` documenting:
- Orientation fix from flat={false} to flat={true}
- Settlement and road rendering now visually correct
- Initial placement flow unblocked
</output>
