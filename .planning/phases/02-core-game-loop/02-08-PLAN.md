---
phase: 02-core-game-loop
plan: 08
type: gaps
wave: 8
depends_on: [09]
files_modified:
  - apps/web/src/game/Board/Port.tsx
  - apps/web/src/game/Board/HexGrid.tsx
autonomous: true

must_haves:
  truths:
    - "Ports render visually on coastal edges"
    - "9 ports appear with correct types (3:1 generic, 2:1 resource-specific)"
    - "Port positions use q,r:direction format from game state"
    - "Port visuals distinguish between 3:1 and 2:1 types"
  artifacts:
    - path: "apps/web/src/game/Board/Port.tsx"
      provides: "Port rendering component"
      exports: ["Port"]
      min_lines: 40
    - path: "apps/web/src/game/Board/HexGrid.tsx"
      provides: "Port rendering integration"
      exports: ["HexGrid"]
      contains: ["gameState.board.ports.map", "<Port"]
  key_links:
    - from: "apps/web/src/game/Board/HexGrid.tsx"
      to: "apps/web/src/game/Board/Port.tsx"
      via: "imports and renders Port component"
      pattern: "import.*Port.*from.*./Port"
    - from: "apps/web/src/game/Board/Port.tsx"
      to: "apps/web/src/game/Board/geometry.ts"
      via: "uses axialToPixel for positioning"
      pattern: "import.*axialToPixel.*from.*./geometry"
---

<objective>
Add port rendering to complete board visualization. Ports are generated server-side and transmitted in game state but never rendered by UI. Create Port component to display 3:1 and 2:1 port types on coastal edges, integrate into HexGrid.

Purpose: Fix UAT Issue #1 (Major) - ports missing from board, enable port trading mechanics visualization.

Output: Port.tsx component + HexGrid integration = 9 visible ports on board
</objective>

<execution_context>
@.planning/debug/ports-missing-from-board.md
@apps/web/src/game/Board/HexGrid.tsx
@apps/web/src/game/Board/Settlement.tsx (reference for positioning pattern)
@apps/web/src/game/Board/geometry.ts
@libs/shared/src/schemas/game.ts (PortSchema)
</execution_context>

<context>
**Root Cause:** Ports are successfully generated server-side (BoardGenerator.ts:115-134), included in game state schema (BoardSchema), and transmitted via WebSocket. However, HexGrid.tsx (lines 1-204) has NO rendering logic for ports. It only renders hexes, roads, and settlements.

**Port Data Structure:**
- Type: `{ type: '3:1' | '2:1'; resourceType?: ResourceType; position: string }`
- Position format: `"q,r:directionIndex"` where q,r = hex axial coords, directionIndex = 0-5
- Example: `{ type: '2:1', resourceType: 'wood', position: '3,-1:4' }`

**Existing Components:**
- Settlement.tsx and Road.tsx provide patterns for piece rendering
- geometry.ts has axialToPixel() for coordinate conversion
- HexGrid already renders hexes (143-156), roads (158-162), settlements (164-177)

**Design Requirements:**
- Port must render on coastal edge at specific direction (0-5) from hex center
- Visual distinction between 3:1 (generic) and 2:1 (resource-specific)
- Port visuals should use resource colors for 2:1 types
- Keep consistent with existing piece styling (stroke width, colors)
</context>

<plan>
## Task 1: Create Port Component
**Files:** apps/web/src/game/Board/Port.tsx (new)

**Goal:** Render individual port visual on specific hex edge

**Implementation:**
1. Import types: `Port as PortType` from @catan/shared, geometry utils
2. Parse position string: `"q,r:directionIndex"` → {q, r, direction}
3. Calculate hex center using axialToPixel(q, r)
4. Calculate edge position: center + offset in direction (60° increments)
   - Direction 0: 0° (east), 1: 60°, 2: 120°, 3: 180° (west), 4: 240°, 5: 300°
   - Edge offset = size * 1.5 in direction angle
5. Render port visual at edge position:
   - For 3:1: white/gray icon (3:1 symbol)
   - For 2:1: resource-colored icon with resource symbol
6. Use SVG group with text or shape to show port type

**Pattern Reference:** Settlement.tsx shows how to use getVertexPosition and render SVG

**Output:** Port component that renders at correct coastal edge with type distinction

---

## Task 2: Integrate Port Rendering into HexGrid
**Files:** apps/web/src/game/Board/HexGrid.tsx

**Goal:** Render all 9 ports from game state

**Implementation:**
1. Import Port component
2. Add port rendering section after settlement rendering (after line 177)
3. Map over gameState.board.ports array
4. Render Port component for each port with key={`port-${port.position}`}
5. Pass port prop to Port component

**Code Location:** Insert between settlement rendering and closing Layout tag

**Pattern:** Follow existing road/settlement rendering pattern (lines 158-177)

**Output:** HexGrid renders 9 ports alongside hexes, roads, and settlements

---

## Task 3: Test Port Visibility
**Files:** Manual testing

**Verification:**
1. Start game with 4 players
2. Observe board - should see 9 ports on coastal edges
3. Verify 3:1 and 2:1 ports visually distinct
4. Check all 9 ports positioned correctly on coast

**Expected:** All 9 ports visible, distinguishable by type

**Output:** UAT Test 1 passes
</plan>

<constraints>
- Use existing geometry.ts functions, don't create new coordinate math
- Follow Settlement/Road component patterns for consistency
- Port visuals should not overlap with settlements or roads
- Must handle all 6 direction indices (0-5) correctly
</constraints>

<checkpoints>
**After Task 1:**
- [ ] Port.tsx component created with proper type imports
- [ ] Port component parses position string correctly
- [ ] Port component calculates edge position using geometry.ts
- [ ] Port renders SVG visual with type distinction

**After Task 2:**
- [ ] HexGrid imports and renders Port component
- [ ] Ports array mapped and rendered with keys
- [ ] No TypeScript errors in HexGrid.tsx

**After Task 3:**
- [ ] `npm run build` succeeds for web
- [ ] Game loads without console errors
- [ ] 9 ports visible on board in browser
- [ ] UAT Test 1 status updated to ✅ Passed
</checkpoints>

<success_criteria>
**Functionality:**
- [x] Ports generated server-side (already working)
- [x] Ports included in game state (already working)
- [ ] Ports render visually on board
- [ ] 3:1 and 2:1 ports visually distinct
- [ ] All 9 ports positioned on coastal edges

**Code Quality:**
- [ ] Port component follows Settlement/Road patterns
- [ ] Proper TypeScript types used
- [ ] No coordinate math duplicated from geometry.ts
- [ ] SVG rendering consistent with existing pieces

**Testing:**
- [ ] UAT Test 1 passes (ports visible)
- [ ] No console errors when game loads
- [ ] Ports don't overlap other pieces
</success_criteria>

<risks>
- **Low:** Port position calculation might need tweaking for visual alignment
  - Mitigation: Reference Settlement.tsx vertex calculations as guide
- **Low:** Port icons might be too large/small for edge placement
  - Mitigation: Use size proportional to existing piece sizes
</risks>

---
*This is a gaps-only fix plan to resolve UAT Issue #1*
