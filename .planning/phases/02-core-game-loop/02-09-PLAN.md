---
phase: 02-core-game-loop
plan: 09
type: gaps
wave: 8
depends_on: []
files_modified:
  - apps/web/src/game/Board/HexGrid.tsx
autonomous: true

must_haves:
  truths:
    - "Settlements render at correct hex vertex positions"
    - "Roads render along correct hex edge positions"
    - "All placed pieces visible on board (not off-map)"
    - "Hex orientation matches between react-hexgrid Layout and geometry calculations"
  artifacts:
    - path: "apps/web/src/game/Board/HexGrid.tsx"
      provides: "Fixed hex orientation in Layout component"
      contains: ["flat={true}"]
  key_links: []
---

<objective>
Fix critical coordinate mismatch causing settlements and roads to render off-board. Change react-hexgrid Layout from pointy-top (flat={false}) to flat-top (flat={true}) to match geometry.ts calculations.

Purpose: Fix UAT Issue #2 (Critical) - placement coordinates wrong, unblocking all remaining tests and making game playable.

Output: One-line change in HexGrid.tsx fixes all settlement/road positioning
</objective>

<execution_context>
@.planning/debug/settlement-road-coordinates-wrong.md
@apps/web/src/game/Board/HexGrid.tsx
@apps/web/src/game/Board/geometry.ts
@apps/web/src/game/Board/Settlement.tsx
@apps/web/src/game/Board/Road.tsx
</execution_context>

<context>
**Root Cause:** Hex orientation mismatch between react-hexgrid Layout and custom geometry calculations.

**Current State:**
- HexGrid.tsx line 134: `<Layout size={{ x: 10, y: 10 }} flat={false} spacing={1.05}>`
- `flat={false}` = pointy-top hexagons (vertex at top)
- geometry.ts axialToPixel and getHexCornerPositions use flat-top formulas
- Formulas use -30° angle offset characteristic of flat-top orientation
- Settlement/Road components call geometry functions for vertex/edge positions

**Impact:**
- All settlements render off-board (wrong coordinate space)
- All roads render off-board and not adjacent to settlements
- Game completely unplayable
- Blocks 12 of 15 UAT tests

**Solution:**
- Change `flat={false}` to `flat={true}` in Layout component
- Aligns react-hexgrid rendering with geometry.ts calculations
- One line change fixes all placement coordinates

**Why This Works:**
- react-hexgrid Layout with `flat={true}` uses flat-top hex math
- geometry.ts already uses flat-top formulas (sqrt(3), -30° offset)
- Matching orientations = correct coordinate transformations
- Settlement.tsx and Road.tsx use geometry.ts → automatically fixed

**Alternative Rejected:**
- Could rewrite geometry.ts formulas for pointy-top (60° increments from 0°)
- More complex, affects multiple files, higher risk
- Layout change is simpler and safer
</context>

<plan>
## Task 1: Fix Hex Orientation in HexGrid
**Files:** apps/web/src/game/Board/HexGrid.tsx

**Goal:** Align react-hexgrid Layout with geometry.ts coordinate system

**Implementation:**
1. Open HexGrid.tsx
2. Find Layout component (line ~134)
3. Change `flat={false}` to `flat={true}`
4. No other changes needed

**Exact Change:**
```tsx
// OLD (line 134):
<Layout size={{ x: 10, y: 10 }} flat={false} spacing={1.05}>

// NEW:
<Layout size={{ x: 10, y: 10 }} flat={true} spacing={1.05}>
```

**Output:** Layout uses flat-top hexagons matching geometry.ts

---

## Task 2: Test Placement Coordinates
**Files:** Manual testing

**Verification:**
1. Start game with 4 players
2. Progress through initial placement (8 rounds)
3. Observe settlements render at hex vertices ON the board
4. Observe roads render along hex edges ADJACENT to settlements
5. Verify all pieces visible and positioned correctly

**Expected:** 
- Settlements appear at hex corners (vertices)
- Roads appear along hex edges
- All pieces on the visible board
- No pieces off-map

**Output:** UAT Test 2 passes, Tests 3-15 unblocked

---

## Task 3: Verify No Side Effects
**Files:** apps/web/src/game/Board/HexTile.tsx

**Verification:**
1. Check hex tiles still render correctly
2. Verify hex grid layout looks normal
3. Confirm number tokens positioned correctly on hexes
4. Ensure no visual regression on hex rendering

**Expected:** Hex rendering unchanged (only affects vertex/edge positions)

**Output:** UAT Test 6 remains passing
</plan>

<constraints>
- Only change flat prop - do not modify size or spacing
- Do not change geometry.ts formulas
- Do not modify Settlement.tsx or Road.tsx
- This is a single-line fix
</constraints>

<checkpoints>
**After Task 1:**
- [ ] HexGrid.tsx Layout has flat={true}
- [ ] No other changes to HexGrid.tsx
- [ ] No TypeScript errors

**After Task 2:**
- [ ] `npm run build` succeeds for web
- [ ] Game loads without errors
- [ ] Settlements visible at hex vertices
- [ ] Roads visible along hex edges
- [ ] All pieces on-board (not off-map)
- [ ] UAT Test 2 status updated to ✅ Passed

**After Task 3:**
- [ ] Hex tiles render correctly (no regression)
- [ ] Number tokens positioned correctly
- [ ] UAT Test 6 still passes
</checkpoints>

<success_criteria>
**Functionality:**
- [ ] Settlements render at correct vertex positions
- [ ] Roads render at correct edge positions
- [ ] All pieces visible on board
- [ ] Initial placement playable (8 rounds completable)

**Code Quality:**
- [ ] Minimal change (one line)
- [ ] No side effects on hex rendering
- [ ] No TypeScript errors
- [ ] No console warnings

**Testing:**
- [ ] UAT Test 2 passes (initial placement coordinates correct)
- [ ] UAT Tests 3-15 unblocked
- [ ] UAT Test 6 still passes (hex rendering)
- [ ] Manual test: complete initial placement → first turn works
</success_criteria>

<risks>
- **Very Low:** Hex tiles might shift visually when orientation changes
  - Mitigation: Hex coordinates are absolute (q,r) - only vertex/edge positions affected
  - Impact: If occurs, adjust Layout spacing slightly
- **None:** geometry.ts formulas are correct for flat-top, well-tested
</risks>

---
*This is a gaps-only fix plan to resolve UAT Issue #2 - highest priority due to Critical severity*
