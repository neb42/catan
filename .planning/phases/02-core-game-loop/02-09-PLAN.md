---
phase: 02-core-game-loop
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/game/Board/Port.tsx
  - apps/web/src/game/Board/HexGrid.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "9 ports render visually on coastal edges of the board"
    - "Ports display correct trade ratio (2:1 or 3:1)"
    - "Ports show resource type for 2:1 specialist ports"
  artifacts:
    - path: "apps/web/src/game/Board/Port.tsx"
      provides: "Port SVG component rendering trade ratio and resource type"
      min_lines: 50
      exports: ["Port"]
    - path: "apps/web/src/game/Board/HexGrid.tsx"
      provides: "Port rendering loop iterating over gameState.board.ports"
      contains: "gameState.board.ports.map"
  key_links:
    - from: "apps/web/src/game/Board/HexGrid.tsx"
      to: "apps/web/src/game/Board/Port.tsx"
      via: "Port component import and render"
      pattern: "import.*Port.*from.*\\.\\./Port"
---

<objective>
Add port rendering to complete board visualization.

Purpose: Display 9 ports on coastal edges so players can see available trade ratios (3:1 generic, 2:1 resource-specific).
Output: Port.tsx component rendering ports with correct positioning, ratios, and resource types.
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-game-loop/02-RESEARCH.md
@.planning/phases/02-core-game-loop/02-VERIFICATION.md
@.planning/debug/ports-missing-from-board.md

# Existing implementation
@apps/web/src/game/Board/HexGrid.tsx
@apps/web/src/game/Board/HexTile.tsx
@apps/api/src/game/BoardGenerator.ts

# Port schema
@libs/shared/src/schemas/game.ts
</context>

<tasks>

<task type="auto">
  <name>Create Port component for SVG rendering</name>
  <files>apps/web/src/game/Board/Port.tsx</files>
  <action>
Create Port.tsx component to render port visuals on coastal edges.

Port data structure (from libs/shared/src/schemas/game.ts):
```typescript
type Port = {
  position: string;  // Format: "q,r:directionIndex" e.g. "2,1:3"
  type: "3:1" | "2:1";
  resource?: "wood" | "brick" | "sheep" | "wheat" | "ore";  // Only for 2:1 ports
};
```

Implementation requirements:
1. Parse position string to extract hex coord (q,r) and edge direction (0-5)
2. Calculate edge center position using geometry.ts functions
3. Render SVG group with:
   - Small rectangle or circle as port marker
   - Text showing ratio ("3:1" or "2:1")
   - For 2:1 ports: show resource type or icon
4. Position at edge center of specified hex

Use existing patterns from Settlement.tsx and Road.tsx for:
- Parsing position strings
- Using getHexCornerPositions to find edge vertices
- SVG rendering within react-hexgrid coordinate system

Color coding suggestion:
- 3:1 ports: neutral gray/white
- 2:1 ports: match resource colors (wood=green, brick=red, sheep=light green, wheat=yellow, ore=gray)

Size: Small enough not to obstruct hexes (~3-4 units), positioned slightly outside hex boundary.

Reference BoardGenerator.ts lines 115-134 for how ports are generated and positioned.
  </action>
  <verify>
1. Run TypeScript check: `npx nx build web --skip-nx-cache`
2. Port.tsx should export Port component with props: { position: string; type: "3:1" | "2:1"; resource?: string }
3. Component should parse position and render SVG at correct edge location
  </verify>
  <done>
- Port.tsx created in apps/web/src/game/Board/
- Component parses position format "q,r:directionIndex"
- SVG rendering positions port at hex edge center
- Displays trade ratio and resource type
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Integrate port rendering into HexGrid</name>
  <files>apps/web/src/game/Board/HexGrid.tsx</files>
  <action>
Add port rendering to HexGrid component alongside existing hex, road, and settlement rendering.

Current structure (around lines 158-177):
```tsx
{gameState.players.flatMap((player) =>
  player.roads.map((edgeId) => (
    <Road key={`${player.id}-${edgeId}`} edgeId={edgeId} color={player.color} />
  ))
)}

{gameState.players.flatMap((player) =>
  player.settlements.map((vertexId) => (
    <Settlement ... />
  ))
)}

{gameState.players.flatMap((player) =>
  player.cities.map((vertexId) => (
    <Settlement ... isCity />
  ))
)}
```

Add port rendering BEFORE roads (so roads render on top of ports):
```tsx
{gameState.board.ports.map((port, index) => (
  <Port
    key={`port-${index}`}
    position={port.position}
    type={port.type}
    resource={port.resource}
  />
))}

{gameState.players.flatMap((player) =>
  player.roads.map...
```

Import Port at top:
```tsx
import { Port } from './Port';
```

Why before roads: Ports are board features (like hexes), roads are player pieces. Layering order: hexes → ports → roads → settlements.
  </action>
  <verify>
1. grep "Port" apps/web/src/game/Board/HexGrid.tsx should show import and usage
2. Run: `npx nx build web --skip-nx-cache`
3. No TypeScript errors
4. Port component rendered for all 9 ports in gameState.board.ports
  </verify>
  <done>
- Port component imported in HexGrid.tsx
- Port rendering loop added inside Layout component
- Ports rendered before roads (correct z-order)
- TypeScript compiles without errors
- All 9 ports from gameState.board.ports are rendered
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Port rendering on board with trade ratios and resource types</what-built>
  <how-to-verify>
1. Start both servers:
   ```bash
   npx nx serve api  # Terminal 1
   npx nx serve web  # Terminal 2
   ```

2. Open http://localhost:5173 in browser

3. Create game room and observe board

4. Verify port rendering:
   - Count 9 ports total around coastal edges
   - Each port shows trade ratio: "3:1" or "2:1"
   - 4 ports show "3:1" (generic trade)
   - 5 ports show "2:1" with resource type (wood, brick, sheep, wheat, ore - one of each)
   - Ports positioned at hex edges on coast (not overlapping hexes or number tokens)

5. Expected visual:
   - Ports are small markers on coastal edges
   - Trade ratios clearly visible
   - Resource types distinguishable (by color or text)
   - Ports don't obscure important board elements

6. If ports don't appear, check browser console for errors
7. If ports render in wrong positions, note which edges have issues
  </how-to-verify>
  <resume-signal>Type "approved" if all 9 ports render correctly, or describe visual issues</resume-signal>
</task>

</tasks>

<verification>
After task completion:

1. Code verification:
   ```bash
   # Verify Port component exists
   ls apps/web/src/game/Board/Port.tsx
   
   # Verify Port import in HexGrid
   grep "import.*Port" apps/web/src/game/Board/HexGrid.tsx
   
   # Verify port rendering loop
   grep "board.ports.map" apps/web/src/game/Board/HexGrid.tsx
   ```

2. Build verification:
   ```bash
   npx nx build web --skip-nx-cache
   # Should compile without errors
   ```

3. Human verification (checkpoint):
   - All 9 ports visible on board
   - Trade ratios (3:1, 2:1) displayed
   - Resource types shown for 2:1 ports
   - Positioning correct at coastal edges
</verification>

<success_criteria>
- [ ] Port.tsx component created with SVG rendering
- [ ] Port parsing handles "q,r:directionIndex" position format
- [ ] HexGrid renders all ports from gameState.board.ports
- [ ] Atomic feat commits for each task
- [ ] No TypeScript or build errors
- [ ] Human verification confirms 9 ports render correctly
- [ ] Gap #1 from VERIFICATION.md resolved
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-game-loop/02-09-SUMMARY.md` documenting:
- Port.tsx component implementation
- Position parsing and SVG rendering approach
- Integration into HexGrid rendering pipeline
- Visual design choices (colors, sizes, layout)
</output>
