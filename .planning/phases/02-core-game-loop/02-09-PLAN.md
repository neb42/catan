---
phase: 02-core-game-loop
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/game/Board/HexGrid.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Settlements appear at correct vertex positions matching hex corners"
    - "Roads appear at correct edge positions matching hex edges"
    - "Placement coordinates match visual hex layout"
  artifacts:
    - path: "apps/web/src/game/Board/HexGrid.tsx"
      provides: "HexGrid with flat-top orientation"
      contains: "flat={true}"
  key_links:
    - from: "apps/web/src/game/Board/HexGrid.tsx"
      to: "apps/web/src/game/Board/geometry.ts"
      via: "Layout orientation matching geometry calculations"
      pattern: "Layout.*flat.*geometry"
---

<objective>
Fix UAT Issue #2: Correct hex orientation mismatch causing incorrect settlement and road placement coordinates.

Purpose: HexGrid uses react-hexgrid's Layout with `flat={false}` (pointy-top), but custom geometry calculations in geometry.ts use flat-top formulas with -30¬∞ angle offset. This mismatch causes settlements and roads to render in wrong positions, making the game unplayable.

Output: Corrected hex orientation that aligns Layout with geometry calculations, resulting in accurate settlement and road placement.
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-game-loop/02-UAT.md
@.planning/phases/02-core-game-loop/02-03-SUMMARY.md
@apps/web/src/game/Board/HexGrid.tsx
@apps/web/src/game/Board/geometry.ts
@apps/web/src/game/Board/Settlement.tsx
@apps/web/src/game/Board/Road.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Hex Orientation in HexGrid</name>
  <files>apps/web/src/game/Board/HexGrid.tsx</files>
  <action>
Change the react-hexgrid Layout from pointy-top to flat-top orientation.

**Specific change:**
- Line 137: Change `flat={false}` to `flat={true}` in the Layout component

**Current code (line 137):**
```tsx
<Layout size={{ x: 10, y: 10 }} flat={false} spacing={1.05}>
```

**New code:**
```tsx
<Layout size={{ x: 10, y: 10 }} flat={true} spacing={1.05}>
```

**Why this fixes the issue:**
- react-hexgrid's `flat={false}` means pointy-top hexes (vertices at top/bottom)
- react-hexgrid's `flat={true}` means flat-top hexes (edges at top/bottom)
- geometry.ts uses flat-top coordinate conversion formulas (confirmed by -30¬∞ angle offset in calculations)
- Settlement.tsx and Road.tsx rely on geometry.ts for pixel coordinate calculations
- Mismatch between Layout orientation and geometry calculations causes wrong positions
- Aligning both to flat-top fixes coordinate system

**Do not:**
- Change geometry.ts calculations (already correct for flat-top)
- Change Settlement.tsx or Road.tsx (they correctly use geometry functions)
- Modify hex rendering logic (hexes render fine, only Layout orientation needs change)
  </action>
  <verify>
1. Run `npx nx build web` - should compile without errors
2. Run `npx nx serve web` and open game in browser
3. Start a new game with 4 players
4. Place initial settlements - verify they appear at hex corners, not off-map
5. Place initial roads - verify they appear on hex edges connecting to settlements
6. Complete one full snake draft round (P1‚ÜíP2‚ÜíP3‚ÜíP4) to test multiple placements
  </verify>
  <done>Settlements and roads render at correct vertex/edge positions matching visual hex layout, initial placement is playable</done>
</task>

<task type="auto">
  <name>Task 2: Verify Placement Validation Works</name>
  <files>apps/web/src/game/Board/HexGrid.tsx</files>
  <action>
Test that placement validation logic works with corrected coordinates.

**Testing steps (automated via serving the app):**
1. Verify settlement distance rule: Attempt to place settlement adjacent to existing settlement - should fail with error message
2. Verify road connection rule: During initial placement, attempt to place road not connected to just-placed settlement - should fail
3. Verify valid placements succeed: Place settlements at valid vertices (2+ edges away) and roads on valid edges
4. Check that error messages from server validation display correctly in UI

**No code changes needed** - just verify existing validation logic works now that coordinates are correct.

**If validation fails:**
- Check that vertex IDs from clicks match server expectations (format: "q,r-direction")
- Check that edge IDs from clicks match server expectations (format: "q1,r1-q2,r2")
- Verify normalizeEdgeId function still works (line 7-12 of HexGrid.tsx)
  </action>
  <verify>
1. In running game, place first settlement for P1
2. Attempt to place P1's road on an edge NOT connected to settlement - should show error
3. Place P1's road on valid edge connected to settlement - should succeed
4. When P2's turn, attempt to place settlement 1 edge away from P1's settlement - should show error
5. Place P2's settlement 2+ edges away - should succeed
6. Verify error messages appear in UI when placement fails
  </verify>
  <done>Placement validation enforces distance and connection rules correctly, error messages display for invalid placements, valid placements succeed</done>
</task>

</tasks>

<verification>
**Manual Testing:**
1. Start game with 4 players
2. Test P1 initial placement: settlement at valid vertex, road on connected edge
3. Test P2 initial placement: settlement respects distance rule (2+ edges away)
4. Complete full snake draft: P1‚ÜíP2‚ÜíP3‚ÜíP4‚ÜíP4‚ÜíP3‚ÜíP2‚ÜíP1
5. Verify all 8 settlements and 8 roads render at correct positions
6. Attempt invalid placements to verify validation errors appear

**Expected Results:**
- UAT Test 2 "Initial Placement - Snake Draft Order" changes from ‚ùå Failed to ‚úÖ Passed
- UAT Tests 3-15 change from üö´ Blocked to testable
- All settlements appear at hex corners
- All roads appear on hex edges connecting to settlements
- No pieces render off-map
</verification>

<success_criteria>
- [ ] HexGrid.tsx line 137 changed to `flat={true}`
- [ ] Build succeeds with no errors
- [ ] Settlements render at correct hex vertex positions
- [ ] Roads render at correct hex edge positions
- [ ] Initial placement snake draft playable (all 8 rounds)
- [ ] Placement validation enforces distance and connection rules
- [ ] Error messages display for invalid placements
- [ ] Game proceeds to first regular turn after initial placement completes
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-game-loop/02-09-SUMMARY.md`
</output>
