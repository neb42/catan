---
phase: 02-core-game-loop
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/game/TurnManager.ts
  - apps/api/src/managers/GameManager.ts
  - apps/web/src/game/UI/DiceRoller.tsx
  - apps/web/src/game/UI/TurnIndicator.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Turn phase transitions from roll → main → end before advancing to next player"
    - "UI displays 'end' phase clearly to current player"
    - "End turn button only appears during 'main' or 'end' phases"
    - "Players can see the three-phase turn structure flow"
  artifacts:
    - path: "apps/api/src/game/TurnManager.ts"
      provides: "advanceTurn sets turnPhase to 'end' before next player"
      contains: "turnPhase.*end"
    - path: "apps/api/src/managers/GameManager.ts"
      provides: "endTurn transitions to 'end' phase"
      contains: "this.state.turnPhase.*end"
    - path: "apps/web/src/game/UI/DiceRoller.tsx"
      provides: "Shows end phase UI controls"
      contains: "end.*phase"
    - path: "apps/web/src/game/UI/TurnIndicator.tsx"
      provides: "Displays 'End Phase' text"
      contains: "End.*Phase"
  key_links:
    - from: "apps/api/src/managers/GameManager.ts"
      to: "apps/api/src/game/TurnManager.ts"
      via: "endTurn → advanceTurn with end phase"
      pattern: "endTurn|advanceTurn"
    - from: "apps/web/src/game/UI/TurnIndicator.tsx"
      to: "gameStore.gameState.turnPhase"
      via: "Reads and displays turnPhase"
      pattern: "turnPhase.*end"
---

<objective>
Implement explicit 'end' turn phase to complete roll → main → end turn structure.

Purpose: Close gap where turn phase skips directly from 'main' to next player's 'roll' without explicit 'end' phase. TURN-03 requirement specifies three-phase flow must be observable.

Output: Turn system transitions through roll → main → end phases with UI feedback, satisfying the complete turn structure requirement.
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-game-loop/02-CONTEXT.md

@.planning/phases/02-core-game-loop/02-04-SUMMARY.md
@.planning/phases/02-core-game-loop/02-05-SUMMARY.md

@apps/api/src/game/TurnManager.ts
@apps/api/src/managers/GameManager.ts
@apps/web/src/game/UI/DiceRoller.tsx
@apps/web/src/game/UI/TurnIndicator.tsx
@libs/shared/src/schemas/game.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add end phase transition to TurnManager</name>
  <files>apps/api/src/game/TurnManager.ts</files>
  <action>
Modify advanceTurn() to transition current turn to 'end' phase BEFORE advancing to next player:

```typescript
// Before advancing to next player:
state.turnPhase = 'end';

// Brief transition state allows clients to show "Turn ending..." UI
// Then advance to next player:
const currentPlayerIndex = state.players.findIndex(p => p.id === state.currentPlayer);
const nextPlayerIndex = (currentPlayerIndex + 1) % state.players.length;
state.currentPlayer = state.players[nextPlayerIndex].id;
state.turnPhase = 'roll';
state.lastDiceRoll = null;
```

This creates explicit three-phase flow: roll → main → end → (next player's) roll.

Reference existing phase transitions in rollDice() (roll → main) for consistency.
  </action>
  <verify>Read TurnManager.ts - advanceTurn sets turnPhase to 'end' before advancing currentPlayer</verify>
  <done>Turn phase explicitly transitions to 'end' before next player's turn begins</done>
</task>

<task type="auto">
  <name>Task 2: Update GameManager endTurn to support end phase</name>
  <files>apps/api/src/managers/GameManager.ts</files>
  <action>
Update endTurn() action to:

1. Validate player can end turn (current player, phase is 'main' or 'end')
2. Transition to 'end' phase first (for immediate feedback)
3. Call TurnManager.advanceTurn() which will handle full transition

Alternatively: If endTurn() currently just calls advanceTurn(), ensure it allows 'end' phase as valid starting phase for the end_turn action. The turn may be in 'end' phase when user clicks "End Turn" if we want to show end phase UI first.

Pattern: Two approaches are valid:
- A) end_turn action triggers immediate advance (main → end → roll in one server action)
- B) end_turn action triggers main → end transition, then separate confirm action advances (more explicit but requires extra click)

Choose approach A for simplicity: single end_turn action does full transition but state briefly shows 'end' for logging/tracking.
  </action>
  <verify>Read GameManager.ts - endTurn handles 'main' phase and advances through 'end'</verify>
  <done>GameManager supports end phase in turn advancement flow</done>
</task>

<task type="auto">
  <name>Task 3: Update UI to display end phase</name>
  <files>apps/web/src/game/UI/TurnIndicator.tsx, apps/web/src/game/UI/DiceRoller.tsx</files>
  <action>
In TurnIndicator.tsx:
- Add display for turnPhase === 'end': "End Phase — Finishing turn..."
- Show clear visual distinction between main and end phases

In DiceRoller.tsx:
- Keep "End Turn" button visible during 'main' phase (already implemented)
- Optionally show brief "Ending turn..." message when phase becomes 'end' (before next player's roll)
- Or simply let phase advance quickly through 'end' without explicit UI (user clicks End Turn, sees next player's turn)

Since CONTEXT.md specifies ~1 second transition animation when turn ends, consider:
- Show "Player X's turn ending..." for ~1 second during 'end' phase
- Then show "Player Y's turn" when phase becomes 'roll'

Implementation choice (per CONTEXT.md "Copilot's Discretion"):
- Exact transition animation timing (~500ms-1s acceptable)
- Message wording ("Ending turn..." vs "Turn complete" vs silent transition)

Goal: Make three-phase structure observable without disrupting gameplay flow.
  </action>
  <verify>Read TurnIndicator.tsx and DiceRoller.tsx - 'end' phase is displayed or handled in transition logic</verify>
  <done>UI shows end phase transition, making three-phase turn structure observable to users</done>
</task>

</tasks>

<verification>
Run development servers and play through multiple turns. Verify:

1. **Phase progression:** Roll dice → phase becomes 'main' → click End Turn → phase becomes 'end' → next player's phase becomes 'roll'
2. **UI feedback:** Turn indicator shows "End Phase" or "Ending turn..." message during transition
3. **Timing:** Transition feels smooth (~1 second as specified in CONTEXT.md)
4. **Server state:** Check WebSocket game_state messages - turnPhase field includes 'end' state
5. **Full flow:** Complete turn cycle for all players, verify each turn goes through all three phases

Test with browser DevTools to confirm turnPhase values cycle correctly: 'roll' → 'main' → 'end' → (next player) 'roll'.
</verification>

<success_criteria>
- Turn phase explicitly transitions to 'end' before advancing to next player
- UI displays or acknowledges 'end' phase (even if brief)
- Three-phase turn structure is observable: roll → main → end
- TURN-03 requirement satisfied: Turn phases progress correctly
- No regression in existing turn functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-game-loop/02-07-SUMMARY.md`
</output>
