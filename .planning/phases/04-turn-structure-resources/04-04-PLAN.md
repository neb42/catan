---
phase: 04-turn-structure-resources
plan: 04
type: execute
wave: 3
depends_on: ['04-02']
files_modified:
  - apps/web/src/components/TurnControls/TurnControls.tsx
  - apps/web/src/components/ResourceHand/ResourceHand.tsx
  - apps/web/src/components/GamePlayerList.tsx
autonomous: true

must_haves:
  truths:
    - 'User sees End Turn button that is clickable in main phase'
    - 'User sees turn counter showing current turn number'
    - 'User sees their resource cards in a fanned hand layout'
    - 'Current player is highlighted in player list'
  artifacts:
    - path: 'apps/web/src/components/TurnControls/TurnControls.tsx'
      provides: 'End Turn button and turn counter display'
      exports: ['TurnControls']
    - path: 'apps/web/src/components/ResourceHand/ResourceHand.tsx'
      provides: 'Fanned resource card hand display'
      exports: ['ResourceHand']
    - path: 'apps/web/src/components/GamePlayerList.tsx'
      provides: 'Current player highlight indicator'
      contains: 'turnCurrentPlayerId'
  key_links:
    - from: 'apps/web/src/components/TurnControls/TurnControls.tsx'
      to: 'apps/web/src/stores/gameStore.ts'
      via: 'useCanEndTurn, useTurnNumber, useSocket hooks'
      pattern: 'useCanEndTurn|useTurnNumber'
    - from: 'apps/web/src/components/ResourceHand/ResourceHand.tsx'
      to: 'apps/web/src/stores/gameStore.ts'
      via: 'usePlayerResources hook'
      pattern: 'usePlayerResources'
---

<objective>
Create TurnControls for turn management and ResourceHand for card display, plus update player list with turn indicator.

Purpose: Enable users to progress through turns (End Turn button), track the game progression (turn counter), and view their resources as physical-feeling cards. The player list needs to highlight the current player so everyone knows whose turn it is.

Output: TurnControls component, ResourceHand component, and updated GamePlayerList with current player highlighting.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-turn-structure-resources/04-CONTEXT.md
@.planning/phases/04-turn-structure-resources/04-RESEARCH.md
@.planning/phases/04-turn-structure-resources/04-02-SUMMARY.md

# Existing components to extend

@apps/web/src/components/GamePlayerList.tsx
@apps/web/src/stores/gameStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TurnControls component</name>
  <files>
    apps/web/src/components/TurnControls/TurnControls.tsx
  </files>
  <action>
    Create directory: apps/web/src/components/TurnControls/

    Create apps/web/src/components/TurnControls/TurnControls.tsx:

    1. Import hooks: useCanEndTurn, useTurnNumber, useTurnPhase, useSocket, useIsMyTurn from gameStore
    2. Import Button from '@mantine/core'

    3. Component logic:
       - canEndTurn = useCanEndTurn()
       - turnNumber = useTurnNumber()
       - turnPhase = useTurnPhase()
       - isMyTurn = useIsMyTurn() (need to add this hook or derive)
       - sendMessage = useSocket()

    4. handleEndTurn function:
       - If !canEndTurn, return early
       - Call sendMessage({ type: 'end_turn' })

    5. Render structure:
       ```tsx
       <div className="turn-controls">
         {/* Turn counter */}
         <div className="turn-counter">
           Turn {turnNumber}
         </div>

         {/* Turn indicator banner */}
         {isMyTurn && (
           <div className="my-turn-banner">
             It's your turn!
           </div>
         )}

         {/* End Turn button */}
         <Button
           onClick={handleEndTurn}
           disabled={!canEndTurn}
           size="lg"
           variant={canEndTurn ? "filled" : "light"}
           color={canEndTurn ? "teal" : "gray"}
           styles={{
             root: {
               fontWeight: 700,
               fontSize: '1.1rem',
             }
           }}
         >
           End Turn
         </Button>
       </div>
       ```

    6. Styling (inline or CSS module):
       - Turn counter: subtle, positioned top-right or in header area
       - My turn banner: prominent, maybe with glow animation
       - End Turn button: always visible, prominent when enabled

    Per CONTEXT.md:
    - Prominent "End Turn" button always visible when available ‚úì
    - "It's your turn!" banner when turn begins ‚úì
    - Show turn counter (e.g. "Turn 5") ‚úì
    - Immediate end on click (no confirmation) ‚úì

    Note: The "It's your turn" banner should ideally animate in when turn changes to current player.

  </action>
  <verify>
    Run: npx nx build web
    Expected: Build succeeds with no TypeScript errors
  </verify>
  <done>
    - TurnControls component created with End Turn button
    - Turn counter displays current turn number
    - "It's your turn!" banner shows when it's player's turn
    - End Turn button sends end_turn message
    - Button disabled when not in main phase or not player's turn
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ResourceHand component</name>
  <files>
    apps/web/src/components/ResourceHand/ResourceHand.tsx
  </files>
  <action>
    Create directory: apps/web/src/components/ResourceHand/

    Create apps/web/src/components/ResourceHand/ResourceHand.tsx:

    1. Import usePlayerResources, useGameStore from gameStore
    2. Import motion from 'motion/react' for smooth card animations

    3. Define resource card colors/icons:
       ```typescript
       const RESOURCE_CARDS = {
         wood: { color: '#228B22', icon: 'ü™µ', label: 'Wood' },
         brick: { color: '#B22222', icon: 'üß±', label: 'Brick' },
         sheep: { color: '#90EE90', icon: 'üêë', label: 'Sheep' },
         wheat: { color: '#FFD700', icon: 'üåæ', label: 'Wheat' },
         ore: { color: '#708090', icon: '‚õ∞Ô∏è', label: 'Ore' },
       };
       ```

    4. Component logic:
       - myPlayerId = useGameStore(state => state.myPlayerId)
       - resources = usePlayerResources(myPlayerId || '')
       - Generate array of individual cards from resource counts:
         - For each resource type with count > 0, create `count` card objects
         - Each card: { type, index }

    5. Render fanned hand layout:
       - Container with perspective for 3D effect
       - Map over cards array
       - Each card positioned with:
         - Slight rotation based on index: rotate(${(index - center) * 5}deg)
         - Slight vertical offset: translateY based on distance from center
         - Overlap via negative margin or absolute positioning
       - Use motion.div for smooth layout animations (layoutId for FLIP)

    6. Card styling:
       - Card size: ~60px √ó 90px (playing card proportions)
       - Background color based on resource type
       - Icon centered on card
       - Rounded corners, shadow for depth
       - Hover effect: lift card up slightly

    7. Empty state:
       - If no cards, show subtle "No resources" message

    Per CONTEXT.md:
    - Card hand layout with fanned overlapping cards ‚úì
    - Cards grouped by resource type in the fan ‚úì
    - Resource cards should feel like physical Catan cards ‚úì

    Implementation approach:
    - Group cards by type first, then fan within groups
    - Or simpler: sort all cards by type, then fan entire hand
    - Start with simpler approach, iterate if needed

  </action>
  <verify>
    Run: npx nx build web
    Expected: Build succeeds with no TypeScript errors
  </verify>
  <done>
    - ResourceHand component displays player's resources as fanned cards
    - Cards are colored and labeled by resource type
    - Cards overlap with slight rotation for fan effect
    - Hover effect lifts individual cards
    - Empty state handled gracefully
    - Uses motion for smooth layout animations
  </done>
</task>

<task type="auto">
  <name>Task 3: Add current player highlighting to GamePlayerList</name>
  <files>
    apps/web/src/components/GamePlayerList.tsx
  </files>
  <action>
    Update GamePlayerList to highlight the current turn player:

    1. Import useTurnCurrentPlayer hook from gameStore

    2. In component:
       - turnCurrentPlayerId = useTurnCurrentPlayer()

    3. For each player card, add visual indicator if player.id === turnCurrentPlayerId:
       - Add glow/border effect: box-shadow or border
       - Suggested: golden/teal glow around the player card
       - Add small indicator icon or text: "‚≠ê Current Turn" or similar

    4. Styling approach:
       ```tsx
       <div
         style={{
           // ... existing styles
           boxShadow: isCurrentPlayer
             ? '0 0 15px 3px var(--color-secondary)'
             : 'none',
           border: isCurrentPlayer
             ? '2px solid var(--color-secondary)'
             : '2px solid transparent',
           transition: 'all 0.3s ease',
         }}
       >
         {/* existing player card content */}
         {isCurrentPlayer && (
           <span style={{ fontSize: '0.8rem', color: 'var(--color-secondary)' }}>
             Current Turn
           </span>
         )}
       </div>
       ```

    5. Ensure highlighting works during both:
       - Placement phase (use currentPlayerId from placement state)
       - Main game phase (use turnCurrentPlayerId)
       - Derive: effectiveCurrentPlayerId = turnCurrentPlayerId || currentPlayerId (from placement)

    Per CONTEXT.md:
    - Glow/border highlight around current player's info ‚úì
    - Fixed turn order display (1-2-3-4) always visible in player list ‚úì

  </action>
  <verify>
    Run: npx nx build web
    Expected: Build succeeds with no TypeScript errors
  </verify>
  <done>
    - GamePlayerList highlights current player with glow/border
    - "Current Turn" indicator visible on current player's card
    - Works for both placement phase and main game phase
    - Smooth transition animation when turn changes
  </done>
</task>

</tasks>

<verification>
1. Web builds: `npx nx build web`
2. Visual check (if dev server running):
   - TurnControls shows turn number and End Turn button
   - End Turn button enabled only during main phase on player's turn
   - ResourceHand shows fanned cards based on player's resources
   - Current player highlighted in player list
</verification>

<success_criteria>

- TurnControls component renders with turn counter and End Turn button
- End Turn button sends end_turn message when clicked
- "It's your turn!" banner appears when it's player's turn
- ResourceHand displays resources as fanned, overlapping cards
- Cards colored by resource type with appropriate icons
- Current player highlighted in GamePlayerList with glow effect
- All components integrate with gameStore via hooks
  </success_criteria>

<output>
After completion, create `.planning/phases/04-turn-structure-resources/04-04-SUMMARY.md`
</output>
