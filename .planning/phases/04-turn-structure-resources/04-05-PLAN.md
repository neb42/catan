---
phase: 04-turn-structure-resources
plan: 05
type: execute
wave: 4
depends_on: ['04-03', '04-04']
files_modified:
  - apps/web/src/components/Game.tsx
autonomous: false

must_haves:
  truths:
    - 'User sees dice roller and turn controls after initial placement'
    - 'User can complete full turn cycle: roll dice → see resources → end turn'
    - 'Turn passes to next player after ending turn'
    - 'All players see consistent game state'
  artifacts:
    - path: 'apps/web/src/components/Game.tsx'
      provides: 'Complete game UI with all Phase 4 components integrated'
      contains: 'DiceRoller'
  key_links:
    - from: 'apps/web/src/components/Game.tsx'
      to: 'apps/web/src/components/DiceRoller/DiceRoller.tsx'
      via: 'component import and render'
      pattern: 'DiceRoller'
    - from: 'apps/web/src/components/Game.tsx'
      to: 'apps/web/src/components/TurnControls/TurnControls.tsx'
      via: 'component import and render'
      pattern: 'TurnControls'
    - from: 'apps/web/src/components/Game.tsx'
      to: 'apps/web/src/components/ResourceHand/ResourceHand.tsx'
      via: 'component import and render'
      pattern: 'ResourceHand'
---

<objective>
Integrate all Phase 4 components into the Game view and verify end-to-end functionality.

Purpose: Connect the dice roller, turn controls, and resource hand into the main game UI. This plan brings together all the pieces from Plans 01-04 to create a complete turn-based gameplay experience.

Output: Working game UI where users can roll dice, receive resources, and end turns in proper sequence.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-turn-structure-resources/04-CONTEXT.md
@.planning/phases/04-turn-structure-resources/04-03-SUMMARY.md
@.planning/phases/04-turn-structure-resources/04-04-SUMMARY.md

# Game component to update

@apps/web/src/components/Game.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate Phase 4 components into Game.tsx</name>
  <files>
    apps/web/src/components/Game.tsx
  </files>
  <action>
    Update Game.tsx to include the new Phase 4 components:

    1. Import new components:
       ```typescript
       import { DiceRoller } from './DiceRoller/DiceRoller';
       import { TurnControls } from './TurnControls/TurnControls';
       import { ResourceHand } from './ResourceHand/ResourceHand';
       ```

    2. Import turn state hooks:
       ```typescript
       import { useTurnPhase, usePlacementPhase } from '../stores/gameStore';
       ```

    3. Determine which phase UI to show:
       ```typescript
       const placementPhase = usePlacementPhase();
       const turnPhase = useTurnPhase();
       const isMainGamePhase = placementPhase === null && turnPhase !== null;
       ```

    4. Layout structure for main game phase:
       - Left/Center: Board (existing)
       - Right sidebar: GamePlayerList (existing)
       - Bottom: ResourceHand (new - player's cards)
       - Top-right or sidebar: DiceRoller + TurnControls (new)

    5. Conditional rendering:
       ```tsx
       {/* Placement phase UI (existing) */}
       {placementPhase !== null && (
         <PlacementUI />  {/* whatever exists */}
       )}

       {/* Main game phase UI (new) */}
       {isMainGamePhase && (
         <>
           <div className="game-controls-panel">
             <TurnControls />
             <DiceRoller />
           </div>
           <div className="resource-hand-panel">
             <ResourceHand />
           </div>
         </>
       )}
       ```

    6. Layout styling:
       - Use CSS Grid or Flexbox for responsive layout
       - Board should remain prominent and centered
       - Controls panel: fixed position or in sidebar
       - Resource hand: bottom of screen, full width

    7. Ensure Mantine Notifications provider is set up in App.tsx:
       - Check if @mantine/notifications is already configured
       - If not, add <Notifications /> component to app root

    Design considerations from CONTEXT.md:
    - Dice result appears as center overlay first, then transitions to side panel
    - For MVP: keep it simpler, show in sidebar directly
    - Can enhance overlay behavior in polish phase

  </action>
  <verify>
    Run: npx nx build web
    Expected: Build succeeds with no TypeScript errors
  </verify>
  <done>
    - Game.tsx imports and renders DiceRoller, TurnControls, ResourceHand
    - Components only show during main game phase (after placement complete)
    - Layout positions components appropriately
    - Notifications provider configured for resource feedback
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete turn cycle</name>
  <what-built>
    Complete turn-based gameplay flow:
    1. Backend turn state management with dice rolling
    2. WebSocket message handlers for roll_dice and end_turn
    3. Frontend store with turn state
    4. DiceRoller component with animation
    5. TurnControls component with End Turn button
    6. ResourceHand component with fanned cards
    7. Current player highlighting in player list
  </what-built>
  <how-to-verify>
    Start the development servers:
    ```bash
    npx nx serve api  # Terminal 1
    npx nx serve web  # Terminal 2
    ```

    Open two browser windows to http://localhost:4200

    Test 1 - Setup and Initial Turn:
    1. Create room in Window 1, join from Window 2
    2. Both players ready up, wait for countdown
    3. Complete initial placement (8 rounds of settlement/road)
    4. After last placement, verify:
       - Placement UI disappears
       - DiceRoller appears with "Roll Dice" button
       - TurnControls shows "Turn 1"
       - Current player highlighted in player list
       - Only first player can roll (other player's button disabled)

    Test 2 - Dice Rolling:
    1. First player clicks "Roll Dice"
    2. Verify:
       - Dice animate with tumbling effect (~0.8s)
       - Both dice values appear after animation
       - Total displayed prominently
       - If resources distributed: notification appears with "+X resource"
       - If no resources: "No resources from this roll" notification
       - Button changes to disabled state

    Test 3 - Resource Distribution:
    1. If dice roll matched a hex with settlement:
       - Verify ResourceHand shows new cards
       - Verify opponent's resource count updates in player list
    2. Both players should see consistent resource counts

    Test 4 - End Turn:
    1. After rolling, "End Turn" button should be enabled
    2. Click "End Turn"
    3. Verify:
       - Turn advances to next player
       - Turn counter increments
       - Current player highlight moves
       - Next player can now roll dice
       - Previous player's buttons disabled

    Test 5 - Full Turn Cycle:
    1. Complete several turns (at least 4, back to first player)
    2. Verify turn order is round-robin
    3. Verify resources accumulate correctly
    4. No console errors

    Expected results:
    - All tests pass
    - Turn flow is smooth and intuitive
    - Animations are visible and complete
    - State is consistent across both clients

  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Web builds: `npx nx build web`
2. API builds: `npx nx build api`
3. Human verification of complete turn cycle (Task 2)
</verification>

<success_criteria>
Phase 4 requirements satisfied:

- TURN-01: User can roll two dice on their turn with animated result ✓
- TURN-02: Game distributes resources to players with settlements/cities adjacent to rolled number ✓
- TURN-03: User progresses through turn phases: roll → main → end turn ✓
- TURN-04: Game enforces round-robin turn order across all players ✓
- RES-01: User can view their own resource cards ✓
- RES-02: Game tracks resource counts for all players ✓

Success criteria from roadmap:

1. Dice roll distributes resources — Roll dice, see animation, correct players get correct resources
2. Turn structure flows — Can progress from setup → first turn → second turn, correct player order
3. Resource tracking persists — Resources display correctly for all players, counts accurate after multiple turns
   </success_criteria>

<output>
After completion, create `.planning/phases/04-turn-structure-resources/04-05-SUMMARY.md`
</output>
