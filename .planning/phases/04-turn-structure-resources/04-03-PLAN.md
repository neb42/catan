---
phase: 04-turn-structure-resources
plan: 03
type: execute
wave: 3
depends_on: ['04-02']
files_modified:
  - apps/web/src/components/DiceRoller/DiceRoller.tsx
  - apps/web/src/components/DiceRoller/dice.module.css
autonomous: true

must_haves:
  truths:
    - 'User sees animated dice when roll occurs'
    - 'User sees dice result (both individual dice and total)'
    - "Dice roll button is disabled when not user's turn or already rolled"
  artifacts:
    - path: 'apps/web/src/components/DiceRoller/DiceRoller.tsx'
      provides: 'Dice roller component with animation and roll button'
      exports: ['DiceRoller']
    - path: 'apps/web/src/components/DiceRoller/dice.module.css'
      provides: 'CSS animations for dice rolling'
      contains: '@keyframes'
  key_links:
    - from: 'apps/web/src/components/DiceRoller/DiceRoller.tsx'
      to: 'apps/web/src/stores/gameStore.ts'
      via: 'useCanRollDice, useLastDiceRoll, useSocket hooks'
      pattern: 'useCanRollDice|useLastDiceRoll|useSocket'
---

<objective>
Create the DiceRoller component with animated dice and roll button.

Purpose: Enable the core dice rolling interaction with visual feedback. Per CONTEXT.md, dice should have a quick tumble animation (0.5-1s), show both individual dice and combined total, with the result appearing as a center overlay first then transitioning to persistent display.

Output: DiceRoller component that users can click to roll dice, see animation, and view results.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-turn-structure-resources/04-CONTEXT.md
@.planning/phases/04-turn-structure-resources/04-RESEARCH.md
@.planning/phases/04-turn-structure-resources/04-02-SUMMARY.md

# Store hooks to use

@apps/web/src/stores/gameStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiceRoller component with animation</name>
  <files>
    apps/web/src/components/DiceRoller/DiceRoller.tsx
    apps/web/src/components/DiceRoller/dice.module.css
  </files>
  <action>
    Create directory: apps/web/src/components/DiceRoller/

    Create apps/web/src/components/DiceRoller/dice.module.css:
    1. Define .diceContainer with perspective for 3D effect
    2. Define .die class with base styling (size ~60px, rounded corners, white background, shadow)
    3. Define .rolling animation class with keyframes:
       - @keyframes roll: rotateX 0→360→720, rotateY 0→180→360, scale 1→1.2→1
       - Duration: 0.8s ease-out
    4. Define .diceValue for the number display on die face (centered, bold)
    5. Define .result class for the total display (larger font, prominent)
    6. Define .rollButton styling (matches project design tokens)
    7. Define .disabled state for button

    Create apps/web/src/components/DiceRoller/DiceRoller.tsx:
    1. Import hooks: useCanRollDice, useLastDiceRoll, useSocket, useIsAnimating from gameStore
    2. Import motion from 'motion/react' for smooth animations
    3. Import CSS module

    4. Component state:
       - isRolling: boolean (local animation state)
       - displayValues: [number, number] | null (what to show on dice faces)

    5. Effect: When lastDiceRoll changes AND isRolling is true:
       - After animation duration (800ms), set isRolling to false
       - Update displayValues to lastDiceRoll values

    6. handleRoll function:
       - If !canRollDice, return early
       - Set isRolling to true
       - Call sendMessage({ type: 'roll_dice' })

    7. Render:
       - Container with two dice side by side
       - Each die shows its value (displayValues[0], displayValues[1])
       - Apply .rolling class when isRolling is true
       - Below dice: show total prominently when dice have been rolled
       - Roll button: disabled when !canRollDice or isRolling
       - Button text: "Roll Dice" when available, "Rolling..." when animating

    8. Use motion.div for dice with animate prop for smoother animation control:
       ```typescript
       <motion.div
         className={styles.die}
         animate={isRolling ? {
           rotateX: [0, 360, 720],
           rotateY: [0, 180, 360],
           scale: [1, 1.2, 1]
         } : {}}
         transition={{ duration: 0.8, ease: "easeOut" }}
       >
         {displayValues?.[0] ?? '?'}
       </motion.div>
       ```

    Design notes from CONTEXT.md:
    - Quick tumble animation (0.5-1s) ✓
    - Show both individual dice and combined total ✓
    - Special visual emphasis for rolling a 7 (add a visual indicator if total === 7)

  </action>
  <verify>
    Run: npx nx build web
    Expected: Build succeeds with no TypeScript errors
  </verify>
  <done>
    - DiceRoller component created with two animated dice
    - CSS module with rolling animation keyframes
    - Roll button sends roll_dice message
    - Button disabled when not player's turn or during animation
    - Dice values display after roll completes
    - Total shown prominently
    - Special styling for 7 (robber indicator)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add resource distribution notification</name>
  <files>
    apps/web/src/components/DiceRoller/DiceRoller.tsx
  </files>
  <action>
    Enhance DiceRoller to show resource distribution feedback:

    1. Import notifications from '@mantine/notifications'
    2. Import useGameStore to access myPlayerId

    3. Add effect to show notification when player receives resources:
       - Watch for lastResourcesDistributed changes (use useLastResourcesDistributed hook from gameStore)
       - After dice animation completes (use onAnimationComplete callback)
       - Check if current player received resources in lastResourcesDistributed
       - For the current player, show Mantine notification:
         ```typescript
         notifications.show({
           title: 'Resources received!',
           message: resources.map(r => `+${r.count} ${r.type}`).join(', '),
           color: 'green',
           autoClose: 3000,
           position: 'bottom-center',
         });
         ```
       - If no resources received by anyone, show:
         ```typescript
         notifications.show({
           message: 'No resources from this roll',
           color: 'gray',
           autoClose: 2000,
           position: 'bottom-center',
         });
         ```

    4. Note: lastResourcesDistributed state and useLastResourcesDistributed hook are already added in Plan 04-02.

    Per CONTEXT.md:
    - Text summary notification showing what you gained (e.g. "+2 wood, +1 wheat") ✓
    - Explicit empty message when roll produces no resources ✓

  </action>
  <verify>
    Run: npx nx build web
    Expected: Build succeeds with no TypeScript errors
  </verify>
  <done>
    - DiceRoller shows notification when current player receives resources
    - Shows "no resources" notification when roll yields nothing
    - Notifications use Mantine with proper positioning
    - Uses useLastResourcesDistributed hook from gameStore
  </done>
</task>

</tasks>

<verification>
1. Web builds: `npx nx build web`
2. Visual check (if dev server running):
   - DiceRoller component renders with two dice
   - Click roll button triggers animation
   - Dice show result values after animation
   - Total displayed prominently
   - Notification appears with resource gains
</verification>

<success_criteria>

- DiceRoller component renders two animated dice
- Roll button sends roll_dice WebSocket message
- Button disabled when not user's turn or during animation
- Dice animation plays for ~0.8s
- Result values (individual and total) displayed after animation
- Resource notification shows gains or "no resources" message
- Special visual for rolling 7
- Component integrates with gameStore via hooks
  </success_criteria>

<output>
After completion, create `.planning/phases/04-turn-structure-resources/04-03-SUMMARY.md`
</output>
