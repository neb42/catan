---
phase: 15-add-sound-effects-during-gameplay
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/services/sound.ts
  - apps/web/src/components/Game.tsx
  - apps/web/public/sounds/dice-roll.mp3
  - apps/web/public/sounds/build-road.mp3
  - apps/web/public/sounds/build-settlement.mp3
  - apps/web/public/sounds/build-city.mp3
  - apps/web/public/sounds/resource-gain.mp3
  - apps/web/public/sounds/your-turn.mp3
  - apps/web/public/sounds/trade-offer.mp3
  - apps/web/public/sounds/trade-complete.mp3
  - apps/web/public/sounds/robber-warning.mp3
  - apps/web/public/sounds/robber-place.mp3
  - apps/web/public/sounds/robber-steal.mp3
  - apps/web/public/sounds/dev-card-buy.mp3
  - apps/web/public/sounds/dev-card-play.mp3
  - apps/web/public/sounds/victory.mp3
  - apps/web/public/sounds/negative.mp3
autonomous: true
gap_closure: true
requirements:
  - AUDIO-01
must_haves:
  truths:
    - 'SoundService initializes on first user interaction and populates the sounds Map'
    - 'Audio files exist at /sounds/*.mp3 and can be loaded by the browser'
    - 'Playing a game action (dice roll, build, trade, etc.) produces audible sound'
  artifacts:
    - path: 'apps/web/src/services/sound.ts'
      provides: 'SoundService with lazy init on first play() call'
      contains: 'this.init()'
    - path: 'apps/web/public/sounds/dice-roll.mp3'
      provides: 'Dice roll sound effect'
    - path: 'apps/web/public/sounds/build-road.mp3'
      provides: 'Road building sound effect'
    - path: 'apps/web/public/sounds/build-settlement.mp3'
      provides: 'Settlement building sound effect'
    - path: 'apps/web/public/sounds/build-city.mp3'
      provides: 'City upgrade sound effect'
    - path: 'apps/web/public/sounds/resource-gain.mp3'
      provides: 'Resource gain sound effect'
    - path: 'apps/web/public/sounds/your-turn.mp3'
      provides: 'Turn notification sound effect'
    - path: 'apps/web/public/sounds/trade-offer.mp3'
      provides: 'Trade offer sound effect'
    - path: 'apps/web/public/sounds/trade-complete.mp3'
      provides: 'Trade complete sound effect'
    - path: 'apps/web/public/sounds/robber-warning.mp3'
      provides: 'Robber warning sound effect'
    - path: 'apps/web/public/sounds/robber-place.mp3'
      provides: 'Robber placement sound effect'
    - path: 'apps/web/public/sounds/robber-steal.mp3'
      provides: 'Robber steal sound effect'
    - path: 'apps/web/public/sounds/dev-card-buy.mp3'
      provides: 'Dev card purchase sound effect'
    - path: 'apps/web/public/sounds/dev-card-play.mp3'
      provides: 'Dev card play sound effect'
    - path: 'apps/web/public/sounds/victory.mp3'
      provides: 'Victory fanfare sound effect'
    - path: 'apps/web/public/sounds/negative.mp3'
      provides: 'Negative event sound effect'
  key_links:
    - from: 'apps/web/src/services/sound.ts'
      to: 'Howler.js Howl instances'
      via: 'init() called lazily on first play()'
      pattern: "this\\.init\\(\\)"
    - from: 'apps/web/public/sounds/'
      to: 'SoundService SOUND_CONFIG'
      via: 'File paths match config src arrays'
      pattern: "/sounds/.*\\.mp3"
---

<objective>
Close 2 verification gaps that prevent Phase 15 sound effects from working at runtime.

Purpose: The sound infrastructure code (SoundService, handlers, settings UI) is fully wired but non-functional because (1) `soundService.init()` is never called so the sounds Map stays empty and all `play()` calls are no-ops, and (2) the 15 MP3 audio files referenced in SOUND_CONFIG are missing from `public/sounds/`.

Output: Working sound effects — game actions produce audible audio in the browser.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-VERIFICATION.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-01-SUMMARY.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-02-SUMMARY.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-CONTEXT.md
@apps/web/src/services/sound.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix SoundService init and generate MP3 audio files</name>
  <files>apps/web/src/services/sound.ts, apps/web/public/sounds/dice-roll.mp3, apps/web/public/sounds/build-road.mp3, apps/web/public/sounds/build-settlement.mp3, apps/web/public/sounds/build-city.mp3, apps/web/public/sounds/resource-gain.mp3, apps/web/public/sounds/your-turn.mp3, apps/web/public/sounds/trade-offer.mp3, apps/web/public/sounds/trade-complete.mp3, apps/web/public/sounds/robber-warning.mp3, apps/web/public/sounds/robber-place.mp3, apps/web/public/sounds/robber-steal.mp3, apps/web/public/sounds/dev-card-buy.mp3, apps/web/public/sounds/dev-card-play.mp3, apps/web/public/sounds/victory.mp3, apps/web/public/sounds/negative.mp3</files>
  <action>
    **Gap 1 — Fix SoundService initialization:**

    Modify `apps/web/src/services/sound.ts` to use lazy initialization. Instead of requiring an external `init()` call, call `this.init()` inside the `play()` method before attempting to play. This approach:
    - Avoids browser autoplay policy issues (init happens on user-triggered game action, not app startup)
    - Requires zero changes to Game.tsx or any other file
    - Is a 1-line addition to `play()`

    Change the `play()` method to:
    ```typescript
    play(name: SoundName): void {
      if (!useGameStore.getState().soundEnabled) return;
      if (!this.initialized) this.init();
      const sound = this.sounds.get(name);
      if (sound) {
        sound.play();
      }
    }
    ```

    **Gap 2 — Generate MP3 audio files:**

    Generate 15 short MP3 sound effect files using the Web Audio API via a Node.js script. Create a temporary script `scripts/generate-sounds.js` that uses the `audiobuffer-to-wav` npm package (or raw WAV buffer construction) to produce short synthesized sounds, then convert them to MP3 using `ffmpeg` if available, or save as WAV and rename to MP3 (Howler.js handles both).

    **Alternative approach (simpler):** Use a Node.js script that creates minimal valid MP3 files using synthesized tones. Each file should be:
    - 0.2–1.5 seconds long
    - Distinct per event type (different frequencies, patterns)
    - Small file size (< 50KB each)

    **Simplest approach (recommended):** Since this is a game prototype and the CONTEXT.md says Claude has discretion over "exact sound file selection", generate the audio files using the `tone` npm package or write a script using the built-in `node:buffer` module to create minimal WAV files with appropriate characteristics:

    | Sound | Character | Duration | Approach |
    |-------|-----------|----------|----------|
    | dice-roll.mp3 | Rattling, percussive | 0.5s | Multiple short bursts |
    | build-road.mp3 | Wooden tap | 0.3s | Low thud |
    | build-settlement.mp3 | Wooden place | 0.4s | Medium thud + overtone |
    | build-city.mp3 | Heavier construction | 0.5s | Deep thud + shimmer |
    | resource-gain.mp3 | Pleasant chime | 0.3s | High ascending tone |
    | your-turn.mp3 | Attention bell | 0.5s | Bell-like tone |
    | trade-offer.mp3 | Paper rustle | 0.3s | Soft swish |
    | trade-complete.mp3 | Coin clink | 0.3s | Metallic ting |
    | robber-warning.mp3 | Ominous low tone | 0.6s | Deep warning drone |
    | robber-place.mp3 | Heavy thump | 0.4s | Bass impact |
    | robber-steal.mp3 | Sneaky swipe | 0.3s | Quick swoosh down |
    | dev-card-buy.mp3 | Card draw | 0.3s | Paper slide |
    | dev-card-play.mp3 | Card flip reveal | 0.4s | Snap + shimmer |
    | victory.mp3 | Celebratory fanfare | 1.5s | Ascending major chord arpeggio |
    | negative.mp3 | Sad/error buzzer | 0.4s | Low descending tone |

    Write the generation script to `scripts/generate-sounds.js`. Run it to produce all 15 files in `apps/web/public/sounds/`. Then delete the script (it's a one-time tool).

    The script should use raw PCM data to construct WAV files (WAV is simpler to generate than MP3, and Howler.js plays WAV just fine). If generating WAV, update the SOUND_CONFIG `src` arrays in `sound.ts` to reference `.wav` instead of `.mp3`, OR name the WAV files with `.mp3` extension (browsers handle this via content sniffing).

    **Important:** The simplest viable approach is best. These are placeholder sounds for a prototype. They need to be audible, distinct from each other, and match the general character described above. Perfect audio quality is NOT required.

    After generating, verify each file exists and has non-zero size:
    ```bash
    ls -la apps/web/public/sounds/
    ```

  </action>
  <verify>
    1. `ls apps/web/public/sounds/*.mp3` (or *.wav) shows 15 files, all non-zero size
    2. `grep -c "this.init()" apps/web/src/services/sound.ts` returns at least 1 (lazy init in play())
    3. `npx nx typecheck web` passes
    4. `npx nx build web` succeeds
  </verify>
  <done>
    - SoundService.play() calls this.init() lazily on first invocation
    - All 15 sound files exist in apps/web/public/sounds/ with non-zero byte size
    - TypeScript typecheck passes
    - Web build succeeds
  </done>
</task>

</tasks>

<verification>
1. TypeScript typecheck passes: `npx nx typecheck web`
2. Production build succeeds: `npx nx build web`
3. All 15 sound files exist: `ls apps/web/public/sounds/` shows 15 files
4. Lazy init wired: SoundService.play() contains `this.init()` call
5. No regressions: All existing handler imports and play() calls still resolve
</verification>

<success_criteria>

- SoundService initializes lazily on first play() — no external init() call needed
- 15 audio files present in public/sounds/ directory, all non-zero size
- `npx nx typecheck web` passes
- `npx nx build web` succeeds
- Combined with existing handler wiring (from 15-02), game actions will produce audible sound at runtime
  </success_criteria>

<output>
After completion, create `.planning/phases/15-add-sound-effects-during-gameplay/15-03-SUMMARY.md`
</output>
