---
phase: 15-add-sound-effects-during-gameplay
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/src/services/sound.ts
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/Settings/SettingsButton.tsx
  - apps/web/src/components/Settings/SettingsPanel.tsx
  - apps/web/src/components/Game.tsx
  - apps/web/public/sounds/dice-roll.mp3
  - apps/web/public/sounds/build-road.mp3
  - apps/web/public/sounds/build-settlement.mp3
  - apps/web/public/sounds/build-city.mp3
  - apps/web/public/sounds/resource-gain.mp3
  - apps/web/public/sounds/your-turn.mp3
  - apps/web/public/sounds/trade-offer.mp3
  - apps/web/public/sounds/trade-complete.mp3
  - apps/web/public/sounds/robber-warning.mp3
  - apps/web/public/sounds/robber-place.mp3
  - apps/web/public/sounds/robber-steal.mp3
  - apps/web/public/sounds/dev-card-buy.mp3
  - apps/web/public/sounds/dev-card-play.mp3
  - apps/web/public/sounds/victory.mp3
  - apps/web/public/sounds/negative.mp3
autonomous: true
requirements:
  - AUDIO-01
  - AUDIO-02

must_haves:
  truths:
    - 'SoundService singleton can play named sound effects'
    - 'User can toggle sound on/off via settings panel'
    - 'Sound preference persists across browser sessions'
    - 'Audio files load and play in browser'
  artifacts:
    - path: 'apps/web/src/services/sound.ts'
      provides: 'Singleton SoundService wrapping Howler.js'
      exports: ['soundService', 'SoundName']
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'SoundSlice with soundEnabled + toggleSound'
      contains: 'soundEnabled'
    - path: 'apps/web/src/components/Settings/SettingsPanel.tsx'
      provides: 'Settings panel with sound toggle'
      min_lines: 30
    - path: 'apps/web/public/sounds/'
      provides: '15 MP3 sound effect files'
  key_links:
    - from: 'apps/web/src/services/sound.ts'
      to: 'apps/web/src/stores/gameStore.ts'
      via: 'useGameStore.getState().soundEnabled check'
      pattern: "useGameStore\\.getState\\(\\)"
    - from: 'apps/web/src/components/Settings/SettingsPanel.tsx'
      to: 'apps/web/src/stores/gameStore.ts'
      via: 'toggleSound action'
      pattern: 'toggleSound'
---

<objective>
Install Howler.js, create SoundService singleton, add sound toggle to gameStore, build settings UI, and source/add sound files.

Purpose: Establish audio infrastructure that handlers can consume in Plan 02.
Output: Working sound service + settings toggle + 15 tabletop-style sound effects in public/sounds/
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-CONTEXT.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-RESEARCH.md
@apps/web/src/stores/gameStore.ts
@apps/web/src/components/Game.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Howler.js and create SoundService</name>
  <files>
    apps/web/package.json
    apps/web/src/services/sound.ts
  </files>
  <action>
Install Howler.js and TypeScript types:
```bash
cd apps/web && npm install howler && npm install -D @types/howler
```

Create `apps/web/src/services/sound.ts` with singleton SoundService pattern:

1. Define `SoundName` type union with all 15 sound events:
   - diceRoll, buildRoad, buildSettlement, buildCity, resourceGain
   - yourTurn, tradeOffer, tradeComplete
   - robberWarning, robberPlace, robberSteal
   - devCardBuy, devCardPlay, victory, negative

2. Create `SOUND_CONFIG` record mapping each SoundName to:
   - `src`: array with MP3 path (e.g., `['/sounds/dice-roll.mp3']`)
   - `volume`: 0.5-0.8 range (victory at 0.8, negative at 0.6, most at 0.7)

3. Create `SoundService` class:
   - Private `sounds: Map<SoundName, Howl>`
   - Private `initialized: boolean`
   - `init()`: Create Howl instances for all sounds with `preload: true`
   - `play(name: SoundName)`: Check `useGameStore.getState().soundEnabled`, if true call `sound.play()`
   - Guard against double-init

4. Export singleton: `export const soundService = new SoundService()`

Per CONTEXT.md: Use tabletop aesthetic (wooden pieces, dice on table feel). All files in public/sounds/ with absolute paths.
</action>
<verify>

```bash
cd apps/web && npx tsc --noEmit
```

TypeScript compiles without errors. Import statement `import { soundService } from '../services/sound'` resolves.
</verify>
<done>
SoundService class exists with init() and play(name) methods. SOUND_CONFIG defines all 15 sounds. Exports soundService singleton and SoundName type.
</done>
</task>

<task type="auto">
  <name>Task 2: Add SoundSlice to gameStore with localStorage persistence</name>
  <files>
    apps/web/src/stores/gameStore.ts
  </files>
  <action>
Add SoundSlice to existing gameStore following the established slice pattern (like RobberSlice, DevCardSlice):

1. Add `SoundSlice` interface:

```typescript
interface SoundSlice {
  soundEnabled: boolean;
  toggleSound: () => void;
}
```

2. Add SoundSlice to GameStore interface (add to extends list)

3. Add initial state in store creation:

```typescript
// Sound state - default ON per CONTEXT.md, persisted to localStorage
soundEnabled: localStorage.getItem('catan-sound-enabled') !== 'false',
```

Note: This defaults to true when key is absent (per CONTEXT.md: sounds on by default)

4. Add toggleSound action:

```typescript
toggleSound: () => {
  set((state) => {
    const next = !state.soundEnabled;
    localStorage.setItem('catan-sound-enabled', String(next));
    return { soundEnabled: next };
  });
},
```

5. Add selector hook at bottom of file:

```typescript
export const useSoundEnabled = () =>
  useGameStore((state) => state.soundEnabled);
```

IMPORTANT: Use explicit string comparison `!== 'false'` per research pitfall #5 to avoid truthy string issues.
</action>
<verify>

```bash
cd apps/web && npx tsc --noEmit
```

TypeScript compiles. Store interface includes soundEnabled and toggleSound.
</verify>
<done>
SoundSlice added to gameStore with soundEnabled boolean (default true), toggleSound action with localStorage persistence, and useSoundEnabled selector hook.
</done>
</task>

<task type="auto">
  <name>Task 3: Create Settings UI with sound toggle</name>
  <files>
    apps/web/src/components/Settings/SettingsButton.tsx
    apps/web/src/components/Settings/SettingsPanel.tsx
    apps/web/src/components/Settings/index.ts
    apps/web/src/components/Game.tsx
  </files>
  <action>
Create settings components following project's parchment aesthetic (per quick task 020):

1. Create `apps/web/src/components/Settings/SettingsButton.tsx`:
   - Gear icon button (use Mantine ActionIcon)
   - Position absolute top-right of game area
   - onClick opens settings panel
   - Use parchment colors: background #F5ECD7, border #8B7355

2. Create `apps/web/src/components/Settings/SettingsPanel.tsx`:
   - Modal/Drawer component from Mantine
   - Title: "Settings" with parchment styling
   - Sound toggle: Mantine Switch component
     - Label: "Sound Effects"
     - Checked: useSoundEnabled() from gameStore
     - onChange: useGameStore.getState().toggleSound()
   - Close button
   - Apply parchment aesthetic: warm beige background, wooden border feel

3. Create `apps/web/src/components/Settings/index.ts`:
   - Export { SettingsButton } from './SettingsButton'
   - Export { SettingsPanel } from './SettingsPanel'

4. Update `apps/web/src/components/Game.tsx`:
   - Import { SettingsButton, SettingsPanel } from './Settings'
   - Add state: `const [settingsOpen, setSettingsOpen] = useState(false)`
   - Render SettingsButton in top-right corner (z-index 25, below modals)
   - Render SettingsPanel with opened={settingsOpen} onClose handler

Per CONTEXT.md: Toggle lives in settings panel, not always visible in main UI.
</action>
<verify>

```bash
cd apps/web && npx tsc --noEmit
```

TypeScript compiles. Settings components exist and are imported in Game.tsx.
</verify>
<done>
Settings button visible in game UI. Clicking opens panel with sound toggle. Toggle updates soundEnabled in store and persists to localStorage.
</done>
</task>

</tasks>

<verification>
1. `cd apps/web && npm run build` completes without errors
2. TypeScript compilation: `npx tsc --noEmit` passes
3. SoundService exports are importable: `import { soundService } from './services/sound'`
4. gameStore.getState().soundEnabled returns boolean
5. gameStore.getState().toggleSound() flips the value and persists to localStorage
6. Settings button renders in Game component
</verification>

<success_criteria>

- Howler.js installed and SoundService singleton created
- SoundSlice added to gameStore with localStorage persistence
- Settings UI renders with working sound toggle
- Sound files directory structure created (files added next)
- All TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/15-add-sound-effects-during-gameplay/15-01-SUMMARY.md`
</output>
