---
phase: 15-add-sound-effects-during-gameplay
plan: 02
type: execute
wave: 2
depends_on:
  - '15-01'
files_modified:
  - apps/web/src/handlers/turnHandlers.ts
  - apps/web/src/handlers/buildingHandlers.ts
  - apps/web/src/handlers/tradeHandlers.ts
  - apps/web/src/handlers/robberHandlers.ts
  - apps/web/src/handlers/devCardHandlers.ts
  - apps/web/src/handlers/victoryHandlers.ts
  - apps/web/src/handlers/awardHandlers.ts
  - apps/web/src/components/Lobby.tsx
autonomous: true
requirements:
  - AUDIO-01

must_haves:
  truths:
    - 'Dice roll plays sound on result'
    - 'Building actions play sounds'
    - 'Trade events play sounds'
    - 'Robber sequence plays distinct sounds'
    - 'Dev card buy/play plays sounds'
    - 'Victory plays celebratory fanfare'
    - 'Your turn notification plays sound'
    - 'Negative events play distinct tone'
  artifacts:
    - path: 'apps/web/src/handlers/turnHandlers.ts'
      provides: 'Dice roll and turn change sounds'
      contains: 'soundService.play'
    - path: 'apps/web/src/handlers/buildingHandlers.ts'
      provides: 'Building sounds (road, settlement, city)'
      contains: 'soundService.play'
    - path: 'apps/web/src/handlers/victoryHandlers.ts'
      provides: 'Victory fanfare sound'
      contains: "soundService.play('victory')"
  key_links:
    - from: 'apps/web/src/handlers/*.ts'
      to: 'apps/web/src/services/sound.ts'
      via: 'soundService.play()'
      pattern: "soundService\\.play\\("
---

<objective>
Integrate sound playback into all WebSocket message handlers by adding soundService.play() calls.

Purpose: Connect the sound infrastructure (Plan 01) to game events so sounds play during gameplay.
Output: All 15 sound events trigger at appropriate moments during gameplay.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-CONTEXT.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-RESEARCH.md
@.planning/phases/15-add-sound-effects-during-gameplay/15-01-SUMMARY.md
@apps/web/src/services/sound.ts
@apps/web/src/handlers/index.ts
@apps/web/src/handlers/turnHandlers.ts
@apps/web/src/handlers/buildingHandlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sounds to turn and building handlers</name>
  <files>
    apps/web/src/handlers/turnHandlers.ts
    apps/web/src/handlers/buildingHandlers.ts
  </files>
  <action>
Import soundService in both files:
```typescript
import { soundService } from '../services/sound';
```

**turnHandlers.ts** - Add sound calls:

1. `handleDiceRolled`:
   - After state updates, add: `soundService.play('diceRoll')`
   - If resources were distributed to anyone, add: `soundService.play('resourceGain')`
   - Note: resourceGain plays once per distribution event per CONTEXT.md (not per resource type)

2. `handleTurnChanged`:
   - Only play sound when it becomes THIS player's turn:
   ```typescript
   const { myPlayerId } = useGameStore.getState();
   if (message.currentPlayerId === myPlayerId) {
     soundService.play('yourTurn');
   }
   ```

   - Per CONTEXT.md: "Your turn notification: Sound plays when it becomes your turn; no sound for others' turn changes"

**buildingHandlers.ts** - Add sound calls:

1. `handleRoadBuilt`: Add `soundService.play('buildRoad')` after addRoad
2. `handleSettlementBuilt`: Add `soundService.play('buildSettlement')` after addSettlement
3. `handleCityBuilt`: Add `soundService.play('buildCity')` after upgradeToCity
4. `handleBuildFailed`: Add `soundService.play('negative')` for failed builds

Per CONTEXT.md: All players hear all events (no differentiation own vs opponent).
</action>
<verify>

```bash
cd apps/web && npx tsc --noEmit
```

TypeScript compiles. Sound imports resolve correctly.
</verify>
<done>
Turn handlers play diceRoll, resourceGain, yourTurn sounds. Building handlers play buildRoad, buildSettlement, buildCity, negative sounds.
</done>
</task>

<task type="auto">
  <name>Task 2: Add sounds to trade and robber handlers</name>
  <files>
    apps/web/src/handlers/tradeHandlers.ts
    apps/web/src/handlers/robberHandlers.ts
  </files>
  <action>
Import soundService in both files:
```typescript
import { soundService } from '../services/sound';
```

**tradeHandlers.ts** - Add sound calls:

1. `handleTradeProposed`: Add `soundService.play('tradeOffer')` - incoming trade offer arrival
2. `handleTradeExecuted`: Add `soundService.play('tradeComplete')` - trade completion
3. `handleBankTradeExecuted`: Add `soundService.play('tradeComplete')` - bank/port trade completion
4. `handleTradeCancelled`: No sound (silent cancellation is fine)

**robberHandlers.ts** - Add sound calls (distinct per sub-action per CONTEXT.md):

1. `handleRobberTriggered`: Add `soundService.play('robberWarning')` - 7 rolled warning
2. `handleRobberMoved`: Add `soundService.play('robberPlace')` - robber placed on hex
3. `handleStolen`: Add `soundService.play('robberSteal')` - stealing a card
4. `handleDiscardRequired`: Add `soundService.play('negative')` - player must discard (negative event)
5. `handleNoStealPossible`: No sound needed

Per CONTEXT.md: Robber sequence has distinct sounds for each sub-action. Negative events (discard, getting robbed) use negative tone.
</action>
<verify>

```bash
cd apps/web && npx tsc --noEmit
```

TypeScript compiles. Sound calls are in correct handlers.
</verify>
<done>
Trade handlers play tradeOffer, tradeComplete sounds. Robber handlers play robberWarning, robberPlace, robberSteal, negative sounds at appropriate moments.
</done>
</task>

<task type="auto">
  <name>Task 3: Add sounds to dev card, victory, and award handlers</name>
  <files>
    apps/web/src/handlers/devCardHandlers.ts
    apps/web/src/handlers/victoryHandlers.ts
    apps/web/src/handlers/awardHandlers.ts
  </files>
  <action>
Import soundService in all three files:
```typescript
import { soundService } from '../services/sound';
```

**devCardHandlers.ts** - Add sound calls:

1. `handleDevCardPurchased`: Add `soundService.play('devCardBuy')` - buying a card
2. `handleDevCardPlayed`: Add `soundService.play('devCardPlay')` - playing any card
3. `handleDevCardPlayFailed`: Add `soundService.play('negative')` - failed play attempt
4. `handleMonopolyExecuted`: Add `soundService.play('negative')` for victims (players losing resources)
   - But this is broadcast to all, so just play devCardPlay for the effect completion

Per CONTEXT.md: Generic buy sound + generic play sound (not per-card-type).

**victoryHandlers.ts** - Add sound calls:

1. `handleVictory`: Add `soundService.play('victory')` - celebratory fanfare
   - Per CONTEXT.md: "Victory: Celebratory fanfare/jingle when someone wins (distinct from all other sounds)"

**awardHandlers.ts** - Add sound calls:

1. `handleLongestRoadUpdated`:
   - If award was taken from another player (previousHolderId exists and differs from new):
     - Play `soundService.play('negative')` for the player who lost it
   - Check if current player is the new holder: play positive building sound
   - This is tricky - awards update can be positive or negative depending on perspective
   - Simplest: No sound for award changes (they're secondary to the action that triggered them)
   - OR: Just log entry, no sound (keeps it clean)

2. `handleLargestArmyUpdated`: Same logic as longest road

Decision: Skip sounds for award handlers - the primary action (building road, playing knight) already has a sound. Award updates are secondary feedback handled by log entries and UI updates.
</action>
<verify>

```bash
cd apps/web && npx tsc --noEmit
```

TypeScript compiles. Victory handler plays victory sound. Dev card handlers play appropriate sounds.
</verify>
<done>
Dev card handlers play devCardBuy, devCardPlay, negative sounds. Victory handler plays victory fanfare. Award handlers have no sounds (secondary to primary actions).
</done>
</task>

</tasks>

<verification>
1. `cd apps/web && npm run build` completes without errors
2. TypeScript compilation: `npx tsc --noEmit` passes
3. Grep for soundService.play calls in handlers:
   ```bash
   grep -r "soundService.play" apps/web/src/handlers/
   ```
   Should show calls in: turnHandlers, buildingHandlers, tradeHandlers, robberHandlers, devCardHandlers, victoryHandlers
4. All sound event types are covered:
   - diceRoll: turnHandlers
   - resourceGain: turnHandlers
   - yourTurn: turnHandlers
   - buildRoad, buildSettlement, buildCity: buildingHandlers
   - tradeOffer, tradeComplete: tradeHandlers
   - robberWarning, robberPlace, robberSteal: robberHandlers
   - devCardBuy, devCardPlay: devCardHandlers
   - victory: victoryHandlers
   - negative: buildingHandlers, robberHandlers, devCardHandlers
</verification>

<success_criteria>

- All WebSocket handlers import and use soundService
- Each game event triggers appropriate sound
- Negative events (discard, failed actions) play negative tone
- Victory plays distinct celebratory fanfare
- Your turn notification only plays for local player
- All TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/15-add-sound-effects-during-gameplay/15-02-SUMMARY.md`
</output>
