---
phase: 06-trading
plan: 07
type: execute
wave: 4
depends_on: ['06-02', '06-03', '06-05', '06-06']
files_modified:
  - apps/web/src/components/Game.tsx
autonomous: false

must_haves:
  truths:
    - "Trade button appears in game UI during player's main phase"
    - 'TradeModal and TradeResponseModal are rendered in Game component'
    - 'All trade components are wired together correctly'
  artifacts:
    - path: 'apps/web/src/components/Game.tsx'
      provides: 'Trade components integrated into game'
      contains: 'TradeModal'
  key_links:
    - from: 'apps/web/src/components/Game.tsx'
      to: 'apps/web/src/components/Trade/TradeModal.tsx'
      via: 'import and render'
      pattern: 'TradeModal'
---

<objective>
Integrate trade components into the Game component and verify the complete trading system works end-to-end.

Purpose: Complete the trading feature by wiring all components together and verifying functionality.
Output: Fully integrated trading system ready for user testing.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-trading/06-RESEARCH.md
@.planning/phases/06-trading/06-05-SUMMARY.md
@.planning/phases/06-trading/06-06-SUMMARY.md

@apps/web/src/components/Game.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate trade components into Game.tsx</name>
  <files>apps/web/src/components/Game.tsx</files>
  <action>
Add trade components to the Game component:

1. Import trade components:

```typescript
import { TradeModal } from './Trade/TradeModal';
import { TradeResponseModal } from './Trade/TradeResponseModal';
import { TradeButton } from './Trade/TradeButton';
import { TradeProposerView } from './Trade/TradeProposerView';
```

2. Add TradeModal and TradeResponseModal to the render output (they manage their own visibility):

```typescript
{/* Trade modals - render at root level, they control their own visibility */}
<TradeModal />
<TradeResponseModal />
```

3. Add TradeButton near other game controls (like BuildControls):

```typescript
{/* Add alongside or near BuildControls */}
<TradeButton />
```

4. Add TradeProposerView somewhere visible when player is proposing a trade (perhaps near the game controls or as an overlay):

```typescript
<TradeProposerView />
```

The exact layout placement should follow existing game UI patterns. TradeProposerView shows when the current player has an active trade proposal.
</action>
<verify>Run `npx nx build web` and `npx nx serve web` to verify components render</verify>
<done>All trade components integrated into Game layout</done>
</task>

<task type="auto">
  <name>Task 2: Add turn-end trade cancellation</name>
  <files>apps/web/src/components/Lobby.tsx</files>
  <action>
Ensure that when a turn ends, any active trade is cleared.

In the `turn_changed` message handler in Lobby.tsx:

```typescript
case 'turn_changed': {
  // ... existing turn change logic ...

  // Clear any active trade when turn changes
  clearTrade();
  setTradeModalOpen(false);
  break;
}
```

This implements the CONTEXT.md requirement: "No timeout on trade responses (stays open until cancelled or turn ends)".
</action>
<verify>Run `npx nx build web` to verify no errors</verify>
<done>Active trades are cleared when turn ends</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete trading system</name>
  <what-built>Complete trading system with domestic and maritime trading</what-built>
  <how-to-verify>
1. Start the dev servers: `npx nx serve api` and `npx nx serve web`
2. Open two browser windows, join the same room with different players
3. Complete placement phase to get into main game

**Test Domestic Trading (TRADE-01, TRADE-02, TRADE-03):** 4. On Player 1's turn during main phase, click "Trade" button 5. Verify trade modal opens with Players/Bank tabs 6. In Players tab, compose an offer (give some resources, request some resources) 7. Click "Propose Trade" 8. Verify Player 2 sees blocking modal with Accept/Decline buttons 9. On Player 2, click Accept 10. Verify Player 1 sees "Accepted" status and "Trade with [Player 2]" button 11. Player 1 clicks to complete trade 12. Verify both players' resources update correctly 13. Verify toast notification appears

**Test Trade Cancellation:** 14. Propose another trade 15. Click "Cancel Trade" before anyone responds 16. Verify trade modal closes for all players

**Test Maritime Trading (TRADE-04):** 17. On your turn, open Trade modal, go to Bank tab 18. Verify you see rate labels (4:1 for resources without port access) 19. Trade 4 of one resource for 1 of another 20. Verify resources update correctly

**Test Port Access (TRADE-05, TRADE-06):** 21. Build a settlement on a port location 22. Open Bank trade tab 23. Verify the rate for that port's resource shows 2:1 (specific) or 3:1 (generic) 24. Complete a trade at the improved rate

**Expected Behavior:**

- Trade button only appears during your main phase
- Trade modal has working tabs
- Resource selectors have working +/- controls
- Give side constrained to owned resources
- Propose button disabled until valid offer
- Recipients see blocking modal (can't dismiss without responding)
- Proposer sees real-time response updates
- Partner selection completes trade
- Resources transfer correctly
- Bank trades work at correct rates
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
  </task>

</tasks>

<verification>
1. `npx nx build web` and `npx nx build api` complete without errors
2. Trade button visible during main phase
3. Trade modal opens with tabs
4. Domestic trade proposal -> response -> execution flow works
5. Bank trade works with correct rates
6. Port access affects bank trade rates
7. Turn end clears active trade
</verification>

<success_criteria>

- TRADE-01: Can propose trade offer to other players
- TRADE-02: Can accept or reject incoming trade offers
- TRADE-03: Trade execution transfers resources correctly
- TRADE-04: Can trade 4:1 with bank
- TRADE-05: Can trade 3:1 at generic port
- TRADE-06: Can trade 2:1 at specific resource port
- All trade UI works smoothly with clear feedback
  </success_criteria>

<output>
After completion, create `.planning/phases/06-trading/06-07-SUMMARY.md`
</output>
