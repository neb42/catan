---
phase: 06-trading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - libs/shared/src/schemas/messages.ts
  - libs/shared/src/schemas/game.ts
  - libs/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - 'Trade message types are validated by Zod schemas'
    - 'Trade types are exported from shared library'
    - 'ResourceType record pattern usable for trade offers'
  artifacts:
    - path: 'libs/shared/src/schemas/messages.ts'
      provides: 'Trade WebSocket message schemas'
      contains: 'ProposeTradeMessageSchema'
    - path: 'libs/shared/src/schemas/game.ts'
      provides: 'ActiveTrade type for game state'
      contains: 'ActiveTradeSchema'
  key_links:
    - from: 'libs/shared/src/index.ts'
      to: 'libs/shared/src/schemas/messages.ts'
      via: 're-export'
      pattern: 'export.*from.*messages'
---

<objective>
Add trade-related Zod schemas and TypeScript types to the shared library for domestic and maritime trading.

Purpose: Establish type-safe contracts for all trade WebSocket messages before implementing backend and frontend.
Output: Trade message schemas added to shared library, exported for use in API and web apps.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-trading/06-RESEARCH.md

@libs/shared/src/schemas/messages.ts
@libs/shared/src/schemas/game.ts
@libs/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trade message schemas to messages.ts</name>
  <files>libs/shared/src/schemas/messages.ts</files>
  <action>
Add the following Zod schemas to messages.ts, following the existing pattern (schemas + discriminated union + type exports):

**Client -> Server messages:**

1. `ProposeTradeMessageSchema` - type: 'propose_trade', offering: Record<ResourceType, number>, requesting: Record<ResourceType, number>
2. `RespondTradeMessageSchema` - type: 'respond_trade', response: 'accept' | 'decline'
3. `SelectTradePartnerMessageSchema` - type: 'select_trade_partner', partnerId: string
4. `CancelTradeMessageSchema` - type: 'cancel_trade'
5. `ExecuteBankTradeMessageSchema` - type: 'execute_bank_trade', giving: Record<ResourceType, number>, receiving: Record<ResourceType, number>

**Server -> Client broadcasts:**

1. `TradeProposedMessageSchema` - type: 'trade_proposed', proposerId: string, offering: Record<ResourceType, number>, requesting: Record<ResourceType, number>
2. `TradeResponseMessageSchema` - type: 'trade_response', playerId: string, response: 'accepted' | 'declined'
3. `TradeExecutedMessageSchema` - type: 'trade_executed', proposerId: string, partnerId: string, proposerGave: Record<ResourceType, number>, partnerGave: Record<ResourceType, number>
4. `TradeCancelledMessageSchema` - type: 'trade_cancelled'
5. `BankTradeExecutedMessageSchema` - type: 'bank_trade_executed', playerId: string, gave: Record<ResourceType, number>, received: Record<ResourceType, number>

Use existing `ResourceTypeSchema` pattern from the codebase. For Record<ResourceType, number> fields, use: `z.record(z.enum(['wood', 'brick', 'sheep', 'wheat', 'ore']), z.number())`.

Add all new schemas to the `WebSocketMessageSchema` discriminated union.

Export types for all new schemas (e.g., `export type ProposeTradeMessage = z.infer<typeof ProposeTradeMessageSchema>`).
</action>
<verify>Run `npx nx build shared` to verify no TypeScript errors</verify>
<done>All 10 trade message schemas defined with Zod, added to discriminated union, and types exported</done>
</task>

<task type="auto">
  <name>Task 2: Add ActiveTrade type to game.ts</name>
  <files>libs/shared/src/schemas/game.ts</files>
  <action>
Add an `ActiveTradeSchema` to game.ts for tracking the current trade proposal state:

```typescript
export const ActiveTradeSchema = z.object({
  proposerId: z.string(),
  offering: z.record(
    z.enum(['wood', 'brick', 'sheep', 'wheat', 'ore']),
    z.number(),
  ),
  requesting: z.record(
    z.enum(['wood', 'brick', 'sheep', 'wheat', 'ore']),
    z.number(),
  ),
  responses: z.record(z.string(), z.enum(['pending', 'accepted', 'declined'])),
});

export type ActiveTrade = z.infer<typeof ActiveTradeSchema>;
```

This schema captures:

- Who proposed the trade (proposerId)
- What they're offering (resources to give)
- What they're requesting (resources they want)
- Response status from each non-proposer player

Note: Do NOT modify GameStateSchema yet - activeTrade will be managed separately on the GameManager.
</action>
<verify>Run `npx nx build shared` to verify no TypeScript errors</verify>
<done>ActiveTrade schema and type exported from game.ts</done>
</task>

<task type="auto">
  <name>Task 3: Verify exports from shared index</name>
  <files>libs/shared/src/index.ts</files>
  <action>
Verify that all new types are properly exported from the shared library entry point.

Check that index.ts has:

- Export from './schemas/messages' (should already exist)
- Export from './schemas/game' (should already exist)

If the exports are already using `export * from './schemas/...'` pattern, new types will be automatically available. If not, add explicit exports for the new trade types.

Run the build to confirm all exports work correctly.
</action>
<verify>Run `npx nx build shared && npx nx typecheck shared` to verify exports work</verify>
<done>All trade types accessible via `import { ProposeTradeMessage, ActiveTrade, ... } from '@catan/shared'`</done>
</task>

</tasks>

<verification>
1. `npx nx build shared` completes without errors
2. `npx nx typecheck shared` passes
3. Import statements work: `import { ProposeTradeMessage, TradeExecutedMessage, ActiveTrade } from '@catan/shared'`
</verification>

<success_criteria>

- 10 trade message schemas defined in messages.ts
- ActiveTrade schema defined in game.ts
- All schemas included in WebSocketMessageSchema discriminated union
- All types exported and accessible from @catan/shared
- Build passes with no TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/06-trading/06-01-SUMMARY.md`
</output>
