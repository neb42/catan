---
phase: 06-trading
plan: 05
type: execute
wave: 3
depends_on: ['06-04']
files_modified:
  - apps/web/src/components/Trade/TradeModal.tsx
  - apps/web/src/components/Trade/DomesticTrade.tsx
  - apps/web/src/components/Trade/MaritimeTrade.tsx
  - apps/web/src/components/Trade/ResourceSelector.tsx
  - apps/web/src/components/Trade/TradeButton.tsx
autonomous: true

must_haves:
  truths:
    - 'User can open trade modal from game controls'
    - 'User can compose domestic trade offer with +/- controls'
    - 'User can switch between Players and Bank tabs'
    - 'Maritime trade shows correct rates based on port access'
  artifacts:
    - path: 'apps/web/src/components/Trade/TradeModal.tsx'
      provides: 'Main trade modal with tabs'
      min_lines: 50
    - path: 'apps/web/src/components/Trade/DomesticTrade.tsx'
      provides: 'Player-to-player trade composition'
      min_lines: 80
    - path: 'apps/web/src/components/Trade/MaritimeTrade.tsx'
      provides: 'Bank/port trade interface'
      min_lines: 60
    - path: 'apps/web/src/components/Trade/ResourceSelector.tsx'
      provides: 'Resource quantity controls'
      min_lines: 30
  key_links:
    - from: 'apps/web/src/components/Trade/TradeModal.tsx'
      to: 'apps/web/src/stores/gameStore.ts'
      via: 'useTradeModalOpen'
      pattern: 'useTradeModalOpen'
    - from: 'apps/web/src/components/Trade/MaritimeTrade.tsx'
      to: 'apps/web/src/hooks/usePortAccess.ts'
      via: 'usePortAccess hook'
      pattern: 'usePortAccess'
---

<objective>
Create the trade UI components for proposing domestic trades and executing maritime trades.

Purpose: Enable users to compose and propose trades through an intuitive modal interface.
Output: Complete trade modal with domestic and maritime trading tabs.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-trading/06-RESEARCH.md
@.planning/phases/06-trading/06-04-SUMMARY.md

@apps/web/src/components/BuildControls/BuildControls.tsx
@apps/web/src/stores/gameStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResourceSelector component</name>
  <files>apps/web/src/components/Trade/ResourceSelector.tsx</files>
  <action>
Create `apps/web/src/components/Trade/ResourceSelector.tsx` - a reusable component for selecting resource quantities:

```typescript
import { ActionIcon, Group, Text } from '@mantine/core';
import { ResourceType } from '@catan/shared';

const RESOURCE_ICONS: Record<ResourceType, string> = {
  wood: 'ü™µ',
  brick: 'üß±',
  sheep: 'üêë',
  wheat: 'üåæ',
  ore: '‚õ∞Ô∏è',
};

const RESOURCE_LABELS: Record<ResourceType, string> = {
  wood: 'Wood',
  brick: 'Brick',
  sheep: 'Sheep',
  wheat: 'Wheat',
  ore: 'Ore',
};

interface ResourceSelectorProps {
  resource: ResourceType;
  value: number;
  max: number; // Max selectable (owned amount for "give" side)
  onChange: (value: number) => void;
  rateLabel?: string; // Optional rate label like "(2:1)"
  disabled?: boolean;
}

export function ResourceSelector({
  resource,
  value,
  max,
  onChange,
  rateLabel,
  disabled = false,
}: ResourceSelectorProps) {
  return (
    <Group gap="xs" align="center">
      <Text size="lg">{RESOURCE_ICONS[resource]}</Text>
      <Text size="sm" w={50}>{RESOURCE_LABELS[resource]}</Text>
      {rateLabel && <Text size="xs" c="dimmed">{rateLabel}</Text>}

      <ActionIcon
        variant="default"
        size="sm"
        onClick={() => onChange(Math.max(0, value - 1))}
        disabled={disabled || value <= 0}
      >
        -
      </ActionIcon>

      <Text w={30} ta="center" fw={600}>{value}</Text>

      <ActionIcon
        variant="default"
        size="sm"
        onClick={() => onChange(Math.min(max, value + 1))}
        disabled={disabled || value >= max}
      >
        +
      </ActionIcon>
    </Group>
  );
}
```

  </action>
  <verify>Run `npx nx build web` to verify no TypeScript errors</verify>
  <done>ResourceSelector component created with +/- controls</done>
</task>

<task type="auto">
  <name>Task 2: Create DomesticTrade and MaritimeTrade components</name>
  <files>
    apps/web/src/components/Trade/DomesticTrade.tsx
    apps/web/src/components/Trade/MaritimeTrade.tsx
  </files>
  <action>
**Create DomesticTrade.tsx:**

Component for composing player-to-player trades:

- Two sections: "You Give" and "You Want"
- ResourceSelector for each of 5 resources in each section
- "You Give" max is player's owned resources
- "You Want" max is 99 (unlimited)
- "Propose Trade" button at bottom
- Button disabled if either side has 0 total resources
- On propose, send WebSocket message: { type: 'propose_trade', offering, requesting }
- After proposing, component shows "Waiting for responses..." state

Use useState for local offering/requesting state: `Record<ResourceType, number>` initialized to all 0s.

Import usePlayerResources from gameStore, useSocket for sending messages.

**Create MaritimeTrade.tsx:**

Component for bank/port trading:

- Use usePortAccess hook to get rates
- Show each resource with its best rate: "Wood (4:1)" or "Brick (2:1)"
- Two sections: "Give" and "Receive"
- "Give" section: ResourceSelector with rate-based max (must give in multiples of rate)
- "Receive" section: ResourceSelector with max 1 per trade
- Auto-calculate: selecting 1 of "Receive" sets required "Give" amount
- "Trade with Bank" button
- On click, send: { type: 'execute_bank_trade', giving, receiving }
- Show toast on success (use @mantine/notifications)

Use getBestRate from usePortAccess.ts for rate calculation.
</action>
<verify>Run `npx nx build web` to verify no TypeScript errors</verify>
<done>DomesticTrade and MaritimeTrade components created</done>
</task>

<task type="auto">
  <name>Task 3: Create TradeModal and TradeButton</name>
  <files>
    apps/web/src/components/Trade/TradeModal.tsx
    apps/web/src/components/Trade/TradeButton.tsx
  </files>
  <action>
**Create TradeModal.tsx:**

Main modal wrapper with tabs:

```typescript
import { Modal, Tabs } from '@mantine/core';
import { useTradeModalOpen, useTradeActions } from '../../hooks/useTradeState';
import { DomesticTrade } from './DomesticTrade';
import { MaritimeTrade } from './MaritimeTrade';

export function TradeModal() {
  const isOpen = useTradeModalOpen();
  const { setTradeModalOpen } = useTradeActions();

  return (
    <Modal
      opened={isOpen}
      onClose={() => setTradeModalOpen(false)}
      title="Trade"
      size="lg"
      centered
    >
      <Tabs defaultValue="players">
        <Tabs.List>
          <Tabs.Tab value="players">Players</Tabs.Tab>
          <Tabs.Tab value="bank">Bank</Tabs.Tab>
        </Tabs.List>

        <Tabs.Panel value="players" pt="md">
          <DomesticTrade />
        </Tabs.Panel>

        <Tabs.Panel value="bank" pt="md">
          <MaritimeTrade />
        </Tabs.Panel>
      </Tabs>
    </Modal>
  );
}
```

**Create TradeButton.tsx:**

Button to open the trade modal:

```typescript
import { Button } from '@mantine/core';
import { useTradeActions } from '../../hooks/useTradeState';
import { useIsMyTurnInMainGame } from '../../stores/gameStore';

export function TradeButton() {
  const { setTradeModalOpen } = useTradeActions();
  const isMyTurn = useIsMyTurnInMainGame();
  const turnPhase = useGameStore((state) => state.turnPhase);

  // Only show trade button during main phase of own turn
  if (turnPhase !== 'main' || !isMyTurn) {
    return null;
  }

  return (
    <Button
      variant="light"
      color="blue"
      onClick={() => setTradeModalOpen(true)}
    >
      ü§ù Trade
    </Button>
  );
}
```

Export both from an index file if desired, or import directly.
</action>
<verify>Run `npx nx build web` to verify no TypeScript errors</verify>
<done>TradeModal with tabs and TradeButton created</done>
</task>

</tasks>

<verification>
1. `npx nx build web` completes without errors
2. ResourceSelector correctly handles +/- with min/max bounds
3. DomesticTrade allows composing offers and sending proposals
4. MaritimeTrade shows correct rates and allows bank trades
5. TradeModal opens/closes correctly with tab switching
6. TradeButton only appears during player's main phase
</verification>

<success_criteria>

- Trade button visible during player's main phase
- Modal opens with Players and Bank tabs
- Resource selectors work with +/- controls
- Give side constrained to owned resources
- Port rates displayed correctly in bank tab
- Propose button disabled until valid offer composed
- WebSocket messages sent on propose/bank trade
  </success_criteria>

<output>
After completion, create `.planning/phases/06-trading/06-05-SUMMARY.md`
</output>
