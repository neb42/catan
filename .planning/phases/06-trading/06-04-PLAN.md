---
phase: 06-trading
plan: 04
type: execute
wave: 2
depends_on: ['06-01']
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/hooks/usePortAccess.ts
  - apps/web/src/hooks/useTradeState.ts
autonomous: true

must_haves:
  truths:
    - 'Trade state is tracked in gameStore'
    - 'Trade modal visibility is controlled via store'
    - "Port access hook calculates player's available trade rates"
    - 'Selector hooks prevent unnecessary re-renders'
  artifacts:
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'Trade state slice in gameStore'
      contains: 'activeTrade'
    - path: 'apps/web/src/hooks/usePortAccess.ts'
      provides: 'Port access calculation hook'
      exports: ['usePortAccess', 'getBestRate']
    - path: 'apps/web/src/hooks/useTradeState.ts'
      provides: 'Trade state selector hooks'
      exports: ['useActiveTrade', 'useTradeModalOpen']
  key_links:
    - from: 'apps/web/src/hooks/useTradeState.ts'
      to: 'apps/web/src/stores/gameStore.ts'
      via: 'useGameStore selector'
      pattern: 'useGameStore.*activeTrade'
---

<objective>
Add trade state management to the frontend including store slice, port access calculation, and selector hooks.

Purpose: Enable frontend to track trade proposals, responses, and calculate port access for maritime trading.
Output: Complete trade state infrastructure ready for UI components.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-trading/06-RESEARCH.md
@.planning/phases/06-trading/06-01-SUMMARY.md

@apps/web/src/stores/gameStore.ts
@libs/shared/src/utils/hexGeometry.ts
@libs/shared/src/schemas/board.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trade slice to gameStore</name>
  <files>apps/web/src/stores/gameStore.ts</files>
  <action>
Add trade state slice to the existing gameStore:

**Add interface TradeSlice:**

```typescript
interface TradeSlice {
  // Active trade proposal (null if none)
  activeTrade: {
    proposerId: string;
    offering: Record<ResourceType, number>;
    requesting: Record<ResourceType, number>;
    responses: Record<string, 'pending' | 'accepted' | 'declined'>;
  } | null;

  // UI state
  tradeModalOpen: boolean;
}
```

**Extend GameStore interface** to include TradeSlice.

**Add initial state:**

```typescript
activeTrade: null,
tradeModalOpen: false,
```

**Add actions:**

```typescript
setActiveTrade: (trade: TradeSlice['activeTrade']) => void;
updateTradeResponse: (playerId: string, response: 'accepted' | 'declined') => void;
clearTrade: () => void;
setTradeModalOpen: (open: boolean) => void;
```

**Implement actions:**

- setActiveTrade: `set({ activeTrade: trade })`
- updateTradeResponse: `set((state) => ({ activeTrade: state.activeTrade ? { ...state.activeTrade, responses: { ...state.activeTrade.responses, [playerId]: response } } : null }))`
- clearTrade: `set({ activeTrade: null })`
- setTradeModalOpen: `set({ tradeModalOpen: open })`

Import ResourceType from @catan/shared if not already imported.
</action>
<verify>Run `npx nx build web` to verify no TypeScript errors</verify>
<done>Trade slice added to gameStore with all actions</done>
</task>

<task type="auto">
  <name>Task 2: Create port access hook</name>
  <files>apps/web/src/hooks/usePortAccess.ts</files>
  <action>
Create `apps/web/src/hooks/usePortAccess.ts` to calculate player's port access for maritime trading:

```typescript
import { useMemo } from 'react';
import { ResourceType, Port } from '@catan/shared';
import { useGameStore, useSettlements } from '../stores/gameStore';
import { getVertexFromCorner } from '@catan/shared';

export interface PortAccess {
  hasGeneric3to1: boolean;
  specificPorts: ResourceType[]; // 2:1 ports player has access to
}

/**
 * Gets the two vertex IDs that a port connects to.
 * Port is on edge of hex, which connects corners i and (i+1)%6.
 */
function getPortVertexIds(
  port: Port,
  size = { x: 10, y: 10 },
): [string, string] {
  const hex = { q: port.hexQ, r: port.hexR };
  const v1 = getVertexFromCorner(hex, port.edge, size);
  const v2 = getVertexFromCorner(hex, (port.edge + 1) % 6, size);
  return [v1.id, v2.id];
}

export function usePortAccess(): PortAccess {
  const board = useGameStore((state) => state.board);
  const settlements = useSettlements();
  const myPlayerId = useGameStore((state) => state.myPlayerId);

  return useMemo(() => {
    const access: PortAccess = {
      hasGeneric3to1: false,
      specificPorts: [],
    };

    if (!board || !myPlayerId) return access;

    // Get all vertex IDs where player has settlements/cities
    const mySettlements = settlements.filter((s) => s.playerId === myPlayerId);
    const myVertexIds = new Set(mySettlements.map((s) => s.vertexId));

    // Check each port
    for (const port of board.ports) {
      const [v1, v2] = getPortVertexIds(port);
      const hasAccess = myVertexIds.has(v1) || myVertexIds.has(v2);

      if (hasAccess) {
        if (port.type === 'generic') {
          access.hasGeneric3to1 = true;
        } else {
          access.specificPorts.push(port.type as ResourceType);
        }
      }
    }

    return access;
  }, [board, settlements, myPlayerId]);
}

export function getBestRate(
  resource: ResourceType,
  portAccess: PortAccess,
): number {
  if (portAccess.specificPorts.includes(resource)) return 2;
  if (portAccess.hasGeneric3to1) return 3;
  return 4;
}
```

Make sure to export getVertexFromCorner from @catan/shared if not already exported.
</action>
<verify>Run `npx nx build web` to verify no TypeScript errors</verify>
<done>usePortAccess hook calculates port access and getBestRate returns correct rates</done>
</task>

<task type="auto">
  <name>Task 3: Create trade state selector hooks</name>
  <files>apps/web/src/hooks/useTradeState.ts</files>
  <action>
Create `apps/web/src/hooks/useTradeState.ts` with selector hooks for trade state:

```typescript
import { useGameStore } from '../stores/gameStore';
import { useShallow } from 'zustand/react/shallow';

// Active trade selector
export const useActiveTrade = () => useGameStore((state) => state.activeTrade);

// Trade modal visibility
export const useTradeModalOpen = () =>
  useGameStore((state) => state.tradeModalOpen);

// Check if current user is the trade proposer
export const useIsTradeProposer = () =>
  useGameStore((state) => state.activeTrade?.proposerId === state.myPlayerId);

// Check if user needs to respond to a trade (not proposer, trade active, hasn't responded)
export const useNeedsToRespondToTrade = () =>
  useGameStore((state) => {
    if (!state.activeTrade) return false;
    if (state.activeTrade.proposerId === state.myPlayerId) return false;
    if (!state.myPlayerId) return false;
    const myResponse = state.activeTrade.responses[state.myPlayerId];
    return !myResponse || myResponse === 'pending';
  });

// Get list of players who have accepted the trade
export const useAcceptedTraders = () =>
  useGameStore(
    useShallow((state) => {
      if (!state.activeTrade) return [];
      return Object.entries(state.activeTrade.responses)
        .filter(([_, response]) => response === 'accepted')
        .map(([playerId]) => playerId);
    }),
  );

// Trade actions
export const useTradeActions = () =>
  useGameStore(
    useShallow((state) => ({
      setActiveTrade: state.setActiveTrade,
      updateTradeResponse: state.updateTradeResponse,
      clearTrade: state.clearTrade,
      setTradeModalOpen: state.setTradeModalOpen,
    })),
  );
```

These hooks follow the existing selector pattern to prevent unnecessary re-renders.
</action>
<verify>Run `npx nx build web` to verify no TypeScript errors</verify>
<done>Trade state selector hooks exported and working</done>
</task>

</tasks>

<verification>
1. `npx nx build web` completes without errors
2. Trade state slice properly integrated into gameStore
3. Port access calculation uses correct vertex matching
4. All selector hooks provide type-safe access to trade state
</verification>

<success_criteria>

- gameStore has activeTrade, tradeModalOpen state
- gameStore has setActiveTrade, updateTradeResponse, clearTrade, setTradeModalOpen actions
- usePortAccess returns correct port access based on settlements
- getBestRate returns 2, 3, or 4 based on port access
- Selector hooks prevent unnecessary re-renders
  </success_criteria>

<output>
After completion, create `.planning/phases/06-trading/06-04-SUMMARY.md`
</output>
