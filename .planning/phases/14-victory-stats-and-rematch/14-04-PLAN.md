---
phase: 14-victory-stats-and-rematch
plan: 04
type: execute
wave: 2
depends_on: [14-01, 14-02]
files_modified:
  - apps/web/src/components/Victory/VictoryModal.tsx
  - apps/web/src/components/Victory/ResultsBreakdown.tsx
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/Lobby.tsx
autonomous: true

must_haves:
  truths:
    - 'Victory modal displays statistics tabs after winner announcement'
    - 'Results breakdown shows all players ranked by score'
    - 'Winner has visual distinction (trophy, emphasized card, gold styling)'
    - 'VP breakdown shows detailed point sources per player'
  artifacts:
    - path: 'apps/web/src/components/Victory/VictoryModal.tsx'
      provides: 'Enhanced modal with statistics'
      contains: 'StatisticsTabs'
    - path: 'apps/web/src/components/Victory/ResultsBreakdown.tsx'
      provides: 'Improved results display'
      min_lines: 100
      exports: ['ResultsBreakdown']
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'Statistics state'
      contains: 'gameStats'
  key_links:
    - from: 'apps/web/src/components/Victory/VictoryModal.tsx'
      to: 'StatisticsTabs'
      via: 'import and render'
      pattern: 'import.*StatisticsTabs'
    - from: 'apps/web/src/components/Victory/ResultsBreakdown.tsx'
      to: 'gameStats from store'
      via: 'useGameStore selector'
      pattern: 'useGameStore.*gameStats'
    - from: 'apps/web/src/components/Lobby.tsx'
      to: 'victory WebSocket handler'
      via: 'setGameStats call'
      pattern: "setGameStats\\(.*stats"
---

<objective>
Integrate statistics display into VictoryModal and enhance results breakdown with detailed VP information and winner emphasis.

Purpose: Show post-game insights with comprehensive statistics, improve visual hierarchy to clearly communicate winner and rankings.

Output: Enhanced VictoryModal with statistics tabs, improved ResultsBreakdown component with card-based layout and winner distinction.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-victory-stats-and-rematch/14-CONTEXT.md
@.planning/phases/14-victory-stats-and-rematch/14-RESEARCH.md

# Phase 14 dependencies

@.planning/phases/14-victory-stats-and-rematch/14-01-SUMMARY.md
@.planning/phases/14-victory-stats-and-rematch/14-02-SUMMARY.md

# Existing victory components

@apps/web/src/components/Victory/VictoryModal.tsx
@apps/web/src/stores/gameStore.ts
@apps/web/src/components/Lobby.tsx
</context>

<tasks>

<task type="auto">
  <name>Add gameStats to store and WebSocket handler</name>
  <files>
    apps/web/src/stores/gameStore.ts
    apps/web/src/components/Lobby.tsx
  </files>
  <action>
**gameStore.ts:**
Add to store state interface:
```typescript
gameStats: GameStats | null;
```

Add setter:

```typescript
setGameStats: (stats: GameStats | null) => set({ gameStats: stats }),
```

Add selector hook:

```typescript
export const useGameStats = () => useGameStore((s) => s.gameStats);
```

Initialize as null in initial state.

**Lobby.tsx:**
Locate the WebSocket message handler for 'victory' message (should be in useEffect with ws.onmessage).

Add to victory handler:

```typescript
if (parsed.type === 'victory') {
  // ... existing victory handling ...
  setGameStats(parsed.stats);
}
```

Import GameStats type from @catan/shared.
</action>
<verify>
npx nx typecheck web
rg "gameStats.*GameStats" apps/web/src/stores/gameStore.ts confirms state field
rg "setGameStats.*stats" apps/web/src/components/Lobby.tsx confirms handler integration
</verify>
<done>
gameStats field exists in store with setter. Victory WebSocket handler stores stats. Selector hook exported.
</done>
</task>

<task type="auto">
  <name>Create ResultsBreakdown component with enhanced styling</name>
  <files>
    apps/web/src/components/Victory/ResultsBreakdown.tsx
  </files>
  <action>
Create new component that accepts `players: Player[]` and `allPlayerVP: Record<string, VPBreakdown>` props.

Sort players by total VP (descending). Winner is first player.

Render as Stack of Cards (one per player):

For each player card:

- Use Card component with padding, radius, border
- Winner card: 3px gold border (#f1c40f), slightly larger, gold background tint, crown/trophy emoji (ðŸ†) next to name
- Non-winner cards: 1px neutral border (#d7ccc8), white background
- Header: Avatar (player color) + Nickname + Winner badge (if winner) + Total VP badge
- Body: Group of small badges/text showing VP breakdown:
  - Settlements: {count} (Ã—1 VP)
  - Cities: {count} (Ã—2 VP)
  - Longest Road: 2 VP (only if > 0)
  - Largest Army: 2 VP (only if > 0)
  - VP Cards: {count} VP (only if > 0)

Use parchment text colors (#5d4037), maintain existing modal aesthetic. Per CONTEXT.md: "All visual indicators" for winner - trophy icon, emphasized card, gold styling.

Title above cards: "Final Standings" with Fraunces font.
</action>
<verify>
npx nx typecheck web
Component renders with mock data showing winner with gold styling and trophy
</verify>
<done>
ResultsBreakdown component exists, shows ranked cards with detailed VP breakdown, winner has trophy + gold styling.
</done>
</task>

<task type="auto">
  <name>Integrate statistics and ResultsBreakdown into VictoryModal</name>
  <files>
    apps/web/src/components/Victory/VictoryModal.tsx
  </files>
  <action>
Import StatisticsTabs, ResultsBreakdown, and useGameStats hook.

Restructure modal content order (per CONTEXT.md: "Winner announcement at top, then statistics tabs below"):

1. Winner announcement (existing motion.div with winner name)
2. Winner VP badge (existing)
3. **NEW: ResultsBreakdown** - Replace existing player cards iteration with ResultsBreakdown component
4. **NEW: StatisticsTabs** - Add below results, only render if gameStats is not null

Add to modal styles: `maxHeight: '80vh', overflow: 'auto'` for scrolling if statistics content is long (per CONTEXT.md: "Fixed height modal with scroll").

Pass props to new components:

- ResultsBreakdown: `players={room?.players || []}` and `allPlayerVP={allPlayerVP}`
- StatisticsTabs: `stats={gameStats}` and `players={room?.players || []}`

Maintain existing confetti, modal styling, action buttons at bottom.
</action>
<verify>
npx nx typecheck web
rg "StatisticsTabs|ResultsBreakdown" apps/web/src/components/Victory/VictoryModal.tsx confirms imports and usage
Modal renders without errors (even if stats are null)
</verify>
<done>
VictoryModal displays ResultsBreakdown and StatisticsTabs. Content order: winner â†’ results â†’ statistics â†’ buttons. Modal has scroll capability.
</done>
</task>

</tasks>

<verification>
Type check web:
```bash
npx nx typecheck web
```

Verify imports:

```bash
rg "import.*StatisticsTabs" apps/web/src/components/Victory/VictoryModal.tsx
rg "import.*ResultsBreakdown" apps/web/src/components/Victory/VictoryModal.tsx
```

Verify store integration:

```bash
rg "gameStats" apps/web/src/stores/gameStore.ts
rg "setGameStats" apps/web/src/components/Lobby.tsx
```

</verification>

<success_criteria>

1. **Store integration complete** â€” gameStats field in store, set by victory WebSocket handler
2. **ResultsBreakdown displays rankings** â€” Card-based layout, detailed VP breakdown, winner distinction clear
3. **StatisticsTabs integrated** â€” Renders below results in VictoryModal, shows all three tabs
4. **Modal scrollable** â€” Can view all content even if statistics are extensive
   </success_criteria>

<output>
After completion, create `.planning/phases/14-victory-stats-and-rematch/14-04-SUMMARY.md` following summary template guidelines.
</output>
