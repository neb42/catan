---
phase: 14-victory-stats-and-rematch
plan: 05
type: execute
wave: 2
depends_on: [14-03]
files_modified:
  - apps/web/src/components/Victory/VictoryModal.tsx
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/Lobby.tsx
autonomous: true

must_haves:
  truths:
    - 'Rematch button appears in VictoryModal'
    - 'Clicking rematch shows ready count (X/Y players ready)'
    - 'All players voting triggers game reset'
    - 'Game resets to lobby with new board and cleared state'
  artifacts:
    - path: 'apps/web/src/components/Victory/VictoryModal.tsx'
      provides: 'Rematch button and ready display'
      contains: 'request_rematch'
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'Rematch state tracking'
      contains: 'rematchReadyPlayers'
    - path: 'apps/web/src/components/Lobby.tsx'
      provides: 'Rematch WebSocket handlers'
      contains: 'rematch_update'
  key_links:
    - from: 'apps/web/src/components/Victory/VictoryModal.tsx'
      to: 'WebSocket request_rematch'
      via: 'send message'
      pattern: 'type.*request_rematch'
    - from: 'apps/web/src/components/Lobby.tsx'
      to: 'setRematchReadyPlayers'
      via: 'rematch_update handler'
      pattern: 'setRematchReadyPlayers'
    - from: 'apps/web/src/components/Lobby.tsx'
      to: 'game reset'
      via: 'game_reset handler'
      pattern: 'game_reset'
---

<objective>
Add rematch button to VictoryModal with voting UI and integrate WebSocket handlers for rematch flow.

Purpose: Enable players to start a new game after victory without leaving the party. Shows transparent voting progress and triggers seamless transition to new game.

Output: Rematch button in modal, ready count display, WebSocket integration for unanimous voting and game reset.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-victory-stats-and-rematch/14-CONTEXT.md
@.planning/phases/14-victory-stats-and-rematch/14-RESEARCH.md

# Phase 14 dependency

@.planning/phases/14-victory-stats-and-rematch/14-03-SUMMARY.md

# Existing components

@apps/web/src/components/Victory/VictoryModal.tsx
@apps/web/src/stores/gameStore.ts
@apps/web/src/components/Lobby.tsx
</context>

<tasks>

<task type="auto">
  <name>Add rematch state to store</name>
  <files>
    apps/web/src/stores/gameStore.ts
  </files>
  <action>
Add to store state:
```typescript
rematchReadyPlayers: string[]; // Array of player IDs who voted for rematch
rematchReadyCount: number;
rematchTotalPlayers: number;
```

Add setters:

```typescript
setRematchState: (readyPlayers: string[], readyCount: number, totalPlayers: number) =>
  set({
    rematchReadyPlayers: readyPlayers,
    rematchReadyCount: readyCount,
    rematchTotalPlayers: totalPlayers
  }),
clearRematchState: () =>
  set({
    rematchReadyPlayers: [],
    rematchReadyCount: 0,
    rematchTotalPlayers: 0
  }),
```

Add selector hook:

```typescript
export const useRematchState = () =>
  useGameStore((s) => ({
    readyPlayers: s.rematchReadyPlayers,
    readyCount: s.rematchReadyCount,
    totalPlayers: s.rematchTotalPlayers,
  }));
```

Initialize all three fields as 0/empty array in initial state.
</action>
<verify>
npx nx typecheck web
rg "rematchReadyPlayers|setRematchState" apps/web/src/stores/gameStore.ts confirms state and setters
</verify>
<done>
Rematch state fields exist in store with setters and selector hook.
</done>
</task>

<task type="auto">
  <name>Add rematch WebSocket handlers</name>
  <files>
    apps/web/src/components/Lobby.tsx
  </files>
  <action>
In the WebSocket message handler (useEffect with ws.onmessage), add two new cases:

**rematch_update handler:**

```typescript
if (parsed.type === 'rematch_update') {
  setRematchState(parsed.readyPlayers, parsed.readyCount, parsed.totalPlayers);
}
```

**game_reset handler:**

```typescript
if (parsed.type === 'game_reset') {
  // Clear victory and rematch state
  setVictoryPhase('none');
  clearRematchState();
  setGameStats(null);

  // Reset to lobby/placement state
  // The game_reset message includes new board
  // Trigger the same flow as game_started
  setBoard(parsed.board);
  setGamePhase('placement');

  // Toast notification
  showGameNotification({
    message: 'New game starting!',
    color: 'green',
    autoClose: 3000,
  });
}
```

Import clearRematchState, setBoard, setGamePhase from store. Import showGameNotification from notifications.
</action>
<verify>
npx nx typecheck web
rg "rematch_update|game_reset" apps/web/src/components/Lobby.tsx confirms both handlers
</verify>
<done>
rematch_update handler sets rematch state. game_reset handler clears victory state, loads new board, shows notification.
</done>
</task>

<task type="auto">
  <name>Add rematch button and ready display to VictoryModal</name>
  <files>
    apps/web/src/components/Victory/VictoryModal.tsx
  </files>
  <action>
Import useRematchState hook and useWebSocket hook (to get ws instance).

Add state for local player's rematch vote:

```typescript
const [hasVotedRematch, setHasVotedRematch] = useState(false);
const { readyPlayers, readyCount, totalPlayers } = useRematchState();
const myPlayerId = useGameStore((s) => s.myPlayerId); // Assuming this exists
```

Add rematch button click handler:

```typescript
const handleRematch = () => {
  if (hasVotedRematch || !ws) return;

  ws.send(
    JSON.stringify({
      type: 'request_rematch',
      playerId: myPlayerId,
    }),
  );

  setHasVotedRematch(true);
};
```

Update action buttons section (replace "Return to Lobby" button):

```tsx
<Stack w="100%" gap="xs">
  {/* Ready count display */}
  {readyCount > 0 && (
    <Text size="sm" ta="center" c="#5d4037">
      Ready for rematch: {readyCount}/{totalPlayers} players
    </Text>
  )}

  <Group gap="md" justify="center">
    <Button
      variant="outline"
      onClick={handleClose}
      styles={{...}} // Keep existing styles
    >
      View Board
    </Button>

    <Button
      onClick={handleRematch}
      disabled={hasVotedRematch}
      styles={{
        root: {
          background: hasVotedRematch ? '#ccc' : '#8d6e63',
          color: '#fdf6e3',
          '&:hover': {
            background: hasVotedRematch ? '#ccc' : '#6d4c41',
          },
        },
      }}
    >
      {hasVotedRematch ? 'Waiting for others...' : 'Rematch'}
    </Button>
  </Group>

  {/* Optional: Show checkmarks next to player names who voted */}
  {readyCount > 0 && room?.players && (
    <Stack gap={4}>
      {room.players.map(p => (
        <Group key={p.id} gap="xs" justify="center">
          <Text size="xs" c="#5d4037">{p.nickname}</Text>
          {readyPlayers.includes(p.id) && <Text size="xs">✓</Text>}
        </Group>
      ))}
    </Stack>
  )}
</Stack>
```

Per CONTEXT.md: "Show ready count with checkmarks next to player names."
</action>
<verify>
npx nx typecheck web
rg "request_rematch|handleRematch" apps/web/src/components/Victory/VictoryModal.tsx confirms button and handler
rg "readyCount.\*readyPlayers" apps/web/src/components/Victory/VictoryModal.tsx confirms display
</verify>
<done>
Rematch button exists in VictoryModal, sends request_rematch message. Ready count displays with player checkmarks. Button disabled after vote.
</done>
</task>

</tasks>

<verification>
Type check web:
```bash
npx nx typecheck web
```

Verify store integration:

```bash
rg "rematchReadyPlayers|setRematchState|clearRematchState" apps/web/src/stores/gameStore.ts
```

Verify WebSocket handlers:

```bash
rg "rematch_update|game_reset" apps/web/src/components/Lobby.tsx
```

Verify VictoryModal rematch UI:

```bash
rg "handleRematch|request_rematch|readyCount" apps/web/src/components/Victory/VictoryModal.tsx
```

</verification>

<success_criteria>

1. **Rematch state tracked** — Store has rematch ready players, count, and total
2. **WebSocket handlers work** — rematch_update sets state, game_reset triggers new game
3. **Rematch UI integrated** — Button in modal, ready count displays, player checkmarks show votes
4. **Flow complete** — Vote → broadcast → unanimous → reset → new board → lobby state
   </success_criteria>

<output>
After completion, create `.planning/phases/14-victory-stats-and-rematch/14-05-SUMMARY.md` following summary template guidelines.
</output>
