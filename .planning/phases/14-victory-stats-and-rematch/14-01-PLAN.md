---
phase: 14-victory-stats-and-rematch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/game/GameStats.ts
  - apps/api/src/game/GameManager.ts
  - libs/shared/src/schemas/messages.ts
  - libs/shared/src/schemas/game.ts
  - apps/api/src/handlers/game-handlers.ts
autonomous: true

must_haves:
  truths:
    - 'Dice rolls are tracked throughout the game'
    - 'Resource gains, spends, and trades are tracked per player'
    - 'Development cards drawn are tracked per player'
    - 'Statistics are included in victory message'
  artifacts:
    - path: 'apps/api/src/game/GameStats.ts'
      provides: 'Statistics accumulation class'
      min_lines: 150
      exports: ['GameStats']
    - path: 'libs/shared/src/schemas/game.ts'
      provides: 'Statistics payload types'
      contains: 'GameStatsSchema'
    - path: 'libs/shared/src/schemas/messages.ts'
      provides: 'Victory message with stats'
      contains: 'stats:'
  key_links:
    - from: 'apps/api/src/game/GameManager.ts'
      to: 'GameStats'
      via: 'instantiation in constructor'
      pattern: "new GameStats\\(\\)"
    - from: 'apps/api/src/game/GameManager.ts'
      to: 'GameStats.recordRoll'
      via: 'called in rollDice method'
      pattern: "this\\.stats\\.recordRoll"
    - from: 'apps/api/src/game/GameManager.ts'
      to: 'GameStats.getStats'
      via: 'called in victory detection'
      pattern: "this\\.stats\\.getStats\\(\\)"
    - from: 'apps/api/src/handlers/game-handlers.ts'
      to: 'victory broadcast with stats'
      via: 'VictoryResult.stats included in WebSocket message'
      pattern: "stats.*victoryResult\\.stats"
---

<objective>
Create server-side game statistics tracking that accumulates dice rolls, resource flows, and development cards throughout gameplay.

Purpose: Provides data foundation for post-game statistics display in victory modal. Server-side tracking ensures data integrity across disconnections and prevents client manipulation.

Output: GameStats class integrated into GameManager, recording all game events and providing statistics payload on victory.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-victory-stats-and-rematch/14-CONTEXT.md
@.planning/phases/14-victory-stats-and-rematch/14-RESEARCH.md

# Existing game logic

@apps/api/src/game/GameManager.ts
@libs/shared/src/schemas/messages.ts
@libs/shared/src/schemas/game.ts
</context>

<tasks>

<task type="auto">
  <name>Create GameStats class and statistics schemas</name>
  <files>
    apps/api/src/game/GameStats.ts
    libs/shared/src/schemas/game.ts
  </files>
  <action>
Create `GameStats.ts` with a class that tracks:
- Dice rolls: `Record<number, number>` (2-12 frequency count)
- Resource stats per player: `Record<string, { gained: Record<ResourceType, number>, spent: Record<ResourceType, number>, traded: Record<ResourceType, number> }>`
- Dev cards per player: `Record<string, DevelopmentCardType[]>`

Methods:

- `recordRoll(total: number)`: Increment dice roll frequency
- `recordResourceGain(playerId: string, resources: Record<ResourceType, number>)`: Track resources gained from dice/bank
- `recordResourceSpend(playerId: string, resources: Record<ResourceType, number>)`: Track resources spent on building/cards
- `recordResourceTrade(from: string, to: string, given: Record<ResourceType, number>, received: Record<ResourceType, number>)`: Track net trade flow (add to trader's "traded", subtract from partner's "traded")
- `recordDevCard(playerId: string, card: DevelopmentCardType)`: Add card to player's drawn cards list
- `getStats()`: Return complete statistics payload

In `libs/shared/src/schemas/game.ts`, add:

- `ResourceStatsSchema = z.object({ gained: z.record(...), spent: z.record(...), traded: z.record(...) })`
- `GameStatsSchema = z.object({ diceRolls: z.record(...), resourceStats: z.record(...), devCardStats: z.record(...) })`
- Export `type GameStats = z.infer<typeof GameStatsSchema>`

Initialize all resource types to 0 for consistent structure. Per RESEARCH.md pitfall 1: Separate "gained" (from board/bank) from "traded" (net flow) to avoid inflating production numbers.
</action>
<verify>
npx nx typecheck api
Test instantiation: `const stats = new GameStats(); stats.recordRoll(7); console.log(stats.getStats())`
</verify>
<done>
GameStats class exists with all record methods. GameStatsSchema defined in shared library. TypeScript compilation succeeds.
</done>
</task>

<task type="auto">
  <name>Integrate GameStats into GameManager</name>
  <files>
    apps/api/src/game/GameManager.ts
  </files>
  <action>
Add `private stats: GameStats` field to GameManager class. Initialize in constructor: `this.stats = new GameStats()`.

Integrate recording calls at these points:

1. `rollDice()`: After generating dice total, call `this.stats.recordRoll(diceTotal)`
2. `distributeResources()`: After granting resources to players, call `this.stats.recordResourceGain(playerId, resources)` for each player
3. `buildRoad()`, `buildSettlement()`, `buildCity()`: After deducting costs, call `this.stats.recordResourceSpend(playerId, cost)`
4. `executeTrade()`: After trade executes, call `this.stats.recordResourceTrade(from, to, given, received)`
5. `executeBankTrade()`: After bank trade, call `this.stats.recordResourceSpend(playerId, given)` and `this.stats.recordResourceGain(playerId, received)`
6. `buyDevCard()`: After drawing card, call `this.stats.recordDevCard(playerId, card)` (use private card type, not public message)

In `checkForVictory()` method: Include stats in victory result. Modify return to include `stats: this.stats.getStats()`.

Note: Stats flow from GameManager → victory-logic.ts VictoryResult → game-handlers.ts (which calls checkForVictory) → WebSocket broadcast of victory message with stats field to all clients.
</action>
<verify>
npx nx typecheck api
Grep for all integration points: `rg "this\.stats\.(record|getStats)" apps/api/src/game/GameManager.ts` should show 7+ calls
Verify victory handler receives stats: Check game-handlers.ts victory broadcast includes stats from VictoryResult
</verify>
<done>
GameManager instantiates GameStats, records events at all 6+ integration points, includes stats in victory detection. Victory result flows through handlers to WebSocket broadcast.
</done>
</task>

<task type="auto">
  <name>Add statistics to victory message schema and handler broadcast</name>
  <files>
    libs/shared/src/schemas/messages.ts
    apps/api/src/handlers/game-handlers.ts
  </files>
  <action>
**messages.ts:**
Locate `VictoryMessageSchema` (currently contains winnerId, winnerNickname, winnerVP, allPlayerVP).

Add field: `stats: GameStatsSchema`.

Update victory-logic.ts if VictoryResult type needs stats field (add `stats: GameStats` to return type).

**game-handlers.ts:**
Locate the victory detection handler (where checkForVictory is called).

Ensure the victory WebSocket broadcast includes stats from the VictoryResult:

```typescript
const victoryResult = gameManager.checkForVictory();
if (victoryResult) {
  broadcastToRoom(roomId, {
    type: 'victory',
    winnerId: victoryResult.winnerId,
    winnerNickname: victoryResult.winnerNickname,
    winnerVP: victoryResult.winnerVP,
    allPlayerVP: victoryResult.allPlayerVP,
    stats: victoryResult.stats, // Include stats from GameManager
  });
}
```

This completes the flow: GameManager.checkForVictory() returns stats → handler broadcasts stats → clients receive stats in victory message.
</action>
<verify>
npx nx typecheck shared
Grep for schema: `rg "stats.*GameStatsSchema" libs/shared/src/schemas/messages.ts` confirms addition
</verify>
<done>
VictoryMessageSchema includes stats field. victory-logic.ts VictoryResult includes stats. TypeScript compilation succeeds.
</done>
</task>

</tasks>

<verification>
Run type checking across all affected packages:
```bash
npx nx typecheck shared
npx nx typecheck api
```

Verify GameStats methods exist:

```bash
rg "recordRoll|recordResourceGain|recordResourceSpend|recordResourceTrade|recordDevCard|getStats" apps/api/src/game/GameStats.ts
```

Verify integration in GameManager:

```bash
rg "this\.stats\." apps/api/src/game/GameManager.ts
```

</verification>

<success_criteria>

1. **GameStats class fully implemented** — All record methods exist, getStats returns complete payload
2. **GameManager integration complete** — Stats instance created, all 6+ game events recorded
3. **Victory message includes stats** — VictoryMessageSchema has stats field, checkForVictory returns stats
4. **Type safety maintained** — All type checking passes, no TypeScript errors
   </success_criteria>

<output>
After completion, create `.planning/phases/14-victory-stats-and-rematch/14-01-SUMMARY.md` following summary template guidelines.
</output>
