# 11-06-PLAN: Block Actions After Victory + Modal Reopen

## Gap

Actions still possible after victory, cannot return to victory screen after dismissing modal.

## Root Cause

1. **Backend:** GameManager has `gameEnded` guard on 7 methods but 16 action methods are missing the guard
2. **Frontend:** VictoryModal uses local `useState(true)` for visibility instead of store state; no mechanism to reopen after closing

## Requirements

- SCORE-10: Game ends and announces winner when 10 VP reached (implies no further actions possible)
- Test 8: "After a player wins, no further gameplay actions are possible (building, trading, rolling, etc.) - the game is truly ended"

## Changes

### 1. Backend: Add gameEnded Guards to All Action Methods

**File:** `apps/api/src/game/GameManager.ts`

Add `if (this.gameEnded) return { success: false, error: 'Game has ended' }` guard at the start of these 16 methods that are currently missing it:

| Method                 | Line  | Notes         |
| ---------------------- | ----- | ------------- |
| `rollDice`             | ~422  | Missing guard |
| `endTurn`              | ~515  | Missing guard |
| `proposeTrade`         | ~876  | Missing guard |
| `respondToTrade`       | ~935  | Missing guard |
| `selectTradePartner`   | ~991  | Missing guard |
| `cancelTrade`          | ~1055 | Missing guard |
| `executeBankTrade`     | ~1071 | Missing guard |
| `submitDiscard`        | ~1154 | Missing guard |
| `moveRobber`           | ~1204 | Missing guard |
| `stealFrom`            | ~1272 | Missing guard |
| `buyDevCard`           | ~1484 | Missing guard |
| `playYearOfPlenty`     | ~1549 | Missing guard |
| `completeYearOfPlenty` | ~1626 | Missing guard |
| `playMonopoly`         | ~1655 | Missing guard |
| `completeMonopoly`     | ~1721 | Missing guard |
| `playRoadBuilding`     | ~1768 | Missing guard |

Methods that already have the guard (no changes needed):

- `placeSettlement` (line 170)
- `placeRoad` (line 310)
- `buildRoad` (line 654)
- `buildSettlement` (line 731)
- `buildCity` (line 809)
- `playKnight` (line 1417)
- `placeRoadBuildingRoad` (line 1865)

Pattern to add at the start of each method body:

```typescript
if (this.gameEnded) {
  return { success: false, error: 'Game has ended' };
}
```

### 2. Frontend: Update Victory State Type for Dismissed Phase

**File:** `apps/web/src/stores/gameStore.ts`

Change VictorySlice interface (line 155):

```typescript
// Before:
victoryPhase: 'none' | 'reveal' | 'modal';

// After:
victoryPhase: 'none' | 'reveal' | 'modal' | 'dismissed';
```

Also update `setVictoryPhase` signature (line ~328) to include 'dismissed' in allowed values:

```typescript
// Before:
setVictoryPhase: (phase: 'none' | 'reveal' | 'modal') => void;

// After:
setVictoryPhase: (phase: 'none' | 'reveal' | 'modal' | 'dismissed') => void;
```

### 3. Frontend: Update VictoryModal to Use Store State

**File:** `apps/web/src/components/Victory/VictoryModal.tsx`

Changes:

1. Remove local `useState(true)` for `modalOpen`
2. Import `useGameStore` for `setVictoryPhase` action
3. Derive modal visibility from `victoryPhase === 'modal'`
4. Change `handleClose` to call `setVictoryPhase('dismissed')` instead of local state

```typescript
// Before:
const [modalOpen, setModalOpen] = useState(true);
const handleClose = () => setModalOpen(false);

// After:
const setVictoryPhase = useGameStore((s) => s.setVictoryPhase);
// victoryPhase is already in useVictoryState hook
const modalOpen = victoryPhase === 'modal';
const handleClose = () => setVictoryPhase('dismissed');
```

### 4. Frontend: Add "Show Results" Button When Modal Dismissed

**File:** `apps/web/src/components/Game.tsx`

Add a button that appears when `gameEnded && victoryPhase === 'dismissed'` to reopen the victory modal:

```tsx
{
  /* Show Results button when modal has been dismissed */
}
{
  gameEnded && victoryPhase === 'dismissed' && (
    <div
      style={{
        position: 'absolute',
        top: 16,
        left: '50%',
        transform: 'translateX(-50%)',
        zIndex: 30,
      }}
    >
      <Button color="yellow" size="lg" onClick={() => setVictoryPhase('modal')}>
        üèÜ Show Results
      </Button>
    </div>
  );
}
```

Need to:

1. Import `Button` from `@mantine/core`
2. Add `setVictoryPhase` to store access
3. Add the conditional rendering block

## Verification

1. **Backend guards:** Start a game, trigger victory, attempt each action type (roll dice, end turn, trade, build, etc.) - all should fail with "Game has ended" error
2. **Modal dismiss:** Click "View Board" in victory modal - modal closes, board is visible with dismissed state
3. **Modal reopen:** Click "Show Results" button - victory modal reopens with confetti
4. **Return to Lobby:** Click "Return to Lobby" - navigates away from game

## Test Commands

```bash
# Run existing tests to ensure no regressions
cd apps/api && pnpm test

# Manual testing required:
# 1. Play a full game to victory (or use debug tools to trigger)
# 2. Verify victory modal appears
# 3. Click "View Board" - verify modal closes
# 4. Verify "Show Results" button appears at top
# 5. Click "Show Results" - verify modal reopens
# 6. Open browser console, attempt to send action messages - verify they fail
```

## Files Changed

| File                                               | Change                                        |
| -------------------------------------------------- | --------------------------------------------- |
| `apps/api/src/game/GameManager.ts`                 | Add gameEnded guard to 16 action methods      |
| `apps/web/src/stores/gameStore.ts`                 | Add 'dismissed' to victoryPhase type          |
| `apps/web/src/components/Victory/VictoryModal.tsx` | Use store state instead of local useState     |
| `apps/web/src/components/Game.tsx`                 | Add "Show Results" button for dismissed state |
