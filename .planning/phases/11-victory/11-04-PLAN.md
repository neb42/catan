---
phase: 11-victory
plan: 04
type: execute
wave: 3
depends_on: ['11-02', '11-03']
files_modified:
  - apps/web/package.json
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/Lobby.tsx
  - apps/web/src/components/Victory/VPRevealOverlay.tsx
  - apps/web/src/components/Victory/VictoryModal.tsx
  - apps/web/src/components/Victory/index.ts
  - apps/web/src/components/Game.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - 'Game ends and announces winner when 10 VP reached'
    - 'Hidden VP cards reveal before victory modal'
    - 'Victory modal shows confetti celebration'
  artifacts:
    - path: 'apps/web/src/components/Victory/VPRevealOverlay.tsx'
      provides: 'Brief overlay showing VP card reveal'
      min_lines: 30
    - path: 'apps/web/src/components/Victory/VictoryModal.tsx'
      provides: 'Winner announcement with confetti'
      min_lines: 50
    - path: 'apps/web/src/components/Lobby.tsx'
      provides: 'victory message handler'
      contains: 'victory'
  key_links:
    - from: 'Game.tsx'
      to: 'Victory components'
      via: 'conditional render when gameEnded'
      pattern: 'gameEnded.*VictoryModal|VPRevealOverlay'
    - from: 'Lobby.tsx'
      to: 'gameStore victory actions'
      via: 'setVictoryState on victory message'
      pattern: 'setVictoryState'
---

<objective>
Create victory announcement UI with reveal overlay and confetti celebration.

Purpose: Deliver the dramatic "and the winner is..." moment per CONTEXT.md, with VP card reveal followed by celebratory victory modal.
Output: Complete victory UI flow from reveal overlay auto-transitioning to victory modal with confetti effects.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-victory/11-02-SUMMARY.md
@.planning/phases/11-victory/11-03-SUMMARY.md
@.planning/phases/11-victory/11-CONTEXT.md
@.planning/phases/11-victory/11-RESEARCH.md

# Key files

@apps/web/src/components/Lobby.tsx
@apps/web/src/components/Game.tsx
@apps/web/src/stores/gameStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-canvas-confetti and add victory state</name>
  <files>
    apps/web/package.json
    apps/web/src/stores/gameStore.ts
  </files>
  <action>
**Install confetti library:**
```bash
npm install react-canvas-confetti --workspace=apps/web
```

**Expand VictorySlice in gameStore.ts:**

```typescript
interface VictorySlice {
  gameEnded: boolean;
  winnerId: string | null;
  winnerNickname: string | null;
  winnerVP: {
    settlements: number;
    cities: number;
    longestRoad: number;
    largestArmy: number;
    victoryPointCards: number;
    total: number;
  } | null;
  allPlayerVP: Record<
    string,
    {
      settlements: number;
      cities: number;
      longestRoad: number;
      largestArmy: number;
      victoryPointCards: number;
      total: number;
    }
  >;
  revealedVPCards: Array<{ playerId: string; cardCount: number }>;
  victoryPhase: 'none' | 'reveal' | 'modal'; // Track animation phase
}
```

Add initial state:

```typescript
gameEnded: false,
winnerId: null,
winnerNickname: null,
winnerVP: null,
allPlayerVP: {},
revealedVPCards: [],
victoryPhase: 'none',
```

Add actions:

```typescript
setVictoryState: (data: {
  winnerId: string;
  winnerNickname: string;
  winnerVP: VictorySlice['winnerVP'];
  allPlayerVP: VictorySlice['allPlayerVP'];
  revealedVPCards: VictorySlice['revealedVPCards'];
}) => void;
setVictoryPhase: (phase: 'none' | 'reveal' | 'modal') => void;
```

Implement actions:

```typescript
setVictoryState: (data) => set({
  gameEnded: true,
  winnerId: data.winnerId,
  winnerNickname: data.winnerNickname,
  winnerVP: data.winnerVP,
  allPlayerVP: data.allPlayerVP,
  revealedVPCards: data.revealedVPCards,
  victoryPhase: data.revealedVPCards.length > 0 ? 'reveal' : 'modal',
}),
setVictoryPhase: (phase) => set({ victoryPhase: phase }),
```

Add selector hooks:

```typescript
export const useGameEnded = () => useGameStore((s) => s.gameEnded);
export const useVictoryState = () =>
  useGameStore(
    useShallow((s) => ({
      winnerId: s.winnerId,
      winnerNickname: s.winnerNickname,
      winnerVP: s.winnerVP,
      allPlayerVP: s.allPlayerVP,
      revealedVPCards: s.revealedVPCards,
      victoryPhase: s.victoryPhase,
    })),
  );
```

  </action>
  <verify>npm run typecheck</verify>
  <done>react-canvas-confetti installed, VictorySlice expanded with all state for reveal/modal flow</done>
</task>

<task type="auto">
  <name>Task 2: Handle victory message in Lobby.tsx</name>
  <files>apps/web/src/components/Lobby.tsx</files>
  <action>
Add handler for victory message in the WebSocket message switch/if chain.

**Add case for 'victory' message:**

```typescript
case 'victory': {
  const victoryData = message as VictoryMessage;
  useGameStore.getState().setVictoryState({
    winnerId: victoryData.winnerId,
    winnerNickname: victoryData.winnerNickname,
    winnerVP: victoryData.winnerVP,
    allPlayerVP: victoryData.allPlayerVP,
    revealedVPCards: victoryData.revealedVPCards,
  });
  break;
}
```

Import VictoryMessage type from @catan/shared.
</action>
<verify>npm run build:web && npm run typecheck</verify>
<done>Victory message handler sets victory state in store</done>
</task>

<task type="auto">
  <name>Task 3: Create Victory components</name>
  <files>
    apps/web/src/components/Victory/VPRevealOverlay.tsx
    apps/web/src/components/Victory/VictoryModal.tsx
    apps/web/src/components/Victory/index.ts
  </files>
  <action>
Create Victory component directory with reveal overlay and victory modal.

**VPRevealOverlay.tsx:**

Per CONTEXT.md: "Dedicated reveal overlay appears BEFORE victory modal: 'Revealed: X VP cards!' Brief overlay duration (1-2 seconds), then auto-transitions to victory modal."

```tsx
import { Overlay, Stack, Text } from '@mantine/core';
import { motion } from 'motion/react';
import { useEffect } from 'react';
import { useGameStore, useVictoryState } from '../../stores/gameStore';

export function VPRevealOverlay() {
  const { revealedVPCards } = useVictoryState();
  const setVictoryPhase = useGameStore((s) => s.setVictoryPhase);

  // Calculate total VP cards revealed
  const totalCards = revealedVPCards.reduce((sum, p) => sum + p.cardCount, 0);

  // Auto-transition to modal after 1.5 seconds
  useEffect(() => {
    const timer = setTimeout(() => {
      setVictoryPhase('modal');
    }, 1500);
    return () => clearTimeout(timer);
  }, [setVictoryPhase]);

  return (
    <Overlay blur={2} color="#000" opacity={0.7} zIndex={1000}>
      <Stack align="center" justify="center" h="100vh">
        <motion.div
          initial={{ scale: 0, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          transition={{ type: 'spring', stiffness: 300, damping: 20 }}
        >
          <Text
            size="3rem"
            fw={900}
            c="white"
            ta="center"
            style={{ fontFamily: 'Fraunces, serif' }}
          >
            Revealed: {totalCards} VP Card{totalCards !== 1 ? 's' : ''}!
          </Text>
        </motion.div>
      </Stack>
    </Overlay>
  );
}
```

**VictoryModal.tsx:**

Per CONTEXT.md: "Large centered modal with board still visible (dimmed) behind. Modal shows: winner highlighted, ALL players' final VP with full component breakdown. Festive celebration effects: confetti, fireworks. Two actions: 'Close' and 'Return to Lobby'."

```tsx
import {
  Modal,
  Stack,
  Text,
  Group,
  Badge,
  Button,
  Avatar,
  Card,
} from '@mantine/core';
import { motion } from 'motion/react';
import { useEffect, useRef, useCallback } from 'react';
import Confetti from 'react-canvas-confetti';
import type { CreateTypes } from 'canvas-confetti';
import { useVictoryState, useGameStore } from '../../stores/gameStore';
import { PLAYER_COLOR_HEX } from '@catan/shared';

export function VictoryModal() {
  const { winnerId, winnerNickname, winnerVP, allPlayerVP } = useVictoryState();
  const room = useGameStore((s) => s.room);
  const refConfetti = useRef<CreateTypes | null>(null);
  const [modalOpen, setModalOpen] = useState(true);

  const getInstance = useCallback((instance: CreateTypes | null) => {
    refConfetti.current = instance;
  }, []);

  // Fire confetti/fireworks on mount
  useEffect(() => {
    const duration = 4000;
    const end = Date.now() + duration;

    const frame = () => {
      if (Date.now() < end && refConfetti.current) {
        refConfetti.current({
          particleCount: 30,
          spread: 70,
          origin: { x: Math.random(), y: Math.random() * 0.3 },
          colors: ['#E53935', '#1E88E5', '#43A047', '#FB8C00', '#FDD835'],
        });
        requestAnimationFrame(frame);
      }
    };
    frame();
  }, []);

  const handleClose = () => setModalOpen(false);
  const handleReturnToLobby = () => {
    // Navigate to home/lobby - use window.location for simplicity
    window.location.href = '/';
  };

  return (
    <>
      <Confetti
        refConfetti={getInstance}
        style={{
          position: 'fixed',
          inset: 0,
          width: '100%',
          height: '100%',
          zIndex: 1001,
        }}
      />

      <Modal
        opened={modalOpen}
        onClose={handleClose}
        centered
        size="lg"
        withCloseButton={false}
        overlayProps={{ blur: 2, opacity: 0.6 }}
        zIndex={1002}
      >
        <Stack align="center" gap="lg" p="md">
          {/* Winner announcement */}
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            transition={{ type: 'spring', stiffness: 300, damping: 25 }}
          >
            <Text
              size="2.5rem"
              fw={900}
              ta="center"
              style={{ fontFamily: 'Fraunces, serif' }}
            >
              üéâ {winnerNickname} Wins! üéâ
            </Text>
          </motion.div>

          {/* Winner VP breakdown */}
          <Badge size="xl" color="yellow" variant="filled" radius="lg">
            {winnerVP?.total} Victory Points
          </Badge>

          {/* All players VP table */}
          <Stack gap="sm" w="100%">
            <Text fw={700} ta="center">
              Final Standings
            </Text>
            {room?.players.map((player) => {
              const vp = allPlayerVP[player.id];
              const isWinner = player.id === winnerId;
              return (
                <Card
                  key={player.id}
                  padding="sm"
                  radius="md"
                  style={{
                    border: isWinner
                      ? `3px solid ${PLAYER_COLOR_HEX[player.color]}`
                      : '1px solid #EEE',
                    backgroundColor: isWinner ? '#FFF9E6' : 'white',
                  }}
                >
                  <Group justify="space-between">
                    <Group gap="xs">
                      <Avatar
                        size="sm"
                        radius="xl"
                        style={{
                          backgroundColor: PLAYER_COLOR_HEX[player.color],
                        }}
                      >
                        {player.nickname.slice(0, 2).toUpperCase()}
                      </Avatar>
                      <Text fw={isWinner ? 700 : 500}>{player.nickname}</Text>
                      {isWinner && (
                        <Badge color="yellow" size="xs">
                          WINNER
                        </Badge>
                      )}
                    </Group>
                    <Group gap={4}>
                      <Text size="sm">üè†{vp?.settlements || 0}</Text>
                      <Text size="sm">üè∞{(vp?.cities || 0) / 2}</Text>
                      {vp?.longestRoad > 0 && <Text size="sm">üõ§Ô∏è2</Text>}
                      {vp?.largestArmy > 0 && <Text size="sm">‚öîÔ∏è2</Text>}
                      {(vp?.victoryPointCards || 0) > 0 && (
                        <Text size="sm">üìú{vp.victoryPointCards}</Text>
                      )}
                      <Badge color="yellow" variant="light">
                        {vp?.total} VP
                      </Badge>
                    </Group>
                  </Group>
                </Card>
              );
            })}
          </Stack>

          {/* Action buttons */}
          <Group gap="md">
            <Button variant="light" onClick={handleClose}>
              View Board
            </Button>
            <Button color="teal" onClick={handleReturnToLobby}>
              Return to Lobby
            </Button>
          </Group>
        </Stack>
      </Modal>
    </>
  );
}
```

**index.ts:**

```typescript
export { VPRevealOverlay } from './VPRevealOverlay';
export { VictoryModal } from './VictoryModal';
```

Add missing import statement `import { useState } from 'react';` to VictoryModal.
</action>
<verify>npm run build:web && npm run typecheck</verify>
<done>Victory components created with reveal overlay, confetti modal, and action buttons</done>
</task>

<task type="auto">
  <name>Task 4: Integrate Victory components into Game.tsx</name>
  <files>apps/web/src/components/Game.tsx</files>
  <action>
Add conditional rendering of victory components based on game state.

**Import components:**

```typescript
import { VPRevealOverlay, VictoryModal } from './Victory';
import { useGameEnded, useVictoryState } from '../stores/gameStore';
```

**Add in component:**

```typescript
const gameEnded = useGameEnded();
const { victoryPhase } = useVictoryState();
```

**Render victory components at end of Game component, before closing fragment:**

```tsx
{
  /* Victory announcement */
}
{
  gameEnded && victoryPhase === 'reveal' && <VPRevealOverlay />;
}
{
  gameEnded && victoryPhase === 'modal' && <VictoryModal />;
}
```

This ensures the board remains visible behind the victory overlays per CONTEXT.md.
</action>
<verify>npm run build:web && npm run typecheck</verify>
<done>Game.tsx conditionally renders victory overlay and modal when game ends</done>
</task>

</tasks>

<verification>
- [ ] npm install completes for react-canvas-confetti
- [ ] npm run build:web succeeds
- [ ] npm run typecheck succeeds
- [ ] Victory message handler in Lobby.tsx
- [ ] VPRevealOverlay auto-transitions after 1.5s
- [ ] VictoryModal shows confetti, winner, and all player VP
- [ ] "View Board" dismisses modal, "Return to Lobby" navigates away
</verification>

<success_criteria>

- Victory message triggers reveal overlay followed by victory modal
- Confetti animation plays when modal opens
- All players' final VP breakdown visible with icons
- Board visible (dimmed) behind victory UI
- Both action buttons functional
  </success_criteria>

<output>
After completion, create `.planning/phases/11-victory/11-04-SUMMARY.md`
</output>
