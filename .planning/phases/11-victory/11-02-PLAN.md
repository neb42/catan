---
phase: 11-victory
plan: 02
type: execute
wave: 2
depends_on: ['11-01']
files_modified:
  - apps/api/src/game/GameManager.ts
  - apps/api/src/handlers/websocket.ts
autonomous: true

must_haves:
  truths:
    - 'Game checks for victory after every VP-changing action'
    - 'Victory triggers immediately even mid-action'
    - 'All players receive victory message when game ends'
  artifacts:
    - path: 'apps/api/src/game/GameManager.ts'
      provides: 'checkVictory method and integration at all VP change points'
      contains: 'checkVictory'
    - path: 'apps/api/src/handlers/websocket.ts'
      provides: 'Victory message broadcast handling'
      contains: 'victory'
  key_links:
    - from: 'GameManager.ts'
      to: 'victory-logic.ts'
      via: 'import checkForVictory'
      pattern: 'import.*checkForVictory.*from.*victory-logic'
    - from: 'websocket.ts'
      to: 'victory message broadcast'
      via: 'room.broadcast victory message'
      pattern: "type: 'victory'"
---

<objective>
Integrate victory detection into GameManager at all VP-changing action points and broadcast victory message.

Purpose: Ensure game ends immediately when any player reaches 10 VP, regardless of whose turn it is or whether an action is mid-progress.
Output: GameManager calls checkVictory after every VP-changing method; WebSocket broadcasts victory to all players.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-victory/11-01-SUMMARY.md
@.planning/phases/11-victory/11-RESEARCH.md

# Key files to modify

@apps/api/src/game/GameManager.ts
@apps/api/src/handlers/websocket.ts
@apps/api/src/game/victory-logic.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkVictory method to GameManager</name>
  <files>apps/api/src/game/GameManager.ts</files>
  <action>
Import checkForVictory and VictoryResult from ./victory-logic.

Add private gameEnded flag to track if game has ended:

```typescript
private gameEnded = false;
```

Add checkVictory method:

```typescript
public checkVictory(): VictoryResult | null {
  if (this.gameEnded) return null;

  const result = checkForVictory(
    this.playerIds,
    this.gameState.settlements,
    this.gameState.longestRoadHolderId,
    this.gameState.largestArmyHolderId,
    (playerId) => this.playerDevCards.get(playerId) || [],
  );

  if (result.gameEnded) {
    this.gameEnded = true;
    this.gameState.gamePhase = 'ended';
    this.gameState.winnerId = result.winnerId;
  }

  return result.gameEnded ? result : null;
}
```

Add getter for checking if game is ended:

```typescript
public isGameEnded(): boolean {
  return this.gameEnded;
}
```

Modify these methods to include victoryResult in their return type and call checkVictory:

1. **placeSettlement()** - after adding settlement (setup phase gives 1 VP)
2. **buildSettlement()** - after successful build (1 VP)
3. **buildCity()** - after successful upgrade (+1 VP net)
4. **buildRoad()** - after road placed (may trigger longest road change)
5. **placeRoadBuilding()** - after EACH road placed, return early if game ends

Each method should check victory AFTER any longestRoadResult/largestArmyResult updates have been applied.

Pattern for return type modification:

```typescript
// Before
): { success: true; longestRoadResult?: LongestRoadResult } | { success: false; reason: string } {

// After
): { success: true; longestRoadResult?: LongestRoadResult; victoryResult?: VictoryResult } | { success: false; reason: string } {
```

**Critical: playKnight()** already updates largest army - add victory check after largestArmyResult is applied.

**Guard all VP-changing actions:** If this.gameEnded is true, return early with an error:

```typescript
if (this.gameEnded) {
  return { success: false, reason: 'Game has ended' };
}
```

  </action>
  <verify>npm run build:api && npm run typecheck</verify>
  <done>GameManager.checkVictory() implemented, all VP-changing methods return victoryResult, game blocks actions after ended</done>
</task>

<task type="auto">
  <name>Task 2: Broadcast victory message in WebSocket handlers</name>
  <files>apps/api/src/handlers/websocket.ts</files>
  <action>
Create helper function to broadcast victory (follows broadcastLongestRoadUpdate pattern):

```typescript
function broadcastVictory(room: Room, result: VictoryResult) {
  const winner = room.players.find((p) => p.id === result.winnerId);
  room.broadcast({
    type: 'victory',
    winnerId: result.winnerId!,
    winnerNickname: winner?.nickname || 'Unknown',
    winnerVP: result.winnerVP!,
    allPlayerVP: result.allPlayerVP,
    revealedVPCards: result.revealedVPCards,
  });
}
```

Add victory broadcast after each action that can change VP. Modify these handlers:

1. **settlement_placed handler** (setup phase) - check result.victoryResult
2. **build_settlement handler** - check result.victoryResult
3. **build_city handler** - check result.victoryResult
4. **build_road handler** - check result.victoryResult (may trigger longest road)
5. **road_building_place handler** - check result.victoryResult after EACH road
6. **play_dev_card handler** (knight) - check after largestArmyResult

Pattern for each handler:

```typescript
if (result.victoryResult) {
  broadcastVictory(room, result.victoryResult);
  return; // Stop processing - game is over
}
```

**Important for Road Building:** If first road triggers victory, don't prompt for second road - game ends immediately.
</action>
<verify>npm run build:api && npm run typecheck</verify>
<done>Victory broadcast added to all VP-changing action handlers, game stops after victory message sent</done>
</task>

</tasks>

<verification>
- [ ] npm run build:api succeeds
- [ ] npm run typecheck succeeds
- [ ] GameManager.checkVictory exists and returns VictoryResult
- [ ] All VP-changing methods (placeSettlement, buildSettlement, buildCity, buildRoad, playKnight, placeRoadBuilding) include victory check
- [ ] WebSocket handlers broadcast victory message when game ends
</verification>

<success_criteria>

- Victory is checked after every VP-changing action on the server
- Game ends immediately when any player reaches 10 VP
- All players receive victory message with complete VP breakdowns
- Mid-action win (Road Building) stops further action
  </success_criteria>

<output>
After completion, create `.planning/phases/11-victory/11-02-SUMMARY.md`
</output>
