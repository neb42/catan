---
phase: 07-robber
plan: 04
type: execute
wave: 3
depends_on: ['07-01', '07-02', '07-03']
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/Lobby.tsx
  - apps/web/src/components/Robber/DiscardModal.tsx
  - apps/web/src/components/Robber/RobberPlacement.tsx
  - apps/web/src/components/Robber/RobberFigure.tsx
  - apps/web/src/components/Board.tsx
autonomous: true

must_haves:
  truths:
    - 'Client receives and displays discard modal when 8+ cards'
    - 'Player can select and submit cards to discard'
    - 'Player can click hex to move robber'
    - 'Robber figure displays on hex'
  artifacts:
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'Robber state slice'
      contains: 'discardRequired'
    - path: 'apps/web/src/components/Robber/DiscardModal.tsx'
      provides: 'Discard selection UI'
      exports: ['DiscardModal']
    - path: 'apps/web/src/components/Robber/RobberPlacement.tsx'
      provides: 'Robber placement overlay'
      exports: ['RobberPlacement']
    - path: 'apps/web/src/components/Robber/RobberFigure.tsx'
      provides: 'Robber visual on hex'
      exports: ['RobberFigure']
  key_links:
    - from: 'apps/web/src/components/Robber/DiscardModal.tsx'
      to: 'gameStore'
      via: 'useDiscardState hook'
      pattern: 'useDiscardState'
    - from: 'apps/web/src/components/Board.tsx'
      to: 'apps/web/src/components/Robber/RobberFigure.tsx'
      via: 'renders RobberFigure on robber hex'
      pattern: 'RobberFigure'
---

<objective>
Implement frontend robber state management, discard modal, and robber placement UI.

Purpose: Enables players to see and interact with the robber flow - discarding cards when they have 8+ and clicking hexes to move the robber. This is the core user-facing robber experience.

Output: Robber state slice in gameStore, DiscardModal component, RobberPlacement overlay, RobberFigure visual.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-robber/07-CONTEXT.md
@.planning/phases/07-robber/07-RESEARCH.md
@.planning/phases/07-robber/07-01-SUMMARY.md

@apps/web/src/stores/gameStore.ts
@apps/web/src/components/Lobby.tsx
@apps/web/src/components/Board.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add robber state slice to gameStore</name>
  <files>apps/web/src/stores/gameStore.ts</files>
  <action>
Add robber state and actions to gameStore:

**1. Add robber state interface:**

```typescript
interface RobberSlice {
  // Discard state
  discardRequired: boolean;
  discardTarget: number;
  discardResources: PlayerResources | null; // Current resources to discard from
  selectedForDiscard: Record<ResourceType, number>;

  // Robber placement state
  robberPlacementMode: boolean;
  robberHexId: string | null;

  // Steal state
  stealRequired: boolean;
  stealCandidates: Array<{
    playerId: string;
    nickname: string;
    cardCount: number;
  }>;

  // Actions
  setDiscardRequired: (
    required: boolean,
    target: number,
    resources: PlayerResources | null,
  ) => void;
  toggleDiscardSelection: (resource: ResourceType, delta: number) => void;
  clearDiscardSelection: () => void;
  setRobberPlacementMode: (mode: boolean) => void;
  setRobberHexId: (hexId: string | null) => void;
  setStealRequired: (
    required: boolean,
    candidates: Array<{
      playerId: string;
      nickname: string;
      cardCount: number;
    }>,
  ) => void;
  clearRobberState: () => void;
}
```

**2. Add state and actions to store:**

```typescript
// Robber state
discardRequired: false,
discardTarget: 0,
discardResources: null,
selectedForDiscard: { wood: 0, brick: 0, sheep: 0, wheat: 0, ore: 0 },
robberPlacementMode: false,
robberHexId: null,
stealRequired: false,
stealCandidates: [],

// Robber actions
setDiscardRequired: (required, target, resources) => set({
  discardRequired: required,
  discardTarget: target,
  discardResources: resources,
  selectedForDiscard: { wood: 0, brick: 0, sheep: 0, wheat: 0, ore: 0 },
}),

toggleDiscardSelection: (resource, delta) => set((state) => {
  const current = state.selectedForDiscard[resource] || 0;
  const newVal = Math.max(0, current + delta);
  // Don't exceed what player has
  const max = state.discardResources?.[resource] || 0;
  return {
    selectedForDiscard: {
      ...state.selectedForDiscard,
      [resource]: Math.min(newVal, max),
    },
  };
}),

clearDiscardSelection: () => set({
  selectedForDiscard: { wood: 0, brick: 0, sheep: 0, wheat: 0, ore: 0 },
}),

setRobberPlacementMode: (mode) => set({ robberPlacementMode: mode }),

setRobberHexId: (hexId) => set({ robberHexId: hexId }),

setStealRequired: (required, candidates) => set({
  stealRequired: required,
  stealCandidates: candidates,
}),

clearRobberState: () => set({
  discardRequired: false,
  discardTarget: 0,
  discardResources: null,
  selectedForDiscard: { wood: 0, brick: 0, sheep: 0, wheat: 0, ore: 0 },
  robberPlacementMode: false,
  stealRequired: false,
  stealCandidates: [],
}),
```

**3. Add selector hooks:**

```typescript
export const useDiscardRequired = () =>
  useGameStore((state) => state.discardRequired);
export const useDiscardTarget = () =>
  useGameStore((state) => state.discardTarget);
export const useDiscardResources = () =>
  useGameStore((state) => state.discardResources);
export const useSelectedForDiscard = () =>
  useGameStore((state) => state.selectedForDiscard);
export const useRobberPlacementMode = () =>
  useGameStore((state) => state.robberPlacementMode);
export const useRobberHexId = () => useGameStore((state) => state.robberHexId);
export const useStealRequired = () =>
  useGameStore((state) => state.stealRequired);
export const useStealCandidates = () =>
  useGameStore((state) => state.stealCandidates);

// Combined hook for discard modal
export const useDiscardState = () =>
  useGameStore(
    useShallow((state) => ({
      required: state.discardRequired,
      target: state.discardTarget,
      resources: state.discardResources,
      selected: state.selectedForDiscard,
    })),
  );
```

  </action>
  <verify>
Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
Store compiles without errors.
  </verify>
  <done>
gameStore has complete robber state slice with discard, placement, and steal state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add robber message handlers to Lobby.tsx</name>
  <files>apps/web/src/components/Lobby.tsx</files>
  <action>
Add WebSocket message handlers for robber messages in the message handler switch:

```typescript
case 'discard_required': {
  // Only show discard modal if this is for current player
  const myId = useGameStore.getState().playerId;
  if (message.playerId === myId) {
    useGameStore.getState().setDiscardRequired(
      true,
      message.targetCount,
      message.currentResources
    );
  }
  break;
}

case 'discard_completed': {
  // Update player resources (deduct discarded)
  const currentResources = useGameStore.getState().playerResources[message.playerId];
  if (currentResources) {
    const updated = { ...currentResources };
    for (const [resource, count] of Object.entries(message.discarded)) {
      const resType = resource as ResourceType;
      updated[resType] = (updated[resType] || 0) - (count || 0);
    }
    useGameStore.getState().updatePlayerResources(message.playerId, updated);
  }
  // Clear own discard modal if it was us
  const myId = useGameStore.getState().playerId;
  if (message.playerId === myId) {
    useGameStore.getState().setDiscardRequired(false, 0, null);
  }
  break;
}

case 'all_discards_complete': {
  // All discards done - robber mover will receive robber_move_required
  break;
}

case 'robber_move_required': {
  useGameStore.getState().setRobberPlacementMode(true);
  break;
}

case 'robber_moved': {
  useGameStore.getState().setRobberHexId(message.hexId);
  useGameStore.getState().setRobberPlacementMode(false);
  break;
}

case 'steal_required': {
  useGameStore.getState().setStealRequired(true, message.candidates);
  break;
}

case 'stolen': {
  // Update resources for thief and victim
  const state = useGameStore.getState();
  if (message.resourceType) {
    // Victim loses resource
    const victimRes = state.playerResources[message.victimId];
    if (victimRes) {
      const updated = { ...victimRes };
      updated[message.resourceType] = (updated[message.resourceType] || 0) - 1;
      state.updatePlayerResources(message.victimId, updated);
    }
    // Thief gains resource
    const thiefRes = state.playerResources[message.thiefId];
    if (thiefRes) {
      const updated = { ...thiefRes };
      updated[message.resourceType] = (updated[message.resourceType] || 0) + 1;
      state.updatePlayerResources(message.thiefId, updated);
    }
  }
  // Clear steal state
  state.setStealRequired(false, []);
  break;
}

case 'no_steal_possible': {
  // No one to steal from - just continue
  useGameStore.getState().setStealRequired(false, []);
  break;
}
```

  </action>
  <verify>
Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
Lobby.tsx compiles with all new message handlers.
  </verify>
  <done>
Lobby.tsx handles all robber WebSocket messages and updates store state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create DiscardModal, RobberPlacement, and RobberFigure components</name>
  <files>
    apps/web/src/components/Robber/DiscardModal.tsx
    apps/web/src/components/Robber/RobberPlacement.tsx
    apps/web/src/components/Robber/RobberFigure.tsx
  </files>
  <action>
Create the Robber components directory and three components:

**1. apps/web/src/components/Robber/DiscardModal.tsx:**

```tsx
import { Modal, Button, Text, Group, Stack, Badge } from '@mantine/core';
import { useDiscardState, useGameStore } from '@web/stores/gameStore';
import { ResourceType } from '@catan/shared';

const RESOURCE_COLORS: Record<ResourceType, string> = {
  wood: '#228B22',
  brick: '#B22222',
  sheep: '#90EE90',
  wheat: '#FFD700',
  ore: '#808080',
};

export function DiscardModal() {
  const { required, target, resources, selected } = useDiscardState();
  const toggleSelection = useGameStore((s) => s.toggleDiscardSelection);
  const sendMessage = useGameStore((s) => s.sendMessage);

  if (!required || !resources) return null;

  const selectedTotal = Object.values(selected).reduce((sum, c) => sum + c, 0);
  const canSubmit = selectedTotal === target;

  const handleSubmit = () => {
    sendMessage({
      type: 'discard_submitted',
      resources: selected,
    });
  };

  return (
    <Modal
      opened={true}
      onClose={() => {}} // Cannot close - blocking
      closeOnClickOutside={false}
      closeOnEscape={false}
      withCloseButton={false}
      centered
      title={`Discard ${target} Cards`}
      size="md"
    >
      <Stack gap="md">
        <Text size="sm" c="dimmed">
          You rolled a 7 and have 8+ cards. Select {target} cards to discard.
        </Text>

        <Text size="sm" fw={500}>
          Selected: {selectedTotal} / {target}
        </Text>

        {(['wood', 'brick', 'sheep', 'wheat', 'ore'] as ResourceType[]).map(
          (res) => {
            const have = resources[res] || 0;
            const choosing = selected[res] || 0;

            if (have === 0) return null;

            return (
              <Group key={res} justify="space-between" align="center">
                <Group gap="xs">
                  <Badge
                    color={RESOURCE_COLORS[res]}
                    variant="filled"
                    size="lg"
                  >
                    {res.charAt(0).toUpperCase() + res.slice(1)}
                  </Badge>
                  <Text size="sm">({have} available)</Text>
                </Group>
                <Group gap="xs">
                  <Button
                    size="xs"
                    variant="outline"
                    onClick={() => toggleSelection(res, -1)}
                    disabled={choosing === 0}
                  >
                    -
                  </Button>
                  <Text w={30} ta="center">
                    {choosing}
                  </Text>
                  <Button
                    size="xs"
                    variant="outline"
                    onClick={() => toggleSelection(res, 1)}
                    disabled={choosing >= have || selectedTotal >= target}
                  >
                    +
                  </Button>
                </Group>
              </Group>
            );
          },
        )}

        <Button fullWidth onClick={handleSubmit} disabled={!canSubmit} mt="md">
          Discard {selectedTotal} Cards
        </Button>
      </Stack>
    </Modal>
  );
}
```

**2. apps/web/src/components/Robber/RobberPlacement.tsx:**

```tsx
import { useRobberPlacementMode, useGameStore } from '@web/stores/gameStore';

interface RobberPlacementProps {
  hexes: Array<{
    q: number;
    r: number;
    terrain: string;
    center: { x: number; y: number };
  }>;
  hexSize: number;
}

export function RobberPlacement({ hexes, hexSize }: RobberPlacementProps) {
  const placementMode = useRobberPlacementMode();
  const sendMessage = useGameStore((s) => s.sendMessage);

  if (!placementMode) return null;

  const handleHexClick = (hexId: string) => {
    sendMessage({
      type: 'move_robber',
      hexId,
    });
  };

  // Filter to land hexes only
  const landTerrains = [
    'forest',
    'hills',
    'pasture',
    'fields',
    'mountains',
    'desert',
  ];
  const landHexes = hexes.filter((h) => landTerrains.includes(h.terrain));

  return (
    <g className="robber-placement-overlay">
      {landHexes.map((hex) => {
        const hexId = `${hex.q},${hex.r}`;
        return (
          <circle
            key={hexId}
            cx={hex.center.x}
            cy={hex.center.y}
            r={hexSize * 0.6}
            fill="rgba(0, 0, 0, 0.3)"
            stroke="#FF4444"
            strokeWidth={2}
            style={{ cursor: 'pointer' }}
            onClick={() => handleHexClick(hexId)}
          >
            <title>Move robber here</title>
          </circle>
        );
      })}
    </g>
  );
}
```

**3. apps/web/src/components/Robber/RobberFigure.tsx:**

```tsx
interface RobberFigureProps {
  x: number;
  y: number;
  size?: number;
}

export function RobberFigure({ x, y, size = 30 }: RobberFigureProps) {
  // Simple robber figure - dark silhouette
  return (
    <g transform={`translate(${x}, ${y})`}>
      {/* Body - dark oval */}
      <ellipse
        cx={0}
        cy={size * 0.2}
        rx={size * 0.35}
        ry={size * 0.5}
        fill="rgba(30, 30, 30, 0.85)"
        stroke="#000"
        strokeWidth={1.5}
      />
      {/* Head - dark circle */}
      <circle
        cx={0}
        cy={-size * 0.35}
        r={size * 0.25}
        fill="rgba(30, 30, 30, 0.85)"
        stroke="#000"
        strokeWidth={1.5}
      />
    </g>
  );
}
```

**4. Create index.ts for exports:**

```typescript
// apps/web/src/components/Robber/index.ts
export { DiscardModal } from './DiscardModal';
export { RobberPlacement } from './RobberPlacement';
export { RobberFigure } from './RobberFigure';
```

  </action>
  <verify>
Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
All components compile without errors.
  </verify>
  <done>
DiscardModal shows blocking card selection, RobberPlacement overlays hexes for placement, RobberFigure renders robber visual.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx nx typecheck web`
2. Components render without crashes (dev server)
3. Store state updates correctly when receiving messages
</verification>

<success_criteria>

- gameStore has robber state slice
- Lobby.tsx handles all robber messages
- DiscardModal shows when discard_required received
- RobberPlacement overlay enables hex clicking
- RobberFigure renders robber on hex
  </success_criteria>

<output>
After completion, create `.planning/phases/07-robber/07-04-SUMMARY.md`
</output>
