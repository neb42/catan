---
phase: 07-robber
plan: 07
type: execute
wave: 4
depends_on: ['07-02', '07-03', '07-04', '07-05', '07-06']
files_modified:
  - apps/web/src/components/Game.tsx
  - apps/web/src/components/Board.tsx
  - apps/web/src/components/Lobby.tsx
autonomous: false

must_haves:
  truths:
    - 'Rolling 7 triggers complete robber flow'
    - 'Discard modal appears for 8+ card players'
    - 'Robber can be moved to any land hex'
    - 'Stealing from adjacent player works'
    - 'Feedback notifications appear for all actions'
  artifacts: []
  key_links: []
---

<objective>
Integrate all robber components into the game UI and verify end-to-end functionality.

Purpose: Wires together all robber components (modals, overlay, figure, feedback) into the main Game component and verifies the complete robber flow works correctly through human testing.

Output: Fully integrated robber system with human verification of all requirements.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-robber/07-CONTEXT.md
@.planning/phases/07-robber/07-RESEARCH.md
@.planning/phases/07-robber/07-04-SUMMARY.md
@.planning/phases/07-robber/07-05-SUMMARY.md
@.planning/phases/07-robber/07-06-SUMMARY.md

@apps/web/src/components/Game.tsx
@apps/web/src/components/Board.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate robber components into Game.tsx</name>
  <files>apps/web/src/components/Game.tsx</files>
  <action>
Add all robber components to the Game component:

1. Import robber components:

```typescript
import { DiscardModal, StealModal } from '@web/components/Robber';
import { GameLog } from '@web/components/Feedback';
```

2. Add components to Game JSX (modals render themselves based on store state):

```tsx
return (
  <>
    {/* Existing game content */}

    {/* Robber modals */}
    <DiscardModal />
    <StealModal />

    {/* Feedback */}
    <GameLog />
  </>
);
```

The modals will show/hide themselves based on store state (discardRequired, stealRequired).
</action>
<verify>
Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
Game.tsx compiles with robber components.
</verify>
<done>
Game.tsx includes DiscardModal, StealModal, and GameLog components.
</done>
</task>

<task type="auto">
  <name>Task 2: Integrate RobberFigure and RobberPlacement into Board.tsx</name>
  <files>apps/web/src/components/Board.tsx</files>
  <action>
Add robber visual and placement overlay to Board:

1. Import components:

```typescript
import { RobberFigure, RobberPlacement } from '@web/components/Robber';
import { useRobberHexId, useRobberPlacementMode } from '@web/stores/gameStore';
```

2. Inside Board component, get robber state:

```typescript
const robberHexId = useRobberHexId();
const placementMode = useRobberPlacementMode();
```

3. Calculate robber position from hexId:

```typescript
const getRobberPosition = () => {
  if (!robberHexId) return null;
  const hex = hexes.find((h) => `${h.q},${h.r}` === robberHexId);
  if (!hex) return null;
  return hex.center; // or calculate center from q,r
};

const robberPos = getRobberPosition();
```

4. Add RobberPlacement overlay (before settlements/roads so it's clickable):

```tsx
{
  placementMode && (
    <RobberPlacement hexes={hexesWithCenters} hexSize={hexSize} />
  );
}
```

5. Add RobberFigure on robber hex (after hexes, before settlements):

```tsx
{
  robberPos && (
    <RobberFigure x={robberPos.x} y={robberPos.y} size={hexSize * 0.4} />
  );
}
```

Note: Ensure hexes have center coordinates calculated. If not, compute from q,r using hex geometry.
</action>
<verify>
Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
Board.tsx compiles with robber components.
</verify>
<done>
Board.tsx renders RobberFigure on robber hex and RobberPlacement overlay during placement mode.
</done>
</task>

<task type="auto">
  <name>Task 3: Add game notifications to Lobby.tsx message handlers</name>
  <files>apps/web/src/components/Lobby.tsx</files>
  <action>
Add feedback notifications to WebSocket message handlers:

1. Import notification helper:

```typescript
import { showGameNotification } from '@web/components/Feedback';
```

2. Add notifications to relevant message handlers:

**dice_rolled:**

```typescript
showGameNotification(`Rolled ${message.total}`, 'info');
if (message.total === 7) {
  showGameNotification('Robber activated!', 'warning');
}
```

**discard_completed:**

```typescript
const nickname = /* get from room players */;
showGameNotification(`${nickname} discarded cards`, 'info');
```

**robber_moved:**

```typescript
const nickname = /* get from room players */;
showGameNotification(`${nickname} moved the robber`, 'info');
```

**stolen:**

```typescript
const thiefNickname = /* get from room players */;
const victimNickname = /* get from room players */;
if (message.resourceType) {
  showGameNotification(`${thiefNickname} stole from ${victimNickname}`, 'info');
} else {
  showGameNotification(`${thiefNickname} stole nothing (no cards)`, 'info');
}
```

**error:**

```typescript
showGameNotification(message.message, 'error');
```

Also add notifications for existing actions if not already present:

- road_built, settlement_built, city_built → success notifications
- trade_executed, bank_trade_executed → info notifications
  </action>
  <verify>
  Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
  Lobby.tsx compiles with notification calls.
  </verify>
  <done>
  All game actions trigger toast notifications and log entries.
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete robber system with discard flow, robber placement, stealing, and feedback notifications</what-built>
  <how-to-verify>
**Setup:**
1. Start servers: `npx nx serve api` and `npx nx serve web`
2. Open 4 browser tabs to http://localhost:4200
3. Create room and have all 4 players join
4. Complete initial placement phase
5. Play turns to accumulate resources

**Test 1: Robber triggers on 7 (ROBBER-01, ROBBER-02)**

1. Give one player 8+ cards (may need to play several turns)
2. Have that player's turn come up
3. Roll dice until 7 is rolled
4. Verify: Discard modal appears for player with 8+ cards
5. Verify: Other players see waiting message or continue
6. Select cards to discard (half rounded down)
7. Verify: Modal closes after discarding
8. Verify: Robber placement overlay appears for roller

**Test 2: Robber placement (ROBBER-02, ROBBER-04)**

1. Click on any land hex
2. Verify: Robber figure appears on clicked hex
3. Verify: Can click same hex robber was on (self-blocking)
4. Verify: Toast notification shows robber moved

**Test 3: Stealing (ROBBER-03)**

1. After moving robber, if adjacent players exist:
   - If 1 player: Auto-steal happens
   - If 2+ players: Steal modal appears
2. Select victim if modal shown
3. Verify: Resource transferred
4. Verify: Toast shows steal result

**Test 4: Robber blocking (ROBBER-05)**

1. Place robber on a numbered hex (not desert)
2. Roll that number on subsequent turns
3. Verify: Hex with robber produces NO resources
4. Verify: Other hexes with same number still produce

**Test 5: Opponent resource counts (RES-03)**

1. Look at player list during game
2. Verify: Each player shows total card count
3. Verify: Only total shown (not breakdown by type)

**Test 6: Feedback system (UX-02, UX-03)**

1. Observe toasts appearing at bottom-center
2. Verify: Toasts auto-dismiss after 3 seconds
3. Click GameLog expand button
4. Verify: Log shows history of actions
5. Try invalid action (e.g., build without resources)
6. Verify: Error toast appears with clear message
   </how-to-verify>
   <resume-signal>Type "approved" if all tests pass, or describe issues found</resume-signal>
   </task>

</tasks>

<verification>
1. All robber components integrated
2. Visual elements render correctly
3. Complete flow works: 7 roll → discard → move → steal
4. Notifications appear for all actions
5. Opponent resource counts visible
</verification>

<success_criteria>

- ROBBER-01: Discard flow works for 8+ cards
- ROBBER-02: Robber moves to any land hex
- ROBBER-03: Stealing from adjacent player works
- ROBBER-04: Self-blocking allowed
- ROBBER-05: Blocked hex produces no resources
- RES-03: Opponent card counts visible
- UX-02: Feedback for all actions
- UX-03: Error messages display clearly
  </success_criteria>

<output>
After completion, create `.planning/phases/07-robber/07-07-SUMMARY.md`
</output>
