---
phase: 02.1-setup-testing-framework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/vitest.config.ts
  - apps/api/vitest.setup.ts
  - apps/api/src/test-utils/test-websocket.ts
  - apps/web/vitest.config.ts
  - apps/web/vitest.setup.ts
  - apps/web/src/test-utils/render.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Vitest runs tests in both API and web applications"
    - "Test commands execute without errors"
    - "Coverage reports are generated"
    - "Test utilities are available for use in test files"
  artifacts:
    - path: "apps/api/vitest.config.ts"
      provides: "API Vitest configuration with v8 coverage"
      min_lines: 25
    - path: "apps/web/vitest.config.ts"
      provides: "Web Vitest configuration with jsdom environment"
      min_lines: 30
    - path: "apps/web/vitest.setup.ts"
      provides: "Browser API polyfills for Mantine"
      min_lines: 25
    - path: "apps/api/src/test-utils/test-websocket.ts"
      provides: "TestWebSocket helper class"
      exports: ["TestWebSocket"]
    - path: "apps/web/src/test-utils/render.tsx"
      provides: "Custom render with providers"
      exports: ["render"]
  key_links:
    - from: "apps/api/vitest.config.ts"
      to: "nx test api"
      via: "Nx auto-detection"
      pattern: "test.*environment.*node"
    - from: "apps/web/vitest.config.ts"
      to: "apps/web/vitest.setup.ts"
      via: "setupFiles configuration"
      pattern: "setupFiles.*vitest.setup"
    - from: "apps/web/src/test-utils/render.tsx"
      to: "@testing-library/react"
      via: "imports render function"
      pattern: "import.*@testing-library/react"
---

<objective>
Establish comprehensive Vitest testing infrastructure for both API and web applications with proper configuration, test utilities, and Nx integration.

Purpose: Create foundation for retroactive test coverage and mandate testing for all future work
Output: Configured Vitest for both apps, test utilities, and working test commands
</objective>

<execution_context>
@/Users/bmcalindin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/bmcalindin/workspace/catan/.planning/PROJECT.md
@/Users/bmcalindin/workspace/catan/.planning/ROADMAP.md
@/Users/bmcalindin/workspace/catan/.planning/STATE.md
@/Users/bmcalindin/workspace/catan/.planning/phases/02.1-setup-testing-framework-with-jest-and-retroactively-add-tests-to-code-going-forward-tests-must-be-written-and-pass-to-be-successful/02.1-RESEARCH.md

# Existing tech stack
@/Users/bmcalindin/workspace/catan/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install testing dependencies and configure Vitest for both applications</name>
  <files>
    package.json
    apps/api/vitest.config.ts
    apps/web/vitest.config.ts
  </files>
  <action>
Install required testing libraries:
```bash
npm install --save-dev @testing-library/react @testing-library/user-event @testing-library/jest-dom @vitest/coverage-v8
```

**API Vitest Configuration (apps/api/vitest.config.ts):**
Create configuration following RESEARCH.md Pattern 1:
- Use Node environment (not jsdom)
- Include src/**/*.spec.ts pattern
- Configure v8 coverage provider
- Set coverage thresholds: 80% lines/functions, 75% branches
- Exclude src/**/*.spec.ts, src/test-utils/**, src/main.ts from coverage
- Enable globals: true (for describe, it, expect without imports)
- Use nxViteTsPaths plugin for path resolution

**Web Vitest Configuration (apps/web/vitest.config.ts):**
Create configuration following RESEARCH.md Pattern 1:
- Use jsdom environment (for React)
- Include src/**/*.spec.{ts,tsx} pattern
- Configure v8 coverage provider
- Set coverage thresholds: 80% lines/functions, 75% branches
- Exclude test files, test-utils, main.tsx, router.tsx from coverage
- Reference vitest.setup.ts in setupFiles array
- Use nxViteTsPaths and react plugins

**Add Nx test scripts to package.json:**
```json
"test": "nx run-many -t test --all",
"test:api": "nx test api",
"test:web": "nx test web",
"test:coverage": "nx run-many -t test --all --coverage"
```

Why this approach: Vitest is already installed (4.0+), just needs configuration. v8 coverage provider is faster than Istanbul with equivalent accuracy (Vitest 3.2.0+). Nx auto-detects vitest.config.ts files and creates test targets.
  </action>
  <verify>
```bash
nx test api --run
nx test web --run
npm run test:coverage
```

All commands should execute without configuration errors (tests may fail since we haven't written them yet).
  </verify>
  <done>
Vitest configured for both apps, npm scripts added, Nx can execute test targets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test utilities and helper classes</name>
  <files>
    apps/api/src/test-utils/test-websocket.ts
    apps/web/src/test-utils/render.tsx
    apps/api/vitest.setup.ts
  </files>
  <action>
**TestWebSocket helper class (apps/api/src/test-utils/test-websocket.ts):**
Implement following RESEARCH.md Pattern 2 "TestWebSocket Helper Class":
- Extend ws WebSocket class
- Add waitUntil(targetState, timeout) method for waiting until 'open' or 'closed'
- Add waitForMessage<T>(timeout) method that returns Promise<T> of parsed JSON
- Add sendJSON(message) convenience method
- Include timeout protection (default 1000ms) to prevent hanging tests

**Custom render wrapper (apps/web/src/test-utils/render.tsx):**
Implement following RESEARCH.md Pattern 5:
- Import render from @testing-library/react
- Export custom render function that wraps components with QueryClientProvider and MantineProvider
- Create fresh QueryClient with retry: false for tests
- Accept options parameter and spread to testingLibraryRender

**API test setup (apps/api/vitest.setup.ts):**
Create minimal setup file (Node environment doesn't need polyfills):
```typescript
// Empty or basic setup - API uses Node environment
```

Why this approach: TestWebSocket class encapsulates WebSocket test patterns from RESEARCH.md, avoiding race conditions. Custom render ensures all React components have required providers (Mantine, TanStack Query). Setup files loaded before tests via vitest.config.ts setupFiles.
  </action>
  <verify>
```bash
# Verify files created
ls apps/api/src/test-utils/test-websocket.ts
ls apps/web/src/test-utils/render.tsx
ls apps/api/vitest.setup.ts

# Verify TypeScript compiles
npx tsc --noEmit -p apps/api/tsconfig.app.json
npx nx typecheck @catan/web
```

No TypeScript errors, utilities export expected functions/classes.
  </verify>
  <done>
Test utility classes created and TypeScript validates them.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add browser API polyfills for Mantine</name>
  <files>
    apps/web/vitest.setup.ts
  </files>
  <action>
Create web test setup file following RESEARCH.md "Vitest Setup File for Mantine (Web App)":

**apps/web/vitest.setup.ts:**
```typescript
import { vi } from 'vitest';
import '@testing-library/jest-dom/vitest';

// Mock window.matchMedia (required by Mantine)
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation((query) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// Mock ResizeObserver (required by Mantine)
global.ResizeObserver = vi.fn().mockImplementation(() => ({
  observe: vi.fn(),
  unobserve: vi.fn(),
  disconnect: vi.fn(),
}));

// Mock scrollIntoView (not available in jsdom)
Element.prototype.scrollIntoView = vi.fn();
```

Why these polyfills: Mantine v8 components require window.matchMedia and ResizeObserver which jsdom doesn't implement. Without these, React component tests crash immediately with "matchMedia is not a function" errors. This is documented in Mantine official Vitest guide.
  </action>
  <verify>
```bash
# Verify setup file created
cat apps/web/vitest.setup.ts | grep -E "(matchMedia|ResizeObserver)"

# Verify TypeScript compiles
npx nx typecheck @catan/web
```

Setup file contains polyfills, no TypeScript errors.
  </verify>
  <done>
Mantine polyfills in place, web app tests can render Mantine components without crashes.
  </done>
</task>

</tasks>

<verification>
Run test commands to verify infrastructure:
```bash
nx test api --run
nx test web --run
npm run test:coverage
```

Expected: Commands execute successfully (no tests yet, so 0 tests passing is OK). No configuration errors or missing dependencies.
</verification>

<success_criteria>
1. `nx test api` and `nx test web` commands execute without errors
2. Vitest configurations exist with v8 coverage and proper thresholds
3. Test utilities (TestWebSocket, custom render) created and TypeScript-valid
4. Mantine polyfills prevent jsdom crashes in web tests
5. Nx workspace recognizes both test targets
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-setup-testing-framework-with-jest-and-retroactively-add-tests-to-code-going-forward-tests-must-be-written-and-pass-to-be-successful/02.1-01-SUMMARY.md`
</output>
