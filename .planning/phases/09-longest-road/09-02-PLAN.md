---
phase: 09-longest-road
plan: 02
type: execute
wave: 2
depends_on: ['09-01']
files_modified:
  - libs/shared/src/schemas/game.ts
  - libs/shared/src/schemas/messages.ts
  - libs/shared/src/index.ts
  - apps/api/src/game/longest-road-logic.ts
  - apps/api/src/game/GameManager.ts
  - apps/api/src/handlers/websocket.ts
autonomous: true

must_haves:
  truths:
    - 'GameState tracks longest road holder and lengths per player'
    - 'Longest road recalculates after every road and settlement placement'
    - 'Award only given at 5+ roads'
    - 'New player must exceed (not match) current holder to take award'
    - 'Ties favor current holder'
  artifacts:
    - path: 'libs/shared/src/schemas/game.ts'
      provides: 'LongestRoadState in GameState'
      contains: 'longestRoadHolderId'
    - path: 'apps/api/src/game/longest-road-logic.ts'
      provides: 'Award management with tie handling'
      exports: ['recalculateLongestRoad']
    - path: 'apps/api/src/game/GameManager.ts'
      provides: 'Integration with placeRoad, buildRoad, buildSettlement'
      contains: 'recalculateLongestRoad'
  key_links:
    - from: 'apps/api/src/game/longest-road-logic.ts'
      to: 'libs/shared/src/utils/longestRoad.ts'
      via: 'import calculatePlayerLongestRoad'
      pattern: 'calculatePlayerLongestRoad'
    - from: 'apps/api/src/game/GameManager.ts'
      to: 'apps/api/src/game/longest-road-logic.ts'
      via: 'import and call recalculateLongestRoad'
      pattern: 'recalculateLongestRoad'
---

<objective>
Add longest road state to GameState, implement award management logic, and integrate recalculation into GameManager.

Purpose: The backend must track who holds Longest Road, recalculate after every placement, and apply correct tie-breaking rules. This plan wires the algorithm from Plan 01 into the game state machine.

Output: GameState with longest road tracking, server-side award management, WebSocket messages for transfer notifications.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-longest-road/09-CONTEXT.md
@.planning/phases/09-longest-road/09-RESEARCH.md
@.planning/phases/09-longest-road/09-01-SUMMARY.md

@libs/shared/src/schemas/game.ts
@libs/shared/src/schemas/messages.ts
@apps/api/src/game/GameManager.ts
@apps/api/src/game/robber-logic.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add longest road state to GameState and message schemas</name>
  <files>
    libs/shared/src/schemas/game.ts
    libs/shared/src/schemas/messages.ts
    libs/shared/src/index.ts
  </files>
  <action>
1. In game.ts, add to GameStateSchema after robberHexId:

```typescript
// Longest road tracking
longestRoadHolderId: z.string().nullable(), // Player with longest road card, null if no one has 5+
longestRoadLength: z.number(), // Length of longest road holder's road (0 if no holder)
playerRoadLengths: z.record(z.string(), z.number()), // playerId -> current longest road length
```

2. In messages.ts, add LongestRoadUpdated message (server -> client broadcast):

   ```typescript
   export const LongestRoadUpdatedMessageSchema = z.object({
     type: z.literal('longest_road_updated'),
     holderId: z.string().nullable(),
     holderLength: z.number(),
     playerLengths: z.record(z.string(), z.number()), // All players' road lengths
     transferredFrom: z.string().nullable(), // Previous holder if transferred
   });
   ```

3. Add to WebSocketMessageSchema discriminated union.

4. Export new types from index.ts.
   </action>
   <verify>
   Run: `npx tsc --noEmit -p libs/shared/tsconfig.json`
   TypeScript compiles without errors.
   </verify>
   <done>
   GameState includes longest road tracking fields. Message schema for updates defined.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Create longest-road-logic.ts with award management</name>
  <files>apps/api/src/game/longest-road-logic.ts</files>
  <action>
Create apps/api/src/game/longest-road-logic.ts following robber-logic.ts pattern:

```typescript
import { Road, Settlement } from '@catan/shared';
import { calculatePlayerLongestRoad } from '@catan/shared';

interface LongestRoadState {
  holderId: string | null;
  length: number;
}

interface LongestRoadResult {
  newState: LongestRoadState;
  playerLengths: Record<string, number>;
  transferred: boolean;
  fromPlayerId?: string;
  toPlayerId?: string;
}

/**
 * Recalculate longest road for all players and determine award holder.
 *
 * Rules:
 * - Minimum 5 roads to qualify
 * - New player must EXCEED current holder's length (not match)
 * - Ties favor current holder
 * - If current holder drops below all others, award can transfer
 */
export function recalculateLongestRoad(
  roads: Road[],
  settlements: Settlement[],
  playerIds: string[],
  currentState: LongestRoadState,
): LongestRoadResult {
  // Calculate for all players
  const playerLengths: Record<string, number> = {};
  for (const playerId of playerIds) {
    playerLengths[playerId] = calculatePlayerLongestRoad(
      roads,
      settlements,
      playerId,
    );
  }

  const maxLength = Math.max(...Object.values(playerLengths), 0);

  // No one qualifies (< 5)
  if (maxLength < 5) {
    if (currentState.holderId) {
      return {
        newState: { holderId: null, length: 0 },
        playerLengths,
        transferred: true,
        fromPlayerId: currentState.holderId,
      };
    }
    return {
      newState: { holderId: null, length: 0 },
      playerLengths,
      transferred: false,
    };
  }

  // Find all players at max length
  const playersAtMax = Object.entries(playerLengths)
    .filter(([_, len]) => len === maxLength)
    .map(([id]) => id);

  // Multiple players tied at max
  if (playersAtMax.length > 1) {
    // Current holder keeps if still at max
    if (currentState.holderId && playersAtMax.includes(currentState.holderId)) {
      return {
        newState: { holderId: currentState.holderId, length: maxLength },
        playerLengths,
        transferred: false,
      };
    }
    // Tie with no current holder at max - no one gets it
    if (currentState.holderId) {
      return {
        newState: { holderId: null, length: 0 },
        playerLengths,
        transferred: true,
        fromPlayerId: currentState.holderId,
      };
    }
    return {
      newState: { holderId: null, length: 0 },
      playerLengths,
      transferred: false,
    };
  }

  // Single player has max
  const winnerId = playersAtMax[0];

  // New player must exceed (not match) current holder
  if (currentState.holderId && currentState.holderId !== winnerId) {
    if (maxLength <= currentState.length) {
      // Current holder retains
      return {
        newState: currentState,
        playerLengths,
        transferred: false,
      };
    }
  }

  // Award to winner
  if (winnerId !== currentState.holderId) {
    return {
      newState: { holderId: winnerId, length: maxLength },
      playerLengths,
      transferred: true,
      fromPlayerId: currentState.holderId ?? undefined,
      toPlayerId: winnerId,
    };
  }

  // Current holder still has it
  return {
    newState: { holderId: winnerId, length: maxLength },
    playerLengths,
    transferred: false,
  };
}
```

  </action>
  <verify>
Run: `npx tsc --noEmit -p apps/api/tsconfig.json`
File compiles and uses shared library algorithm.
  </verify>
  <done>
Award management function handles all tie-breaking rules correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate recalculation into GameManager and WebSocket handlers</name>
  <files>
    apps/api/src/game/GameManager.ts
    apps/api/src/handlers/websocket.ts
  </files>
  <action>
1. In GameManager constructor, initialize longest road state:

```typescript
this.gameState = {
  // ... existing fields
  longestRoadHolderId: null,
  longestRoadLength: 0,
  playerRoadLengths: Object.fromEntries(playerIds.map((id) => [id, 0])),
};
```

2. Add private method to GameManager:

   ```typescript
   private updateLongestRoad(): LongestRoadResult {
     const result = recalculateLongestRoad(
       this.gameState.roads,
       this.gameState.settlements,
       this.playerIds,
       {
         holderId: this.gameState.longestRoadHolderId,
         length: this.gameState.longestRoadLength,
       },
     );

     this.gameState.longestRoadHolderId = result.newState.holderId;
     this.gameState.longestRoadLength = result.newState.length;
     this.gameState.playerRoadLengths = result.playerLengths;

     return result;
   }
   ```

3. Call updateLongestRoad() at the end of:
   - `placeRoad()` method (setup phase)
   - `buildRoad()` method (main game)
   - `buildSettlement()` method (opponent settlements can break roads)
   - `placeRoadBuildingRoad()` method (dev card road placement)

   Return the result in each method's return object.

4. In websocket.ts handlers for road/settlement placement:
   - If result.longestRoadResult.transferred is true:
   - Broadcast `longest_road_updated` message to room with transfer info

5. Always include playerLengths in game state updates so clients can display current road lengths.
   </action>
   <verify>
   Run: `npx tsc --noEmit -p apps/api/tsconfig.json`
   All methods compile. Integration points added.
   </verify>
   <done>
   GameManager recalculates longest road after every road/settlement placement. WebSocket broadcasts transfers.
   </done>
   </task>

</tasks>

<verification>
1. TypeScript compiles: `npx nx run-many -t typecheck -p shared,api`
2. GameState includes new fields: `grep "longestRoadHolderId" libs/shared/src/schemas/game.ts`
3. Integration in GameManager: `grep "updateLongestRoad" apps/api/src/game/GameManager.ts`
</verification>

<success_criteria>

- GameState tracks longest road holder and per-player lengths
- Recalculation happens after road and settlement placements
- Award rules (5+ minimum, exceed to take, ties favor holder) enforced
- WebSocket broadcasts transfer events
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/09-longest-road/09-02-SUMMARY.md`
</output>
