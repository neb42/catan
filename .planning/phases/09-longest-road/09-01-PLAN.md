---
phase: 09-longest-road
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - libs/shared/src/utils/longestRoad.ts
  - libs/shared/src/utils/longestRoad.spec.ts
  - libs/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - 'Longest road algorithm finds maximum edge-based path'
    - 'Opponent settlements block traversal'
    - 'Own settlements do NOT block traversal'
    - 'Loops count correctly (edges visited once)'
  artifacts:
    - path: 'libs/shared/src/utils/longestRoad.ts'
      provides: 'DFS algorithm with edge-tracking backtracking'
      exports: ['calculatePlayerLongestRoad']
    - path: 'libs/shared/src/utils/longestRoad.spec.ts'
      provides: 'Comprehensive test coverage'
      min_lines: 150
  key_links:
    - from: 'libs/shared/src/utils/longestRoad.ts'
      to: 'Road.edgeId'
      via: 'edge ID parsing with split'
      pattern: "edgeId\\.split\\('\\|'\\)"
---

<objective>
Implement the longest road calculation algorithm using TDD with comprehensive edge cases.

Purpose: The algorithm is the core of the entire phase. Getting it right with tests prevents bugs around loops, forks, blocking, and ties. This is a pure function with testable behavior - ideal for TDD.

Output: Tested `calculatePlayerLongestRoad` function that correctly handles all Catan road scenarios.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-longest-road/09-CONTEXT.md
@.planning/phases/09-longest-road/09-RESEARCH.md

@libs/shared/src/schemas/game.ts
@apps/api/src/game/geometry-utils.ts
</context>

<feature>
  <name>Longest Road Algorithm</name>
  <files>
    libs/shared/src/utils/longestRoad.ts
    libs/shared/src/utils/longestRoad.spec.ts
    libs/shared/src/index.ts
  </files>
  <behavior>
The algorithm calculates the longest continuous road for a player.

**Key behaviors:**

- Track visited EDGES not nodes (edges cannot be reused, nodes can be revisited)
- DFS from every vertex in player's road network, take maximum
- Opponent settlements block traversal at that vertex
- Own settlements do NOT block (per official Catan rules)
- Minimum count is 0 (no minimum enforced in algorithm - caller handles 5+ threshold)

**Test cases (input -> expected):**

1. Simple linear road (5 edges): `[e1,e2,e3,e4,e5]` -> 5
2. Fork in road (Y-shape): `[e1,e2,e3,e4]` where e3,e4 branch -> max of branches + stem
3. Loop of 6 roads: 6 edges in circle -> 6
4. Loop with tail: 6-edge circle + 2 extending -> 7 (not 8)
5. Opponent settlement blocks: 5 edges split by opponent settlement -> max segment
6. Own settlement doesn't block: 5 edges with own settlement in middle -> 5
7. Disconnected road segments: 2 separate groups -> max of either
8. Single road: 1 edge -> 1
9. No roads: empty array -> 0
10. Two players: only count requesting player's roads
    </behavior>
    <implementation>
11. Create longestRoad.ts with types and main function
12. Implement helper functions:
    - `getOtherEndpoint(edgeId, fromVertex)` - get other end of edge
    - `getPlayerRoadsAtVertex(vertexId, playerRoads)` - find connected roads
    - `dfs(currentVertex, visitedEdges, playerRoads, blockedVertices)` - core DFS with backtracking
13. Main function `calculatePlayerLongestRoad(roads, settlements, playerId)`:
    - Filter to player's roads
    - Build set of opponent settlement vertices (blocked)
    - Get all vertices in player's road network
    - DFS from each vertex, track max
    - Return max length
14. Export from index.ts
    </implementation>
    </feature>

<verification>
1. All test cases pass: `cd libs/shared && npx vitest run longestRoad.spec.ts`
2. TypeScript compiles: `npx tsc --noEmit -p libs/shared/tsconfig.json`
3. Function is exported: `grep -r "calculatePlayerLongestRoad" libs/shared/src/index.ts`
</verification>

<success_criteria>

- All 10+ test cases pass
- Algorithm correctly handles loops, forks, blocking
- Own settlements do NOT block (per official Catan rules)
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/09-longest-road/09-01-SUMMARY.md`
</output>
