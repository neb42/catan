---
phase: 09-longest-road
plan: 03
type: execute
wave: 3
depends_on: ['09-02']
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/hooks/useWebSocket.ts
  - apps/web/src/components/GamePlayerList.tsx
  - apps/web/src/components/Feedback/useGameNotifications.ts
autonomous: true

must_haves:
  truths:
    - 'Road length shows for all players in player list'
    - 'Longest Road badge appears on holder when 5+ roads'
    - 'Transfer announces via toast notification'
    - 'Road lengths update in real-time'
  artifacts:
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'LongestRoadSlice state'
      contains: 'longestRoadHolderId'
    - path: 'apps/web/src/components/GamePlayerList.tsx'
      provides: 'Road length display and badge UI'
      contains: 'longestRoadHolderId'
  key_links:
    - from: 'apps/web/src/hooks/useWebSocket.ts'
      to: 'gameStore setLongestRoadState'
      via: 'message handler for longest_road_updated'
      pattern: 'longest_road_updated'
    - from: 'apps/web/src/components/GamePlayerList.tsx'
      to: 'gameStore longestRoadHolderId'
      via: 'useGameStore selector'
      pattern: 'longestRoadHolderId'
---

<objective>
Add frontend state management and UI for longest road display in the player list.

Purpose: Players need to see their current road length, who holds the Longest Road card, and be notified when the award transfers. This completes the user-facing requirements for Phase 9.

Output: GamePlayerList shows road lengths for all players, badge for holder, toast on transfer.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-longest-road/09-CONTEXT.md
@.planning/phases/09-longest-road/09-RESEARCH.md
@.planning/phases/09-longest-road/09-02-SUMMARY.md

@apps/web/src/stores/gameStore.ts
@apps/web/src/hooks/useWebSocket.ts
@apps/web/src/components/GamePlayerList.tsx
@apps/web/src/components/Feedback/useGameNotifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LongestRoadSlice to gameStore</name>
  <files>apps/web/src/stores/gameStore.ts</files>
  <action>
1. Add LongestRoadSlice interface after DevCardSlice:

```typescript
// Longest road state slice
interface LongestRoadSlice {
  longestRoadHolderId: string | null;
  longestRoadLength: number;
  playerRoadLengths: Record<string, number>;
}
```

2. Add LongestRoadSlice to GameStore interface extends.

3. Add initial state in create():

   ```typescript
   // Longest road initial state
   longestRoadHolderId: null,
   longestRoadLength: 0,
   playerRoadLengths: {},
   ```

4. Add setLongestRoadState action:

   ```typescript
   setLongestRoadState: (state: {
     holderId: string | null;
     holderLength: number;
     playerLengths: Record<string, number>;
   }) => void;
   ```

5. Implement the action:

   ```typescript
   setLongestRoadState: (state) =>
     set({
       longestRoadHolderId: state.holderId,
       longestRoadLength: state.holderLength,
       playerRoadLengths: state.playerLengths,
     }),
   ```

6. Add selector hooks at bottom:

   ```typescript
   export const useLongestRoadHolder = () =>
     useGameStore((s) => s.longestRoadHolderId);

   export const usePlayerRoadLengths = () =>
     useGameStore(useShallow((s) => s.playerRoadLengths));
   ```

     </action>
     <verify>
   Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
   Store compiles with new state slice.
     </verify>
     <done>
   Frontend state tracks longest road holder and all player road lengths.
     </done>
   </task>

<task type="auto">
  <name>Task 2: Handle longest_road_updated message and show toast</name>
  <files>
    apps/web/src/hooks/useWebSocket.ts
    apps/web/src/components/Feedback/useGameNotifications.ts
  </files>
  <action>
1. In useWebSocket.ts, add handler for 'longest_road_updated' message:

```typescript
case 'longest_road_updated': {
  const { holderId, holderLength, playerLengths, transferredFrom } = message;

  // Update state
  setLongestRoadState({
    holderId,
    holderLength,
    playerLengths,
  });

  // Show toast if transferred
  if (transferredFrom) {
    const room = useGameStore.getState().room;
    const fromPlayer = room?.players.find(p => p.id === transferredFrom);
    const toPlayer = holderId ? room?.players.find(p => p.id === holderId) : null;

    if (toPlayer) {
      showGameNotification(
        `${toPlayer.nickname} takes Longest Road from ${fromPlayer?.nickname || 'nobody'}!`,
        'success'
      );
    } else {
      // Award lost (went below 5 or tie broke it)
      showGameNotification(
        `${fromPlayer?.nickname} loses Longest Road!`,
        'warning'
      );
    }
  }
  break;
}
```

2. Import showGameNotification at top of useWebSocket.ts if not already imported.

3. Also update playerRoadLengths from game_state_sync if the backend includes it in full state:
   - In the 'game_state_sync' handler, check for longestRoadHolderId, longestRoadLength, playerRoadLengths
   - Call setLongestRoadState with values from game state
     </action>
     <verify>
     Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
     Message handler compiles. Toast notification works.
     </verify>
     <done>
     WebSocket handler updates state and shows transfer notifications.
     </done>
     </task>

<task type="auto">
  <name>Task 3: Display road lengths and badge in GamePlayerList</name>
  <files>apps/web/src/components/GamePlayerList.tsx</files>
  <action>
1. Import new selectors at top:

```typescript
import {
  useCurrentPlayer,
  useGameStore,
  useTurnCurrentPlayer,
  useLongestRoadHolder,
  usePlayerRoadLengths,
} from '../stores/gameStore';
```

2. Inside GamePlayerList component, get longest road state:

   ```typescript
   const longestRoadHolderId = useLongestRoadHolder();
   const playerRoadLengths = usePlayerRoadLengths();
   ```

3. Inside the player.map(), get road length for this player:

   ```typescript
   const roadLength = playerRoadLengths[player.id] || 0;
   const hasLongestRoad = player.id === longestRoadHolderId;
   ```

4. Add road length display after "Cards" text, before dev card badges:

   ```tsx
   {
     /* Road length stats */
   }
   <Text size="sm" c="dimmed" fw={500}>
     Roads: {roadLength}
   </Text>;
   ```

5. Add Longest Road badge (only shows for holder):

   ```tsx
   {
     /* Longest Road badge */
   }
   {
     hasLongestRoad && (
       <Tooltip label="Longest Road (2 VP)" position="top">
         <Badge size="sm" color="green" variant="filled" leftSection="üõ§Ô∏è">
           Longest
         </Badge>
       </Tooltip>
     );
   }
   ```

6. Place the badge in the Group with dev card and knight badges.

7. Consider adding subtle animation when badge appears (optional - use motion/react if simple):

   ```tsx
   {
     hasLongestRoad && (
       <motion.div
         initial={{ scale: 0 }}
         animate={{ scale: 1 }}
         transition={{ type: 'spring', stiffness: 500, damping: 30 }}
       >
         <Tooltip label="Longest Road (2 VP)" position="top">
           <Badge size="sm" color="green" variant="filled">
             üõ§Ô∏è Longest
           </Badge>
         </Tooltip>
       </motion.div>
     );
   }
   ```

     </action>
     <verify>
   Run: `npx tsc --noEmit -p apps/web/tsconfig.json`
   Component compiles. Road lengths and badge display correctly.
     </verify>
     <done>
   GamePlayerList shows road lengths for all players and Longest Road badge for holder.
     </done>
   </task>

</tasks>

<verification>
1. TypeScript compiles: `npx nx run-many -t typecheck -p web`
2. Store has new state: `grep "longestRoadHolderId" apps/web/src/stores/gameStore.ts`
3. UI displays road lengths: `grep "Roads:" apps/web/src/components/GamePlayerList.tsx`
4. Badge displays for holder: `grep "Longest" apps/web/src/components/GamePlayerList.tsx`
</verification>

<success_criteria>

- Road length visible for all players in player list
- Longest Road badge only appears when someone has 5+ roads
- Transfer shows toast notification with player names
- Real-time updates as roads are placed
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/09-longest-road/09-03-SUMMARY.md`
</output>
