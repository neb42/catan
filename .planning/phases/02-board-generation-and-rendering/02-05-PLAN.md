---
phase: 02-board-generation-and-rendering
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/Board/Port.tsx
  - libs/shared/src/utils/coordinates.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees 9 ports positioned at coast edges"
    - "Ports render at correct pixel coordinates matching hex layout"
    - "Port icons display with proper orientation"
  artifacts:
    - path: "libs/shared/src/utils/coordinates.ts"
      provides: "Hex-to-pixel conversion matching Layout settings"
      exports: ["hexToPixel"]
      min_lines: 80
    - path: "apps/web/src/components/Board/Port.tsx"
      provides: "Port rendering with correct coordinate transformation"
      uses: "hexToPixel from coordinates.ts"
      min_lines: 30
  key_links:
    - from: "apps/web/src/components/Board/Port.tsx"
      to: "libs/shared/src/utils/coordinates.ts"
      via: "hexToPixel function"
      pattern: "import.*hexToPixel.*from.*coordinates"
    - from: "apps/web/src/components/Board/Port.tsx"
      to: "Layout settings"
      via: "matching size=10, flat=false parameters"
      pattern: "hexToPixel.*size.*10.*flat.*false"
---

<objective>
Fix Port rendering by implementing correct hex-to-pixel coordinate transformation.

**Purpose:** Close verification gap where ports render at wrong coordinates due to treating grid coordinates as pixel coordinates.

**Output:** Working Port component that displays 9 ports at correct coast edge positions matching the hex layout.

**Gap addressed:** Truth #4 from VERIFICATION.md - "User sees 9 ports positioned at coast edges"
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-board-generation-and-rendering/02-CONTEXT.md
@.planning/phases/02-board-generation-and-rendering/02-RESEARCH.md
@.planning/phases/02-board-generation-and-rendering/02-board-generation-and-rendering-VERIFICATION.md

## Gap Context

**From VERIFICATION.md:**

**Truth:** "User sees 9 ports positioned at coast edges"  
**Status:** FAILED  
**Reason:** Port rendering uses grid coordinates as pixel coordinates, causing ports to render in a pile at (0,0).

**Artifact issues:**
- `apps/web/src/components/Board/Port.tsx`: Calculates x/y by adding constant to hexQ/hexR without applying Hex Layout transformation. Requires Layout context or manual HexToPixel conversion that matches Board layout.
- `apps/web/src/components/Board/Board.tsx`: Renders Port outside `<Layout>` context. Even if moved inside, Port.tsx implementation does not use library components (like Text or Hexagon) that handle coordinates automatically.

**Missing:**
- Hex-to-Pixel conversion logic in Port.tsx to match Layout(size=10, flat=false)
- Correct geometry calculation for port placement on edges

## Board Layout Settings

From [Board.tsx](apps/web/src/components/Board/Board.tsx#L19):
```tsx
<Layout size={{ x: 10, y: 10 }} flat={false} spacing={1.05} origin={{ x: 0, y: 0 }}>
```

- `size: { x: 10, y: 10 }` - hex size in pixels
- `flat: false` - pointy-top orientation (⬡)
- `spacing: 1.05` - 5% gap between hexes

## Port Data Structure

From [board.ts](libs/shared/src/schemas/board.ts#L14-L18):
```typescript
export const PortSchema = z.object({
  type: PortTypeSchema, // 'generic', 'wood', 'brick', 'sheep', 'wheat', 'ore'
  hexQ: z.number(),     // Axial q coordinate of adjacent hex
  hexR: z.number(),     // Axial r coordinate of adjacent hex
  edge: z.number().min(0).max(5), // 0-5 for 6 hex edges (0=E, 1=NE, 2=NW, 3=W, 4=SW, 5=SE)
});
```

## Existing Coordinate Utilities

From [coordinates.ts](libs/shared/src/utils/coordinates.ts):
- `axialToCube`, `cubeToAxial` - coordinate conversions
- `getNeighbors` - get adjacent hex coordinates
- `getCatanHexPositions` - 19 hex positions for board

**Missing:** `hexToPixel` function that matches react-hexgrid Layout transformation
</context>

<tasks>

<task type="auto">
  <name>Add hexToPixel conversion to coordinates.ts</name>
  <files>libs/shared/src/utils/coordinates.ts</files>
  <action>
Add `hexToPixel` function to convert axial hex coordinates to pixel coordinates matching react-hexgrid Layout settings.

**Implementation details:**

1. Add interface for pixel coordinates:
```typescript
export interface PixelCoord {
  x: number;
  y: number;
}
```

2. Add `hexToPixel` function using standard pointy-top hex formulas:
```typescript
/**
 * Convert axial hex coordinates to pixel coordinates.
 * Must match react-hexgrid Layout settings: size={x: 10, y: 10}, flat=false (pointy-top)
 * 
 * Formula for pointy-top hexes:
 * x = size.x * (Math.sqrt(3) * q + Math.sqrt(3)/2 * r)
 * y = size.y * (3/2 * r)
 */
export function hexToPixel(coord: AxialCoord, size: { x: number; y: number } = { x: 10, y: 10 }): PixelCoord {
  const x = size.x * (Math.sqrt(3) * coord.q + Math.sqrt(3) / 2 * coord.r);
  const y = size.y * (3 / 2 * coord.r);
  return { x, y };
}
```

3. Add helper to get edge direction angle (for port placement):
```typescript
/**
 * Get angle in degrees for hex edge direction (0-5).
 * For pointy-top hexes:
 * 0=E (0°), 1=NE (60°), 2=NW (120°), 3=W (180°), 4=SW (240°), 5=SE (300°)
 */
export function getEdgeAngle(edge: number): number {
  return edge * 60;
}
```

4. Add helper to calculate port position on hex edge:
```typescript
/**
 * Calculate pixel position for port on hex edge.
 * Port should be positioned at the midpoint of the edge, extended outward.
 */
export function getPortPosition(
  hexQ: number,
  hexR: number,
  edge: number,
  size: { x: number; y: number } = { x: 10, y: 10 },
  distance: number = 15
): PixelCoord {
  const hexCenter = hexToPixel({ q: hexQ, r: hexR }, size);
  const angle = getEdgeAngle(edge);
  const radians = (angle * Math.PI) / 180;
  
  return {
    x: hexCenter.x + Math.cos(radians) * distance,
    y: hexCenter.y + Math.sin(radians) * distance,
  };
}
```

**Note:** These formulas are standard for pointy-top hex grids (Red Blob Games). Distance=15 positions port icon outside the hex boundary (hex radius ≈ 10).
  </action>
  <verify>
```bash
# Verify exports added
grep -E "export.*(hexToPixel|PixelCoord|getEdgeAngle|getPortPosition)" libs/shared/src/utils/coordinates.ts

# Check TypeScript compiles
npx tsc --noEmit -p libs/shared/tsconfig.json
```
  </verify>
  <done>
- `PixelCoord` interface exported
- `hexToPixel` function converts axial to pixel using pointy-top formulas
- `getEdgeAngle` returns degrees for edge 0-5
- `getPortPosition` calculates port pixel coordinates with distance offset
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Fix Port component to use hexToPixel</name>
  <files>apps/web/src/components/Board/Port.tsx</files>
  <action>
Replace Port component's coordinate calculation with proper hex-to-pixel conversion using utilities from coordinates.ts.

**Implementation:**

1. Import utilities:
```typescript
import { getPortPosition } from '@catan/shared';
```

2. Replace the coordinate calculation logic:
```typescript
export function Port({ port }: PortProps) {
  // Calculate pixel position using proper hex-to-pixel conversion
  // Matches Board.tsx Layout: size={x: 10, y: 10}, flat=false
  const position = getPortPosition(
    port.hexQ,
    port.hexR,
    port.edge,
    { x: 10, y: 10 }, // Match Board Layout size
    15 // Distance from hex center to position port outside boundary
  );
  
  return (
    <g transform={`translate(${position.x}, ${position.y})`}>
      <image 
        href={`/assets/ports/${port.type}.svg`}
        width="8" 
        height="8"
        x="-4"
        y="-4"
      />
    </g>
  );
}
```

**Why this works:**
- `getPortPosition` applies the same hex-to-pixel math that react-hexgrid uses internally
- Size `{x: 10, y: 10}` matches `<Layout size={{ x: 10, y: 10 }}>` in Board.tsx
- `flat=false` is baked into the formulas (pointy-top orientation)
- Distance=15 positions port icon visibly outside hex boundary
- Result: ports render at correct coast edges, not piled at (0,0)

**DO NOT:**
- Move Port inside Layout component (react-hexgrid Layout is for Hexagon children only)
- Change port edge calculations in board-generator.ts (those are correct)
- Use offset coordinates (stay in axial for consistency)
  </action>
  <verify>
```bash
# Verify import added
grep "import.*getPortPosition.*from.*@catan/shared" apps/web/src/components/Board/Port.tsx

# Verify old coordinate logic removed (should not find hexQ + Math.cos pattern)
! grep "port.hexQ + Math.cos" apps/web/src/components/Board/Port.tsx

# Check TypeScript compiles
npx tsc --noEmit -p apps/web/tsconfig.json

# Start dev server and visually check ports
npx nx serve web
```
  </verify>
  <done>
- Port.tsx imports `getPortPosition` from @catan/shared
- Coordinate calculation uses `getPortPosition` with correct size parameters
- Old flawed logic (hexQ + Math.cos) removed
- TypeScript compiles without errors
- Ports render at 9 distinct positions on coast edges (visual verification)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Fixed port rendering with proper hex-to-pixel coordinate transformation:
- Added `hexToPixel`, `getEdgeAngle`, `getPortPosition` utilities to coordinates.ts
- Updated Port.tsx to use `getPortPosition` matching Board's Layout settings (size=10, flat=false)
- Ports now calculate pixel positions correctly instead of treating grid coordinates as pixels
  </what-built>
  <how-to-verify>
1. **Start the dev server** (if not already running):
   ```bash
   npx nx serve web
   ```

2. **Create a game room:**
   - Visit http://localhost:5173
   - Enter a nickname
   - Click "Create Room"
   - In the lobby, click "I'm Ready!"
   - Wait for countdown (or force start if testing)

3. **Verify port rendering:**
   - **Expected:** See 9 port icons positioned around the coast edges of the hex board
   - **Verify:** Ports should be:
     - At 9 distinct positions (not piled at center)
     - Positioned outside the hex boundaries on coast edges
     - Evenly distributed around the board perimeter
     - Each port icon clearly visible (generic 3:1 and resource-specific 2:1)

4. **Visual checks:**
   - [ ] 9 ports visible (not overlapping at origin)
   - [ ] Ports positioned at edges between hexes and ocean
   - [ ] Port icons display correct resource types (wood, brick, sheep, wheat, ore, generic)
   - [ ] No console errors related to Port component
   - [ ] Board layout unchanged (hexes still render correctly)

5. **Test multiple boards:**
   - Create 2-3 new games to verify ports render correctly with different random boards
   - Ports should adapt to different hex positions while maintaining coast placement

**If issues found:**
- Describe which ports render incorrectly (position, visibility)
- Check browser console for errors
- Take screenshot if helpful
  </how-to-verify>
  <resume-signal>
Type "approved" to continue, or describe any issues with port rendering.
  </resume-signal>
</task>

</tasks>

<verification>
**Automated checks:**
```bash
# Verify coordinate utilities exist and export correctly
grep -E "export (function hexToPixel|interface PixelCoord|function getEdgeAngle|function getPortPosition)" libs/shared/src/utils/coordinates.ts

# Verify Port.tsx uses getPortPosition
grep "getPortPosition" apps/web/src/components/Board/Port.tsx

# Verify no TypeScript errors
npx tsc --noEmit -p libs/shared/tsconfig.json
npx tsc --noEmit -p apps/web/tsconfig.json
```

**Visual verification:**
- User can see 9 ports positioned at coast edges (not at origin)
- Port icons display correct resource types
- Ports positioned outside hex boundaries
- Board renders correctly with ports visible
</verification>

<success_criteria>
**Must achieve:**
- [ ] `hexToPixel` function added to coordinates.ts with pointy-top formulas
- [ ] `getPortPosition` helper calculates port pixel coordinates
- [ ] Port.tsx imports and uses `getPortPosition`
- [ ] Ports render at 9 distinct positions on coast edges
- [ ] No coordinate calculation errors in console
- [ ] TypeScript compiles without errors

**Observable truth verified:**
- [x] "User sees 9 ports positioned at coast edges" - Gap closed
</success_criteria>

<output>
After completion, create `.planning/phases/02-board-generation-and-rendering/02-05-SUMMARY.md` documenting:
- Hex-to-pixel conversion utilities added
- Port rendering fixed with correct coordinate transformation
- Gap closure verification (truth #4 now achieves)
</output>
