---
phase: 02-board-generation-and-rendering
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/game/board-generator.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All 9 ports positioned correctly at coast edge locations"
    - "Port positions match between generation logic and rendering logic"
    - "Ports evenly distributed around board perimeter"
  artifacts:
    - path: "apps/api/src/game/board-generator.ts"
      provides: "Port generation with edge indices matching render angles"
      min_lines: 239
      exports: ["generateBoard"]
      contains: "CUBE_DIRECTIONS"
  key_links:
    - from: "generatePorts edge index assignment"
      to: "Port.tsx angle calculation"
      via: "edge index to angle mapping"
      pattern: "edge.*bestEdge"
---

<objective>
Fix port positioning inconsistency by aligning CUBE_DIRECTIONS edge indices with angle-ordered rendering.

Purpose: Resolve HIGH priority UAT Issue #2 where some ports position correctly while others have 120-240° discrepancies. Generation uses CUBE_DIRECTIONS order (indices 0-5) but rendering calculates angles independently, causing edge index mismatches.

Output: Port generation edge indices correctly map to render angles, ensuring all 9 ports position accurately at coast edges.
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-board-generation-and-rendering/02-05-SUMMARY.md
@.planning/phases/02-board-generation-and-rendering/02-board-generation-and-rendering-UAT.md
@apps/api/src/game/board-generator.ts
@apps/web/src/components/Board/Port.tsx
</context>

<tasks>

<task type="auto">
  <name>Align edge indices with angle-ordered rendering</name>
  <files>apps/api/src/game/board-generator.ts</files>
  <action>
Root cause: Port generation uses CUBE_DIRECTIONS order to assign edge indices (0-5):
```typescript
const DIRS = [
  { q: 1, r: 0, s: -1 },    // Edge 0
  { q: 1, r: -1, s: 0 },    // Edge 1
  { q: 0, r: -1, s: 1 },    // Edge 2
  { q: -1, r: 0, s: 1 },    // Edge 3
  { q: -1, r: 1, s: 0 },    // Edge 4
  { q: 0, r: 1, s: -1 },    // Edge 5
];
```

However, Port.tsx renders using angle calculation (edge * 60°) which expects edges ordered by angle:
- Edge 0 = 0° (right)
- Edge 1 = 60° (bottom-right)
- Edge 2 = 120° (bottom-left)
- Edge 3 = 180° (left)
- Edge 4 = 240° (top-left)
- Edge 5 = 300° (top-right)

CUBE_DIRECTIONS order doesn't match angle order, causing discrepancies. Edges 0 and 3 happen to match, but edges 1, 2, 4, 5 have 120-240° offsets.

Fix:
1. In generatePorts function, after finding bestEdge from DIRS array (line ~228), map the CUBE_DIRECTIONS index to angle-ordered index:

```typescript
// Map CUBE_DIRECTIONS index to angle-ordered edge index
// CUBE_DIRECTIONS: [0]=SE, [1]=E, [2]=NE, [3]=NW, [4]=W, [5]=SW
// Angle order:     [0]=E,  [1]=SE, [2]=SW, [3]=W,  [4]=NW, [5]=NE
const DIRS_TO_ANGLE_MAP = [1, 0, 5, 4, 3, 2]; // Maps DIRS index to angle edge
const angleOrderedEdge = DIRS_TO_ANGLE_MAP[bestEdge];
```

2. Use angleOrderedEdge when creating the port:

```typescript
ports.push({
  type,
  hexQ: hex.q,
  hexR: hex.r,
  edge: angleOrderedEdge  // Changed from bestEdge
});
```

This ensures the edge index stored in port data matches the angle calculation used during rendering.

Note: Do NOT modify the DIRS array itself (used for neighbor calculations). Only transform the final edge index before storing in the Port object.
  </action>
  <verify>
1. Run test suite to ensure board generation still works: `cd apps/api && npx vitest run board-generator.spec.ts`
2. Start dev servers: `npx nx serve api` and `npx nx serve web`
3. Create 3-5 new game boards
4. Visually inspect port positions - all 9 ports should be at coast edges
5. Check for consistent spacing - no clustering or outliers
6. Verify mix of generic (3:1) and resource-specific (2:1) ports still correct
  </verify>
  <done>
- All 9 ports positioned correctly at coast edges
- No ports positioned inside the board
- Even distribution around perimeter (no clustering)
- Port types remain correct (4 generic, 5 specific)
- Board generation tests still pass
  </done>
</task>

</tasks>

<verification>
**Visual Inspection:**
- Create 5+ new game boards with different layouts
- Confirm all ports positioned at perimeter edges (not inside board)
- Verify even distribution with no clustering patterns
- Check that port icons face outward consistently

**UAT Re-test:**
- Run UAT Test #3: "Board Generation - Port Placement"
- Should now pass: All 9 ports positioned at correct coast edge locations
- Run UAT Test #8: "Board Rendering - Port Icons Display"
- Should now pass: Icons positioned at edges, not overlapping at center
- Run UAT Test #12: "Port Positioning - Coordinate Accuracy"
- Should now pass: Ports adapt to hex positions correctly

**Regression Check:**
- Run `cd apps/api && npx vitest run board-generator.spec.ts`
- Verify fairness validation still works (no adjacent 6/8)
</verification>

<success_criteria>
**Observable truths achieved:**
1. User can see all 9 ports positioned correctly at coast edges
2. Port positions consistent across multiple board generations
3. No visual clustering or misplaced ports
4. Port rendering matches generation logic

**Measurable outcomes:**
- UAT Test #3 status changes from "failed" to "passed"
- UAT Test #8 status changes from "failed" to "passed"
- UAT Test #12 status changes from "failed" to "passed"
- Board generation unit tests continue passing
- Visual confirmation: all ports at edges, evenly distributed
</success_criteria>

<output>
After completion, create `.planning/phases/02-board-generation-and-rendering/02-07-SUMMARY.md`
</output>
