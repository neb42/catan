---
phase: 02-board-generation-and-rendering
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/Board/NumberToken.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Each hex displays its assigned number token centered on that hex"
    - "Number tokens are positioned correctly across the entire board"
    - "6 and 8 tokens maintain distinct visual styling (bold red)"
  artifacts:
    - path: "apps/web/src/components/Board/NumberToken.tsx"
      provides: "Number token rendering with proper coordinate transformation"
      min_lines: 35
      exports: ["NumberToken"]
  key_links:
    - from: "apps/web/src/components/Board/NumberToken.tsx"
      to: "react-hexgrid Layout context"
      via: "useLayoutContext hook"
      pattern: "useLayoutContext"
    - from: "NumberToken Text component"
      to: "pixel coordinates"
      via: "hexToPixel conversion"
      pattern: "hexToPixel\\(.*cube"
---

<objective>
Fix number token clustering by converting cube coordinates to pixel coordinates before rendering.

Purpose: Resolve CRITICAL UAT Issue #1 where all number tokens render clustered on the center tile instead of positioned on their respective hexes. This blocks core gameplay visibility as players cannot see which hexes have which numbers.

Output: NumberToken component properly transforms coordinates for correct positioning across the board.
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-board-generation-and-rendering/02-03-SUMMARY.md
@apps/web/src/components/Board/NumberToken.tsx
@apps/web/src/components/Board/TerrainHex.tsx
</context>

<tasks>

<task type="auto">
  <name>Convert cube coordinates to pixel coordinates in NumberToken component</name>
  <files>apps/web/src/components/Board/NumberToken.tsx</files>
  <action>
Root cause: NumberToken currently passes cube coordinates (q, r) directly to the Text component:
```tsx
<Text x={hex.q} y={hex.r} ... >
```

The Text component doesn't perform coordinate transformation like the Hexagon component does. This causes all text to cluster at cube coordinate positions instead of pixel positions.

Fix:
1. Import useLayoutContext hook from react-hexgrid at the top:
   ```tsx
   import { Text, useLayoutContext } from 'react-hexgrid';
   ```

2. Inside NumberToken component, get the layout context and hexToPixel function:
   ```tsx
   const { layout } = useLayoutContext();
   const hexToPixel = layout.hexToPixel.bind(layout);
   ```

3. Convert hex cube coordinates to pixel coordinates:
   ```tsx
   const cube = { q: hex.q, r: hex.r, s: -hex.q - hex.r };
   const pixel = hexToPixel(cube);
   ```

4. Update Text component to use pixel coordinates instead of cube:
   ```tsx
   <Text x={pixel.x} y={pixel.y} ... >
   ```

This matches the pattern used in TerrainHex.tsx where Hexagon components automatically transform coordinates, but Text requires manual transformation.

Preserve existing styling logic (6/8 highlighting remains unchanged).
  </action>
  <verify>
1. Verify imports added correctly:
   ```bash
   grep "useLayoutContext" apps/web/src/components/Board/NumberToken.tsx
   grep "hexToPixel" apps/web/src/components/Board/NumberToken.tsx
   ```
2. Run development server: `npx nx serve web` and `npx nx serve api`
3. Create a new game room and start the game
4. Visually inspect the board - number tokens should now be centered on their respective hexes
5. Verify 6 and 8 tokens still have bold red styling
6. Check browser console for any errors related to NumberToken or coordinates (especially "useLayoutContext is not defined")
  </verify>
  <done>
- useLayoutContext and hexToPixel imports present in NumberToken.tsx
- Number tokens positioned correctly on their assigned hexes (not clustered at center)
- Each of the 18 number tokens visible and properly spaced
- 6 and 8 tokens maintain bold red styling
- No console errors related to coordinate transformation
  </done>
</task>

</tasks>

<verification>
**Visual Inspection:**
- Create 2-3 new game boards
- Verify number tokens positioned correctly on each hex
- Confirm no clustering at center tile
- Verify 6/8 highlighting still works

**UAT Re-test:**
- Run UAT Test #2: "Board Generation - Number Token Placement"
- Should now pass: Each hex displays its assigned number centered on that hex
- Run UAT Test #7: "Board Rendering - Number Tokens Display"
- Should now pass: Tokens display with correct positioning and 6/8 styling
</verification>

<success_criteria>
**Observable truths achieved:**
1. User can see each hex's assigned number token centered on that hex
2. Number tokens distributed correctly across all 18 non-desert hexes
3. 6 and 8 tokens visually distinct with bold red styling
4. Board is readable and playable

**Measurable outcomes:**
- UAT Test #2 status changes from "failed" to "passed"
- UAT Test #7 status changes from "failed" to "passed"
- No console errors during board rendering
- Visual confirmation: no clustering, all tokens properly positioned
</success_criteria>

<output>
After completion, create `.planning/phases/02-board-generation-and-rendering/02-06-SUMMARY.md`
</output>
