---
phase: 02-board-generation-and-rendering
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - apps/api/src/handlers/websocket.ts
  - apps/web/src/app/app.tsx
  - apps/web/src/components/Board/Board.tsx
  - apps/web/src/components/Board/TerrainHex.tsx
  - apps/web/src/components/Board/NumberToken.tsx
  - apps/web/src/components/Board/Port.tsx
  - apps/web/src/components/Game.tsx
  - apps/web/src/stores/gameStore.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Board renders visually in browser"
    - "Hexes show terrain textures from SVG files"
    - "Number tokens display on hexes"
    - "Ports appear at correct edges"
    - "Board is centered and properly sized"
  artifacts:
    - path: "apps/web/src/components/Board/Board.tsx"
      provides: "Main board component with react-hexgrid"
      exports: ["Board"]
      min_lines: 80
    - path: "apps/web/src/components/Board/TerrainHex.tsx"
      provides: "Individual hex with terrain texture"
      exports: ["TerrainHex"]
      min_lines: 30
    - path: "apps/web/src/components/Board/NumberToken.tsx"
      provides: "Number overlay on hex"
      exports: ["NumberToken"]
      min_lines: 20
    - path: "apps/web/src/components/Board/Port.tsx"
      provides: "Port icon at hex edge"
      exports: ["Port"]
      min_lines: 25
    - path: "apps/web/src/components/Game.tsx"
      provides: "Game view container"
      exports: ["Game"]
      min_lines: 40
  key_links:
    - from: "apps/web/src/components/Board/Board.tsx"
      to: "react-hexgrid"
      via: "imports HexGrid, Layout, Hexagon, Pattern"
      pattern: "import.*HexGrid.*from.*react-hexgrid"
    - from: "apps/web/src/components/Board/TerrainHex.tsx"
      to: "apps/web/src/assets/tiles"
      via: "references SVG files in fill patterns"
      pattern: "/assets/tiles/"
    - from: "apps/web/src/components/Game.tsx"
      to: "apps/web/src/stores/gameStore.ts"
      via: "reads board state from store"
      pattern: "useGameStore.*board"
---

<objective>
Render the generated board visually in the browser using react-hexgrid with terrain textures, number tokens, and ports.

Purpose: Display the game board to players using SVG-based hex rendering with the existing asset library. The board should be visually clear, properly sized for the viewport, and match the warm aesthetic established in Phase 1.1.

Output: React components for board rendering, integrated with game state management and WebSocket updates. Board appears centered in the game view with proper spacing for UI elements.
</objective>

<execution_context>
@./.github/get-shit-done/workflows/execute-plan.md
@./.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-board-generation-and-rendering/02-CONTEXT.md
@.planning/phases/02-board-generation-and-rendering/02-RESEARCH.md
@apps/web/src/components/Lobby.tsx
@apps/web/src/stores/gameStore.ts
</context>

<tasks>

<task type="auto">
  <name>Create board rendering components</name>
  <files>
    apps/web/src/components/Board/Board.tsx
    apps/web/src/components/Board/TerrainHex.tsx
    apps/web/src/components/Board/NumberToken.tsx
    apps/web/src/components/Board/Port.tsx
  </files>
  <action>
**First, install react-hexgrid dependency:**
```bash
npm install react-hexgrid
```

Create react-hexgrid based board components:

**Board.tsx** (main container):
```typescript
import { HexGrid, Layout, Hexagon, Pattern, Text } from 'react-hexgrid';
import { BoardState } from '@catan/shared';
import TerrainHex from './TerrainHex';
import NumberToken from './NumberToken';
import Port from './Port';

interface BoardProps {
  board: BoardState;
}

export function Board({ board }: BoardProps) {
  return (
    <HexGrid width="100%" height="100%" viewBox="-50 -50 100 100">
      {/* Define SVG patterns for terrain textures */}
      <Pattern id="forest" link="/assets/tiles/forest.svg" />
      <Pattern id="hills" link="/assets/tiles/hills.svg" />
      <Pattern id="fields" link="/assets/tiles/fields.svg" />
      <Pattern id="pasture" link="/assets/tiles/pasture.svg" />
      <Pattern id="mountains" link="/assets/tiles/mountains.svg" />
      <Pattern id="desert" link="/assets/tiles/desert.svg" />
      
      {/* Pointy-top layout (flat=false) with moderate spacing */}
      <Layout size={{ x: 10, y: 10 }} flat={false} spacing={1.05} origin={{ x: 0, y: 0 }}>
        {board.hexes.map(hex => (
          <TerrainHex key={`${hex.q}-${hex.r}`} hex={hex} />
        ))}
      </Layout>
      
      {/* Render ports */}
      {board.ports.map((port, i) => (
        <Port key={i} port={port} />
      ))}
    </HexGrid>
  );
}
```

**TerrainHex.tsx** (individual hex):
```typescript
import { Hexagon, Text } from 'react-hexgrid';
import { Hex } from '@catan/shared';
import NumberToken from './NumberToken';

interface TerrainHexProps {
  hex: Hex;
}

export function TerrainHex({ hex }: TerrainHexProps) {
  return (
    <>
      <Hexagon 
        q={hex.q} 
        r={hex.r} 
        s={-hex.q - hex.r}
        fill={`url(#${hex.terrain})`}
        style={{
          stroke: '#8B7355',
          strokeWidth: 0.5,
          filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.15))'
        }}
      />
      {hex.number && <NumberToken hex={hex} />}
    </>
  );
}
```

**NumberToken.tsx** (number display):
```typescript
import { Text } from 'react-hexgrid';
import { Hex } from '@catan/shared';

interface NumberTokenProps {
  hex: Hex;
}

export function NumberToken({ hex }: NumberTokenProps) {
  if (!hex.number) return null;
  
  const isHighProbability = hex.number === 6 || hex.number === 8;
  
  return (
    <Text 
      x={hex.q} 
      y={hex.r}
      style={{
        fontSize: '5px',
        fontWeight: isHighProbability ? 'bold' : 'normal',
        fill: isHighProbability ? '#C73E1D' : '#4A4A4A',
        textAnchor: 'middle',
        dominantBaseline: 'central'
      }}
    >
      {hex.number}
    </Text>
  );
}
```

**Port.tsx** (port icons):
```typescript
import { Port as PortType } from '@catan/shared';

interface PortProps {
  port: PortType;
}

export function Port({ port }: PortProps) {
  // Calculate position based on hex coordinates and edge direction
  // Position port icon between hex and ocean
  const angle = port.edge * 60; // Each edge is 60 degrees apart
  const distance = 15; // Distance from hex center
  
  const x = port.hexQ + Math.cos(angle * Math.PI / 180) * distance;
  const y = port.hexR + Math.sin(angle * Math.PI / 180) * distance;
  
  return (
    <g transform={`translate(${x}, ${y})`}>
      <image 
        href={`/assets/ports/${port.type}.svg`}
        width="8" 
        height="8"
        x="-4"
        y="-4"
      />
    </g>
  );
}
```

**Key points:**
- Use `flat={false}` for pointy-top hexes
- `spacing={1.05}` adds small gaps between hexes for visual clarity
- SVG patterns reference files in `/assets/tiles` (assets already exist)
- Number tokens use red (#C73E1D) for 6/8 to indicate high probability
- Subtle drop shadows on hexes for depth
- Ports positioned at edges using trigonometry

Follow RESEARCH.md Pattern 1 for react-hexgrid usage.
  </action>
  <verify>
Check:
1. `npx nx build web` succeeds
2. No TypeScript errors in board components
3. SVG pattern imports resolve correctly
  </verify>
  <done>
- All board components created
- react-hexgrid imported and used correctly
- Terrain patterns reference existing SVG assets
- Number tokens display with 6/8 highlighted
- Port components positioned at edges
- Components compile without errors
  </done>
</task>

<task type="auto">
  <name>Create Game view and integrate board</name>
  <files>apps/web/src/components/Game.tsx, apps/web/src/stores/gameStore.ts</files>
  <action>
Create Game view component that displays the board:

**Game.tsx:**
```typescript
import { Box, Container, Stack, Title, Text } from '@mantine/core';
import { Board } from './Board/Board';
import { useGameStore } from '../stores/gameStore';

export function Game() {
  const board = useGameStore(state => state.board);
  
  if (!board) {
    return (
      <Container size="sm" py="xl">
        <Stack align="center" gap="md">
          <Title order={2}>Loading board...</Title>
          <Text c="dimmed">Generating your adventure...</Text>
        </Stack>
      </Container>
    );
  }
  
  return (
    <Box 
      style={{
        minHeight: '100vh',
        backgroundColor: '#F9F4EF', // Warm beige from Phase 1.1
        display: 'grid',
        gridTemplateColumns: '250px 1fr 200px',
        gridTemplateRows: '1fr 150px',
        gap: '16px',
        padding: '16px'
      }}
    >
      {/* Player info - left sidebar */}
      <Box style={{ gridColumn: '1', gridRow: '1 / 3' }}>
        {/* Placeholder for player info */}
      </Box>
      
      {/* Board - center */}
      <Box style={{ gridColumn: '2', gridRow: '1' }}>
        <Board board={board} />
      </Box>
      
      {/* Action history - right sidebar */}
      <Box style={{ gridColumn: '3', gridRow: '1 / 3' }}>
        {/* Placeholder for action history */}
      </Box>
      
      {/* Player actions - bottom */}
      <Box style={{ gridColumn: '2', gridRow: '2' }}>
        {/* Placeholder for player actions */}
      </Box>
    </Box>
  );
}
```

**Update gameStore.ts** to include board state:
```typescript
import { BoardState } from '@catan/shared';

interface GameState {
  board: BoardState | null;
  setBoard: (board: BoardState) => void;
  // ... existing state
}

export const useGameStore = create<GameState>((set) => ({
  board: null,
  setBoard: (board) => set({ board }),
  // ... existing state
}));
```

**Layout structure:**
- Four-quadrant grid layout as specified in CONTEXT.md
- Player info left (250px)
- Board center (flexible)
- Action history right (200px)
- Player actions bottom (150px)
- Warm beige background (#F9F4EF) consistent with lobby

The placeholders will be filled in later phases. This creates the structure for the game view.
  </action>
  <verify>
Check:
1. `npx nx build web` succeeds
2. Game component renders without errors
3. Grid layout applies correctly
4. gameStore has board state management
  </verify>
  <done>
- Game.tsx created with four-quadrant layout
- Board component integrated in center area
- gameStore extended with board state
- Loading state shown when board is null
- Warm beige background applied
- Component compiles successfully
  </done>
</task>

<task type="auto">
  <name>Wire game start to board generation and rendering</name>
  <files>apps/api/src/handlers/websocket.ts, apps/web/src/app/app.tsx</files>
  <action>
Connect the game start flow to board generation and display:

**On server (websocket.ts):**

1. Import board generator:
```typescript
import { generateBoard } from '../game/board-generator';
```

2. Locate the toggle_ready message handler

3. Add logic: when all players ready AND countdown reaches 0, trigger game start:
```typescript
case 'toggle_ready': {
  // ... existing toggle ready logic ...
  
  // After updating ready state, check if all ready
  const allReady = room.players.every(p => p.ready);
  
  if (allReady && countdown === 0) {
    // Generate board
    const board = generateBoard();
    
    // Store in room
    roomManager.setBoard(roomId, board);
    
    // Broadcast game_started message
    roomManager.broadcastToRoom(roomId, {
      type: 'game_started',
      board: board,
    });
  }
  break;
}
```

**On client (app.tsx):**

1. Import Game component:
```typescript
import { Game } from '../components/Game';
```

2. Add game state to track which view to show:
```typescript
const gameStarted = useGameStore(state => state.gameStarted);
```

3. Update gameStore (in gameStore.ts) to include gameStarted flag:
```typescript
interface GameState {
  board: BoardState | null;
  gameStarted: boolean;
  setBoard: (board: BoardState) => void;
  setGameStarted: (started: boolean) => void;
  // ... existing state
}

export const useGameStore = create<GameState>((set) => ({
  board: null,
  gameStarted: false,
  setBoard: (board) => set({ board }),
  setGameStarted: (started) => set({ gameStarted: started }),
  // ... existing state
}));
```

4. In WebSocket message handler (services/websocket.ts), handle game_started:
```typescript
case 'game_started': {
  const gameStore = useGameStore.getState();
  gameStore.setBoard(message.board);
  gameStore.setGameStarted(true);
  break;
}
```

5. Update App.tsx routing logic to conditionally render Game or Lobby:
```typescript
export function App() {
  const gameStarted = useGameStore(state => state.gameStarted);
  
  // Existing room/connection state...
  
  if (gameStarted) {
    return <Game />;
  }
  
  if (inRoom) {
    return <Lobby />;
  }
  
  return <LandingForm />;
}
```

**Flow:**
1. All players ready → countdown starts
2. Countdown finishes → server generates board
3. Server broadcasts game_started with board
4. Clients receive board, store in gameStore
5. UI switches from Lobby to Game view
6. Board renders immediately

No intermediate loading screens or animations per CONTEXT.md (instant transition, board reveals fully).
  </action>
  <verify>
Manual test:
1. Start dev servers: `npx nx serve api` and `npx nx serve web`
2. Open two browser tabs, create room, both join
3. Both mark ready
4. After countdown, verify:
   - Game view appears
   - Board renders with hexes, numbers, ports
   - Both clients see same board
5. Check browser console for no errors
6. Check network tab: game_started message has board data
  </verify>
  <done>
- Server generates board on game start
- game_started message broadcasts board to all clients
- Clients receive board and store in gameStore
- UI transitions from Lobby to Game view
- Board renders immediately after transition
- Manual testing confirms flow works end-to-end
  </done>
</task>

</tasks>

<verification>
**After all tasks complete:**

1. **Visual verification:**
   - Board appears centered in viewport
   - Hexes show terrain textures (forest green, hills brown, etc.)
   - Number tokens visible on non-desert hexes
   - 6 and 8 numbers highlighted in red
   - 9 ports visible around perimeter
   - Desert hex has no number token

2. **Layout verification:**
   - Four-quadrant grid structure present
   - Board fills center area appropriately
   - Sidebar placeholders visible
   - Warm beige background (#F9F4EF) applied

3. **Technical verification:**
   - No console errors
   - No missing texture warnings
   - react-hexgrid renders SVG properly
   - Game state persists across renders (no flickering)

4. **Multi-player verification:**
   - Both players see identical board (same hex positions, numbers, ports)
   - Board generation is deterministic for a given game session
</verification>

<success_criteria>
- Board renders visually with terrain textures
- Number tokens display correctly (6/8 highlighted)
- Ports appear at coast edges
- Board centered and properly sized for viewport
- Transition from lobby to game works smoothly
- All players see the same board
- No visual artifacts or rendering errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-board-generation-and-rendering/02-03-SUMMARY.md`
</output>
