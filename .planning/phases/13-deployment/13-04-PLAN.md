---
phase: 13-deployment
plan: 04
type: execute
wave: 2
depends_on: [13-01, 13-02, 13-03]
files_modified:
  - DEPLOYMENT.md
  - terraform/README.md
autonomous: false

must_haves:
  truths:
    - User can follow documentation to deploy the application
    - Documentation covers all prerequisite steps
    - Deployment process is verified end-to-end
    - Service is accessible via Cloud Run URL
  artifacts:
    - path: DEPLOYMENT.md
      provides: Complete deployment guide
      min_lines: 100
    - path: terraform/README.md
      provides: Terraform-specific instructions
      min_lines: 30
  key_links:
    - from: DEPLOYMENT.md
      to: Docker build instructions
      via: Container image creation
      pattern: docker build
    - from: DEPLOYMENT.md
      to: Terraform apply
      via: Infrastructure deployment
      pattern: terraform apply
---

<objective>
Create comprehensive deployment documentation and verify the deployment process end-to-end.

Purpose: Provide clear instructions for deploying the Catan application to Google Cloud Run, covering all prerequisites, build steps, and deployment commands.

Output: DEPLOYMENT.md with full deployment guide, terraform/README.md with Terraform-specific details, and human verification that deployment works.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-deployment/13-CONTEXT.md
@.planning/phases/13-deployment/13-RESEARCH.md
@.planning/phases/13-deployment/13-01-PLAN.md
@.planning/phases/13-deployment/13-02-PLAN.md
@.planning/phases/13-deployment/13-03-PLAN.md
@Dockerfile
@terraform/main.tf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive deployment guide</name>
  <files>DEPLOYMENT.md</files>
  <action>
Create DEPLOYMENT.md at project root with complete deployment instructions:

**Structure:**

1. **Prerequisites**
   - GCP account with billing enabled
   - gcloud CLI installed and authenticated (gcloud auth login)
   - Docker installed locally
   - Terraform installed (>= 1.0)
   - Project created in GCP Console

2. **Initial GCP Setup** (one-time)
   - Create GCP project: gcloud projects create [PROJECT_ID]
   - Enable required APIs:
     - Cloud Run API: gcloud services enable run.googleapis.com
     - Artifact Registry API: gcloud services enable artifactregistry.googleapis.com
     - Cloud Build API: gcloud services enable cloudbuild.googleapis.com
   - Create Artifact Registry repository: gcloud artifacts repositories create catan --repository-format=docker --location=europe-west1
   - Create GCS bucket for Terraform state: gsutil mb -l EU gs://catan-terraform-state
   - Get billing account ID: gcloud billing accounts list

3. **Build Container Image**
   - Build Docker image: docker build -t catan:latest .
   - Tag for Artifact Registry: docker tag catan:latest europe-west1-docker.pkg.dev/[PROJECT_ID]/catan/catan:latest
   - Authenticate Docker: gcloud auth configure-docker europe-west1-docker.pkg.dev
   - Push image: docker push europe-west1-docker.pkg.dev/[PROJECT_ID]/catan/catan:latest

4. **Configure Terraform**
   - Copy terraform/terraform.tfvars.example to terraform/terraform.tfvars
   - Fill in required values:
     - project_id (GCP project ID)
     - image_url (full Artifact Registry URL)
     - billing_account_id (from gcloud billing accounts list)
     - alert_email (email for budget alerts)
   - Review optional variables (region, service_name, resource limits)

5. **Deploy Infrastructure**
   - Initialize Terraform: cd terraform && terraform init
   - Review plan: terraform plan
   - Apply configuration: terraform apply
   - Note the service_url output

6. **Verify Deployment**
   - Visit service_url (Cloud Run URL ending in .run.app)
   - Test frontend loads
   - Create a game room
   - Join as second player in incognito window
   - Verify WebSocket connection works

7. **Cost Management**
   - Check current costs: gcloud billing projects describe [PROJECT_ID] --format="table(billingAccountName, billingEnabled)"
   - View budget alerts in GCP Console > Billing > Budgets & alerts
   - Monitor Cloud Run metrics in GCP Console > Cloud Run > [service-name] > Metrics

8. **Updating Deployment**
   - Build new image: docker build -t catan:latest . && docker tag ... && docker push ...
   - Update Terraform: terraform apply (with new image_url in tfvars)
   - Verify: curl [service_url]/api

9. **Troubleshooting**
   - Check logs: gcloud run services logs read catan-game --region=europe-west1
   - View service details: gcloud run services describe catan-game --region=europe-west1
   - Common issues:
     - "Container failed to start" → Check PORT environment variable
     - "404 on frontend" → Verify static files in dist/apps/web
     - "WebSocket disconnect after 5 min" → Check timeout=3600s in main.tf
     - "Budget alert received" → Review Cloud Run metrics for unexpected traffic

10. **Teardown**
    - Destroy infrastructure: cd terraform && terraform destroy
    - Delete Artifact Registry images: gcloud artifacts docker images delete ...
    - Delete GCS state bucket: gsutil rm -r gs://catan-terraform-state
    - Delete GCP project (optional): gcloud projects delete [PROJECT_ID]

Include warnings from 13-RESEARCH.md Common Pitfalls:

- MUST listen on process.env.PORT and 0.0.0.0 (Pitfall 1)
- Free tier only in US regions, not Europe (Pitfall 4)
- Session affinity is best-effort (Pitfall 3)
- WebSocket connections incur instance-based billing (Pitfall 2)
  </action>
  <verify>
  cat DEPLOYMENT.md | wc -l (should be > 100 lines)
  grep -i "gcloud" DEPLOYMENT.md (should have gcloud commands)
  grep -i "terraform" DEPLOYMENT.md (should have terraform commands)
  </verify>
  <done>DEPLOYMENT.md created with comprehensive step-by-step guide including prerequisites, setup, deployment, and troubleshooting</done>
  </task>

<task type="auto">
  <name>Task 2: Create Terraform-specific README</name>
  <files>terraform/README.md</files>
  <action>
Create terraform/README.md with Terraform-specific documentation:

**Structure:**

1. **Overview**
   - What this Terraform configuration deploys
   - Architecture summary (single Cloud Run service, scale to zero, WebSocket-optimized)

2. **Files**
   - backend.tf: GCS state backend
   - variables.tf: Input variables
   - main.tf: Cloud Run service
   - iam.tf: Public access policy
   - billing.tf: Budget alerts
   - outputs.tf: Service URL and metadata

3. **Prerequisites**
   - Terraform >= 1.0
   - GCP project with billing enabled
   - GCS bucket for state: gs://catan-terraform-state
   - Container image pushed to Artifact Registry

4. **Configuration**
   - Copy terraform.tfvars.example to terraform.tfvars
   - Required variables: project_id, image_url, billing_account_id, alert_email
   - Optional variables: region, service_name, resource limits

5. **Usage**
   - Init: terraform init
   - Plan: terraform plan
   - Apply: terraform apply
   - Destroy: terraform destroy

6. **Cost Optimization Settings**
   - Scale to zero: min_instances = 0
   - Single instance max: max_instances = 1
   - Instance-based billing: cpu_idle = false
   - Concurrency limit: max_concurrency = 20
   - Budget alerts at 50%, 80%, 100%, 120% of EUR 5/month

7. **WebSocket Configuration**
   - Timeout: 3600s (1 hour for full game sessions)
   - Session affinity: enabled (best-effort)
   - Concurrency: 20 (conservative for WebSocket stability)

8. **Outputs**
   - service_url: Cloud Run URL for accessing application
   - service_name: Name of deployed service
   - service_location: Region where service is deployed

Include reference to 13-CONTEXT.md decisions for rationale.
</action>
<verify>
cat terraform/README.md | wc -l (should be > 30 lines)
grep -i "variables" terraform/README.md
</verify>
<done>terraform/README.md created with Terraform-specific documentation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete deployment pipeline including Docker build, Terraform infrastructure, and budget monitoring. This checkpoint verifies the entire deployment process works end-to-end.
  </what-built>
  
  <how-to-verify>
**Follow DEPLOYMENT.md to test the deployment process:**

1. **Prerequisites Check:**
   - Verify you have GCP account with billing enabled
   - Check: gcloud --version (should show gcloud CLI installed)
   - Check: docker --version (should show Docker installed)
   - Check: terraform --version (should show Terraform >= 1.0)

2. **Build and Test Locally (optional but recommended):**
   - Run: docker build -t catan-test .
   - Verify: docker images | grep catan-test (image should be < 400MB)
   - Test container locally: docker run -p 8080:8080 -e PORT=8080 catan-test
   - Visit: http://localhost:8080 (frontend should load)
   - Visit: http://localhost:8080/api (should return JSON welcome message)
   - Stop container: Ctrl+C

3. **GCP Setup (if not done already):**
   - Create or select GCP project
   - Enable required APIs (Cloud Run, Artifact Registry, Cloud Build)
   - Create Artifact Registry repository
   - Create GCS bucket for Terraform state
   - Get billing account ID for budget alerts

4. **Push Image to GCP:**
   - Build and tag image for Artifact Registry
   - Authenticate Docker with gcloud
   - Push image to Artifact Registry
   - Verify: gcloud artifacts docker images list --repository=catan --location=europe-west1

5. **Deploy with Terraform:**
   - Create terraform/terraform.tfvars with your values
   - Run: cd terraform && terraform init
   - Run: terraform plan (review changes)
   - Run: terraform apply (type 'yes' when prompted)
   - Note the service_url output (should end in .run.app)

6. **Verify Deployment:**
   - Visit the service_url from Terraform output
   - Frontend should load with lobby interface
   - Create a game room and get room code
   - Open incognito window, join room with different nickname
   - Verify WebSocket connection works (both players see each other)
   - Test game functionality (ready up, start game, basic gameplay)

7. **Verify Cost Controls:**
   - Check GCP Console > Cloud Run > catan-game > Metrics
   - Verify instance count scales to 0 when no traffic
   - Check GCP Console > Billing > Budgets & alerts
   - Verify budget alert is configured

8. **Check Logs (optional):**
   - Run: gcloud run services logs read catan-game --region=europe-west1 --limit=50
   - Should see startup logs and WebSocket connection logs

**Expected Results:**

- ✓ Docker build completes successfully
- ✓ Image size < 400MB (Alpine Node.js)
- ✓ Frontend loads and displays lobby interface
- ✓ WebSocket connections work between multiple clients
- ✓ Service scales to zero when idle
- ✓ Budget alerts configured in GCP Console
- ✓ Terraform outputs show service URL

**Common Issues:**

- If frontend shows 404: Check dist/apps/web exists in built image
- If WebSocket disconnects quickly: Verify timeout=3600s in main.tf
- If container fails to start: Check logs for PORT binding errors
- If budget alerts missing: Verify billing_account_id is correct

**Note:** You can optionally skip actual GCP deployment if cost is a concern. Verify:

- Docker build completes locally
- terraform validate passes
- Documentation is clear and complete
</how-to-verify>
  <resume-signal>
Type "approved" if deployment works end-to-end, OR describe any issues encountered during verification.

If you chose to skip actual GCP deployment, type "approved-local-only" to confirm Docker build and Terraform validation passed.
</resume-signal>
</task>

</tasks>

<verification>
1. DEPLOYMENT.md covers all deployment steps from prerequisites to teardown
2. terraform/README.md explains Terraform configuration and usage
3. Documentation includes troubleshooting section with common pitfalls
4. Human verification confirms deployment works end-to-end OR local build succeeds
5. Budget alerts are configured and visible in GCP Console
6. Service is accessible via Cloud Run URL
</verification>

<success_criteria>

- Comprehensive deployment documentation created
- All steps clearly explained with commands
- Troubleshooting guidance includes research pitfalls
- Human verification confirms either:
  - Full deployment to GCP works (service accessible, WebSocket functional, budget alerts configured)
  - OR local Docker build succeeds and Terraform validates (if GCP deployment skipped)
- Documentation sufficient for future deployments
  </success_criteria>

<output>
After completion, create `.planning/phases/13-deployment/13-04-SUMMARY.md`
</output>
