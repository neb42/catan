---
phase: 13-deployment
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - terraform/billing.tf
  - terraform/variables.tf
autonomous: true

must_haves:
  truths:
    - Budget alerts configured at multiple cost thresholds
    - Notifications sent to email when budget thresholds exceeded
    - Monitoring targets Cloud Run service specifically
  artifacts:
    - path: terraform/billing.tf
      provides: Budget alerts and cost monitoring
      min_lines: 40
      contains: google_billing_budget
    - path: terraform/variables.tf
      provides: Alert email variable
      contains: alert_email
  key_links:
    - from: terraform/billing.tf
      to: google_billing_budget
      via: Budget resource definition
      pattern: resource.*google_billing_budget
    - from: terraform/billing.tf
      to: google_monitoring_notification_channel
      via: Email notification channel
      pattern: resource.*google_monitoring_notification_channel
---

<objective>
Configure budget alerts and cost monitoring to prevent unexpected billing.

Purpose: Implement Terraform-managed budget alerts with email notifications at multiple thresholds to ensure deployment stays within cost constraints.

Output: billing.tf with budget resource and notification channels, alert_email variable.
</objective>

<execution_context>
@/Users/bmcalindin/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bmcalindin/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-deployment/13-CONTEXT.md
@.planning/phases/13-deployment/13-RESEARCH.md
@.planning/phases/13-deployment/13-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add billing variables to variables.tf</name>
  <files>terraform/variables.tf</files>
  <action>
Add two variables to terraform/variables.tf (append to existing file):

```hcl
variable "billing_account_id" {
  description = "GCP billing account ID for budget alerts"
  type        = string
  sensitive   = true
}

variable "alert_email" {
  description = "Email address for budget alert notifications"
  type        = string
  sensitive   = true
}

variable "monthly_budget_euros" {
  description = "Monthly budget in EUR for cost alerts"
  type        = number
  default     = 5
}
```

Also update terraform/terraform.tfvars.example to include these:

```hcl
# Budget monitoring
billing_account_id = "012345-ABCDEF-678901"
alert_email        = "your-email@example.com"
# monthly_budget_euros = 5  # Optional override
```

The billing_account_id can be found in GCP Console > Billing.
</action>
<verify>
cd terraform && terraform validate
</verify>
<done>Billing and alert variables added to variables.tf with sensitive flag</done>
</task>

<task type="auto">
  <name>Task 2: Create budget alerts and notification configuration</name>
  <files>terraform/billing.tf</files>
  <action>
Create terraform/billing.tf with budget monitoring resources:

```hcl
# Email notification channel for budget alerts
resource "google_monitoring_notification_channel" "email" {
  display_name = "Catan Budget Alert Email"
  type         = "email"

  labels = {
    email_address = var.alert_email
  }

  enabled = true
}

# Budget alert for Cloud Run costs
resource "google_billing_budget" "cloud_run_budget" {
  billing_account = var.billing_account_id
  display_name    = "Cloud Run Monthly Budget"

  budget_filter {
    # Target Cloud Run service specifically
    projects = ["projects/${var.project_id}"]
    services = ["services/152E-C115-5142"]  # Cloud Run service code

    # Optional: Uncomment to filter by specific labels
    # labels = {
    #   "service" = var.service_name
    # }
  }

  amount {
    specified_amount {
      currency_code = "EUR"
      units         = tostring(var.monthly_budget_euros)
    }
  }

  # Alert at 50% of budget
  threshold_rules {
    threshold_percent = 0.5
    spend_basis       = "CURRENT_SPEND"
  }

  # Alert at 80% of budget
  threshold_rules {
    threshold_percent = 0.8
    spend_basis       = "CURRENT_SPEND"
  }

  # Alert at 100% of budget
  threshold_rules {
    threshold_percent = 1.0
    spend_basis       = "CURRENT_SPEND"
  }

  # Alert at 120% of budget (overspend warning)
  threshold_rules {
    threshold_percent = 1.2
    spend_basis       = "CURRENT_SPEND"
  }

  all_updates_rule {
    monitoring_notification_channels = [
      google_monitoring_notification_channel.email.id
    ]

    disable_default_iam_recipients = false
  }
}
```

Configuration aligns with 13-CONTEXT.md cost optimization priority: "Configure Terraform billing alerts at cost thresholds (e.g., $5, $10, $20)". Using EUR 5 as default with thresholds at 50%, 80%, 100%, and 120%.

Follow research Pattern 3 from 13-RESEARCH.md:262-303.
</action>
<verify>
cd terraform && terraform validate
terraform fmt -check billing.tf
</verify>
<done>Budget alerts configured with email notifications at multiple thresholds</done>
</task>

</tasks>

<verification>
1. Billing variables added to variables.tf with sensitive flag
2. terraform.tfvars.example includes billing configuration examples
3. Budget resource targets Cloud Run service specifically
4. Four alert thresholds configured (50%, 80%, 100%, 120%)
5. Email notification channel created and linked to budget
6. terraform validate passes without errors
</verification>

<success_criteria>

- Budget alerts configured for Cloud Run service
- Email notifications enabled at 50%, 80%, 100%, and 120% thresholds
- Default budget set to EUR 5 per month (configurable via variable)
- Billing account ID and alert email marked as sensitive
- All Terraform syntax valid
  </success_criteria>

<output>
After completion, create `.planning/phases/13-deployment/13-03-SUMMARY.md`
</output>
