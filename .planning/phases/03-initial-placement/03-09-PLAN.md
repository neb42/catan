---
phase: 03-initial-placement
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/Lobby.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'After all players complete both placement rounds (8 total rounds), the placement phase ends'
    - 'The game transitions to the main game phase automatically'
    - 'The UI updates to show main game indicators (dice roll button, turn-based play)'
  artifacts:
    - path: 'apps/web/src/components/Lobby.tsx'
      provides: 'setup_complete message handler'
      contains: 'setup_complete'
      min_lines: 235
  key_links:
    - from: 'apps/api/src/handlers/websocket.ts'
      to: 'apps/web/src/components/Lobby.tsx'
      via: 'setup_complete WebSocket message'
      pattern: "case 'setup_complete'"
---

<objective>
Add WebSocket message handler for 'setup_complete' to transition from placement phase to main game, fixing the blocker identified in UAT Test 9.

Purpose: The backend correctly sends setup_complete message after turn 15 (last placement), but the client ignores it, leaving the UI stuck in placement mode. Adding the handler will trigger phase transition and unlock main game phase.

Output: Working phase transition that clears placement state and prepares UI for turn-based gameplay.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-initial-placement/03-UAT.md

# Prior work that established WebSocket handlers

@.planning/phases/03-initial-placement/03-07-SUMMARY.md

# File to modify

@apps/web/src/components/Lobby.tsx

# Backend implementation that sends the message

@apps/api/src/handlers/websocket.ts

# Shared message schemas

@libs/shared/src/schemas/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Add setup_complete message handler</name>
  <files>apps/web/src/components/Lobby.tsx</files>
  <action>
Add 'setup_complete' case to the WebSocket message handler switch statement in Lobby.tsx (after line 209, before the 'error' case):

```typescript
case 'setup_complete': {
  // Clear placement-specific state
  useGameStore.getState().clearPlacementState();
  break;
}
```

Context from UAT diagnosis:

- Backend sends setup_complete message after turn 15 (last placement round)
- Message is defined in libs/shared/src/schemas/messages.ts
- Client currently has no handler, so placement state never clears
- clearPlacementState() action already exists in gameStore (line 62 of gameStore.ts)

Why clearPlacementState() is sufficient:

- Resets currentPlayerIndex, currentPlayerId, placementPhase, draftRound to null
- Keeps settlements and roads (needed for rendering)
- This state change will cause placement UI components to unmount/hide
- Phase 4 (Turn Structure) will introduce main game UI that activates when placementPhase is null

Insert the new case after the 'road_placed' case (line 209) and before 'error' case (line 211).
</action>
<verify>

1. Run `npx nx typecheck web` to verify TypeScript compilation
2. Check that setup_complete case exists in switch statement
3. Verify clearPlacementState is called from gameStore
4. Confirm case placement is between gameplay handlers and error handler
   </verify>
   <done>

- setup_complete case handler exists in Lobby.tsx message handler
- Handler calls gameStore.clearPlacementState()
- TypeScript compiles without errors
- Message handler chain is complete (placement_turn -> settlement_placed -> road_placed -> setup_complete)
  </done>
  </task>

</tasks>

<verification>
After completing the task:

1. **Type check:** `npx nx typecheck web` passes
2. **Build check:** `npx nx build web` succeeds
3. **Manual smoke test:**
   - Start 4-player game
   - Complete all 8 placement rounds (1→2→3→4→4→3→2→1)
   - After the last player places their second road, verify:
     - Placement UI clears (no more valid vertex/edge highlights)
     - Turn indicator updates (placement phase cleared)
     - No longer stuck in placement mode
     - Ready for Phase 4 main game UI

**Note:** Phase 4 has not been implemented yet, so the UI will show the board with placed pieces but no dice roll button yet. That's expected. The critical fix is that placement state CLEARS, unblocking future development.
</verification>

<success_criteria>

- setup_complete case handler exists in Lobby.tsx
- Handler correctly calls clearPlacementState() from gameStore
- TypeScript compilation passes
- Placement state clears after all 8 rounds complete
- UAT Test 9 blocker resolved: "After the last placement round, the first player is stuck on the road placement" → now clears properly
- Ready for Phase 4 implementation (Turn Structure & Resources)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-initial-placement/03-09-SUMMARY.md`
</output>
