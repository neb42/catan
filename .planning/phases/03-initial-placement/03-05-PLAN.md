---
phase: 03-initial-placement
plan: 05
type: execute
wave: 3
depends_on: ['03-03', '03-04']
files_modified:
  - apps/web/src/components/Board/VertexMarker.tsx
  - apps/web/src/components/Board/EdgeMarker.tsx
  - apps/web/src/components/Board/PlacementOverlay.tsx
  - apps/web/src/components/Board/PlacementControls.tsx
  - apps/web/src/components/Board/Board.tsx
autonomous: true

must_haves:
  truths:
    - 'Valid placement locations render as clickable dots with player color glow'
    - 'Clicking a valid location shows preview and confirm/cancel controls'
    - 'Invalid locations show tooltip explanation on hover'
    - 'Only active player sees valid placement locations'
  artifacts:
    - path: 'apps/web/src/components/Board/VertexMarker.tsx'
      provides: 'Clickable settlement location markers'
      exports: ['VertexMarker']
    - path: 'apps/web/src/components/Board/EdgeMarker.tsx'
      provides: 'Clickable road location markers'
      exports: ['EdgeMarker']
    - path: 'apps/web/src/components/Board/PlacementOverlay.tsx'
      provides: 'Overlay layer rendering all placement markers'
      exports: ['PlacementOverlay']
    - path: 'apps/web/src/components/Board/PlacementControls.tsx'
      provides: 'Confirm/cancel buttons for placement'
      exports: ['PlacementControls']
  key_links:
    - from: 'apps/web/src/components/Board/PlacementOverlay.tsx'
      to: 'apps/web/src/hooks/useValidLocations.ts'
      via: 'Uses valid location hooks'
      pattern: 'useValidSettlementLocations|useValidRoadLocations'
    - from: 'apps/web/src/components/Board/Board.tsx'
      to: 'apps/web/src/components/Board/PlacementOverlay.tsx'
      via: 'Renders overlay when in placement phase'
      pattern: 'PlacementOverlay'
---

<objective>
Create interactive UI components for settlement and road placement on the hex board.

Purpose: Players need visual feedback for valid placement locations and a clear interaction flow (click to select → preview → confirm/cancel). The context specifies dots with subtle glow, enhanced hover, and invalid location tooltips.

Output: VertexMarker, EdgeMarker, PlacementOverlay, PlacementControls components, integrated into Board.tsx.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-initial-placement/03-CONTEXT.md
@.planning/phases/03-initial-placement/03-RESEARCH.md
@apps/web/src/components/Board/Board.tsx
@apps/web/src/hooks/useValidLocations.ts
@apps/web/src/hooks/usePlacementState.ts
@apps/web/src/stores/gameStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VertexMarker and EdgeMarker components</name>
  <files>apps/web/src/components/Board/VertexMarker.tsx, apps/web/src/components/Board/EdgeMarker.tsx</files>
  <action>
Create `apps/web/src/components/Board/VertexMarker.tsx`:

```typescript
import { motion } from 'motion/react';
import type { Vertex } from '@catan/shared';

interface VertexMarkerProps {
  vertex: Vertex;
  isValid: boolean;
  isSelected: boolean;
  playerColor: string;
  invalidReason?: string;
  onClick: () => void;
}

export function VertexMarker({
  vertex,
  isValid,
  isSelected,
  playerColor,
  invalidReason,
  onClick,
}: VertexMarkerProps) {
  // Don't render invalid markers (no visual clutter)
  // Tooltip for invalid handled separately if needed

  return (
    <g>
      {/* Large transparent hitbox for easier clicking */}
      <circle
        cx={vertex.x}
        cy={vertex.y}
        r={isValid ? 3 : 1.5}
        fill="transparent"
        style={{ cursor: isValid ? 'pointer' : 'default' }}
        onClick={isValid ? onClick : undefined}
      >
        {/* SVG native tooltip for invalid locations */}
        {!isValid && invalidReason && <title>{invalidReason}</title>}
      </circle>

      {/* Visual dot for valid locations */}
      {isValid && (
        <motion.circle
          cx={vertex.x}
          cy={vertex.y}
          r={1.2}
          fill={playerColor}
          stroke="white"
          strokeWidth={0.3}
          initial={{ scale: 0, opacity: 0 }}
          animate={{
            scale: isSelected ? 1.4 : 1,
            opacity: isSelected ? 1 : 0.7,
          }}
          whileHover={{ scale: 1.3, opacity: 0.9 }}
          transition={{ type: 'spring', stiffness: 400, damping: 25 }}
          style={{
            filter: `drop-shadow(0 0 ${isSelected ? 4 : 2}px ${playerColor})`,
          }}
        />
      )}

      {/* Selection preview - settlement shape */}
      {isSelected && (
        <motion.g
          initial={{ scale: 0, opacity: 0 }}
          animate={{ scale: 1, opacity: 0.8 }}
          transition={{ type: 'spring', stiffness: 300, damping: 20 }}
        >
          {/* Simple house shape for settlement preview */}
          <motion.path
            d={`M ${vertex.x} ${vertex.y - 3}
                L ${vertex.x + 2} ${vertex.y - 1}
                L ${vertex.x + 2} ${vertex.y + 2}
                L ${vertex.x - 2} ${vertex.y + 2}
                L ${vertex.x - 2} ${vertex.y - 1} Z`}
            fill={playerColor}
            stroke="white"
            strokeWidth={0.4}
            animate={{
              y: [0, -0.5, 0],
            }}
            transition={{
              duration: 1.5,
              repeat: Infinity,
              ease: 'easeInOut',
            }}
          />
        </motion.g>
      )}
    </g>
  );
}
```

Create `apps/web/src/components/Board/EdgeMarker.tsx`:

```typescript
import { motion } from 'motion/react';
import type { Edge } from '@catan/shared';

interface EdgeMarkerProps {
  edge: Edge;
  isValid: boolean;
  isSelected: boolean;
  playerColor: string;
  invalidReason?: string;
  onClick: () => void;
}

export function EdgeMarker({
  edge,
  isValid,
  isSelected,
  playerColor,
  invalidReason,
  onClick,
}: EdgeMarkerProps) {
  const { start, end, midpoint } = edge;

  // Calculate angle for road orientation
  const angle = Math.atan2(end.y - start.y, end.x - start.x) * (180 / Math.PI);

  return (
    <g>
      {/* Large transparent hitbox along the edge */}
      <line
        x1={start.x}
        y1={start.y}
        x2={end.x}
        y2={end.y}
        stroke="transparent"
        strokeWidth={isValid ? 4 : 2}
        style={{ cursor: isValid ? 'pointer' : 'default' }}
        onClick={isValid ? onClick : undefined}
      >
        {!isValid && invalidReason && <title>{invalidReason}</title>}
      </line>

      {/* Visual indicator for valid edge */}
      {isValid && (
        <motion.circle
          cx={midpoint.x}
          cy={midpoint.y}
          r={1}
          fill={playerColor}
          stroke="white"
          strokeWidth={0.2}
          initial={{ scale: 0, opacity: 0 }}
          animate={{
            scale: isSelected ? 1.3 : 0.8,
            opacity: isSelected ? 1 : 0.6,
          }}
          whileHover={{ scale: 1.2, opacity: 0.85 }}
          transition={{ type: 'spring', stiffness: 400, damping: 25 }}
          style={{
            filter: `drop-shadow(0 0 ${isSelected ? 3 : 1.5}px ${playerColor})`,
          }}
        />
      )}

      {/* Selection preview - road segment */}
      {isSelected && (
        <motion.line
          x1={start.x}
          y1={start.y}
          x2={end.x}
          y2={end.y}
          stroke={playerColor}
          strokeWidth={1.5}
          strokeLinecap="round"
          initial={{ pathLength: 0, opacity: 0 }}
          animate={{ pathLength: 1, opacity: 0.85 }}
          transition={{ duration: 0.3, ease: 'easeOut' }}
          style={{
            filter: `drop-shadow(0 0 2px ${playerColor})`,
          }}
        />
      )}
    </g>
  );
}
```

  </action>
  <verify>Run `npx nx build web` - builds without TypeScript errors</verify>
  <done>VertexMarker and EdgeMarker render interactive placement locations with animations</done>
</task>

<task type="auto">
  <name>Task 2: Create PlacementOverlay and integrate into Board</name>
  <files>apps/web/src/components/Board/PlacementOverlay.tsx, apps/web/src/components/Board/PlacementControls.tsx, apps/web/src/components/Board/Board.tsx</files>
  <action>
Create `apps/web/src/components/Board/PlacementOverlay.tsx`:

```typescript
import { AnimatePresence } from 'motion/react';
import { useValidSettlementLocations, useValidRoadLocations } from '../../hooks/useValidLocations';
import { usePlacementState } from '../../hooks/usePlacementState';
import { useGameStore, useSelectedLocation, usePlacementActions } from '../../stores/gameStore';
import { VertexMarker } from './VertexMarker';
import { EdgeMarker } from './EdgeMarker';

// Player color map - matches PLAYER_COLORS from shared
const PLAYER_COLOR_HEX: Record<string, string> = {
  red: '#E53935',
  blue: '#1E88E5',
  white: '#F5F5F5',
  orange: '#FB8C00',
  green: '#43A047',
  yellow: '#FDD835',
  purple: '#8E24AA',
  brown: '#6D4C41',
};

interface PlacementOverlayProps {
  currentPlayerColor: string; // e.g., 'red', 'blue'
}

export function PlacementOverlay({ currentPlayerColor }: PlacementOverlayProps) {
  const { phase, isMyTurn, canPlace } = usePlacementState();
  const selectedLocationId = useSelectedLocation();
  const { setSelected } = usePlacementActions();

  const validSettlements = useValidSettlementLocations();
  const validRoads = useValidRoadLocations();

  const colorHex = PLAYER_COLOR_HEX[currentPlayerColor] || currentPlayerColor;

  // Only show placement UI for the active player
  if (!canPlace) return null;

  return (
    <g className="placement-overlay">
      <AnimatePresence>
        {phase === 'settlement' && (
          <>
            {validSettlements.map(({ vertex, isValid, invalidReason }) => (
              <VertexMarker
                key={vertex.id}
                vertex={vertex}
                isValid={isValid}
                isSelected={selectedLocationId === vertex.id}
                playerColor={colorHex}
                invalidReason={invalidReason}
                onClick={() => setSelected(vertex.id)}
              />
            ))}
          </>
        )}

        {phase === 'road' && (
          <>
            {validRoads.map(({ edge, isValid, invalidReason }) => (
              <EdgeMarker
                key={edge.id}
                edge={edge}
                isValid={isValid}
                isSelected={selectedLocationId === edge.id}
                playerColor={colorHex}
                invalidReason={invalidReason}
                onClick={() => setSelected(edge.id)}
              />
            ))}
          </>
        )}
      </AnimatePresence>
    </g>
  );
}
```

Create `apps/web/src/components/Board/PlacementControls.tsx`:

```typescript
import { motion, AnimatePresence } from 'motion/react';
import { Button, Group, Text } from '@mantine/core';
import { useSelectedLocation, useGameStore, usePlacementActions } from '../../stores/gameStore';
import { usePlacementState } from '../../hooks/usePlacementState';

export function PlacementControls() {
  const selectedLocationId = useSelectedLocation();
  const { phase, isMyTurn } = usePlacementState();
  const { setSelected } = usePlacementActions();
  const sendMessage = useGameStore((state) => state.sendMessage);

  const handleConfirm = () => {
    if (!selectedLocationId || !sendMessage) return;

    if (phase === 'settlement') {
      sendMessage({ type: 'place_settlement', vertexId: selectedLocationId });
    } else if (phase === 'road') {
      sendMessage({ type: 'place_road', edgeId: selectedLocationId });
    }

    setSelected(null);
  };

  const handleCancel = () => {
    setSelected(null);
  };

  if (!isMyTurn || !phase) return null;

  return (
    <AnimatePresence>
      {selectedLocationId && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: 20 }}
          transition={{ type: 'spring', stiffness: 300, damping: 25 }}
          style={{
            position: 'absolute',
            bottom: 24,
            left: '50%',
            transform: 'translateX(-50%)',
            zIndex: 100,
          }}
        >
          <Group gap="sm">
            <Button variant="default" onClick={handleCancel}>
              Cancel
            </Button>
            <Button onClick={handleConfirm}>
              Confirm {phase === 'settlement' ? 'Settlement' : 'Road'}
            </Button>
          </Group>
        </motion.div>
      )}

      {!selectedLocationId && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          style={{
            position: 'absolute',
            bottom: 24,
            left: '50%',
            transform: 'translateX(-50%)',
            zIndex: 100,
          }}
        >
          <Text size="sm" c="dimmed">
            Click a valid location to place your {phase}
          </Text>
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

Update `apps/web/src/components/Board/Board.tsx` to include PlacementOverlay:

Add imports:

```typescript
import { PlacementOverlay } from './PlacementOverlay';
import { PlacementControls } from './PlacementControls';
import { useGameStore } from '../../stores/gameStore';
import { usePlacementState } from '../../hooks/usePlacementState';
```

Inside the Board component, after terrain hexes render:

- Get current player color from room state or game store
- Render `<PlacementOverlay currentPlayerColor={currentPlayerColor} />` inside the SVG
- Render `<PlacementControls />` outside the SVG (positioned absolutely)

The PlacementOverlay should be rendered AFTER terrain hexes but inside the same SVG group to overlay on the board.
</action>
<verify>Run `npx nx build web` - builds without TypeScript errors</verify>
<done>PlacementOverlay renders valid locations, PlacementControls shows confirm/cancel, Board integrates both</done>
</task>

</tasks>

<verification>
1. `npx nx build web` succeeds
2. Valid locations render as colored dots with glow effect
3. Hovering valid location enhances glow
4. Clicking valid location shows preview and confirm/cancel buttons
5. Invalid locations show tooltip on hover
6. Only active player sees placement UI
</verification>

<success_criteria>

- Settlement markers appear at valid vertices during settlement phase
- Road markers appear at valid edges during road phase
- Click to select, click elsewhere to move selection
- Confirm button triggers WebSocket message
- Cancel clears selection
- Animations are smooth (spring-based)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-initial-placement/03-05-SUMMARY.md`
</output>
