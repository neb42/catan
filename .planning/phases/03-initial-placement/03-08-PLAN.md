---
phase: 03-initial-placement
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/Lobby.tsx
  - apps/web/src/components/GamePlayerList.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'After placing second settlement, player immediately receives resources based on adjacent hexes'
    - 'Resource count updates visibly in the UI for the receiving player'
    - 'All players can see resource counts for all players in the game'
  artifacts:
    - path: 'apps/web/src/stores/gameStore.ts'
      provides: 'PlayerResources state management'
      exports: ['playerResources state', 'updatePlayerResources action']
      min_lines: 150
    - path: 'apps/web/src/components/Lobby.tsx'
      provides: 'settlement_placed handler processes resourcesGranted'
      contains: 'resourcesGranted'
      min_lines: 230
    - path: 'apps/web/src/components/GamePlayerList.tsx'
      provides: 'Resource count display with icons'
      contains: 'playerResources'
      min_lines: 130
  key_links:
    - from: 'apps/web/src/components/Lobby.tsx'
      to: 'gameStore.updatePlayerResources'
      via: 'settlement_placed handler'
      pattern: 'updatePlayerResources.*resourcesGranted'
    - from: 'apps/web/src/components/GamePlayerList.tsx'
      to: 'gameStore.playerResources'
      via: 'useGameStore hook'
      pattern: 'useGameStore.*playerResources'
---

<objective>
Add resource state management and UI display to show resource counts for all players, fixing the missing resource UI identified in UAT Test 7.

Purpose: Players need to see their resource counts update when placing their second settlement, and all players should be able to see each other's resource counts throughout the game.

Output: Working resource display in player list that updates when resources are granted during initial placement.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-initial-placement/03-UAT.md

# Prior work that established the foundation

@.planning/phases/03-initial-placement/03-07-SUMMARY.md

# Files to modify

@apps/web/src/stores/gameStore.ts
@apps/web/src/components/Lobby.tsx
@apps/web/src/components/GamePlayerList.tsx

# Shared types

@libs/shared/src/schemas/game.ts
@libs/shared/src/schemas/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Add playerResources state to gameStore</name>
  <files>apps/web/src/stores/gameStore.ts</files>
  <action>
Add PlayerResources state management to gameStore:

1. Import PlayerResources type from @catan/shared
2. Add playerResources field to GameStore interface: `playerResources: Record<string, PlayerResources>`
3. Initialize playerResources state: `playerResources: {}`
4. Add updatePlayerResources action that accepts playerId and resources array from backend:
   ```typescript
   updatePlayerResources: (playerId: string, resources: Array<{type: 'wood' | 'brick' | 'sheep' | 'wheat' | 'ore', count: number}>) => void
   ```
5. Implementation should merge the new resources with existing counts (not replace):
   ```typescript
   updatePlayerResources: (playerId, resources) =>
     set((state) => {
       const current = state.playerResources[playerId] || {
         wood: 0,
         brick: 0,
         sheep: 0,
         wheat: 0,
         ore: 0,
       };
       const updated = { ...current };
       resources.forEach((r) => {
         updated[r.type] = (updated[r.type] || 0) + r.count;
       });
       return {
         playerResources: {
           ...state.playerResources,
           [playerId]: updated,
         },
       };
     });
   ```
6. Add getPlayerResources selector hook for components:
   ```typescript
   export const usePlayerResources = (playerId: string) =>
     useGameStore(
       (state) =>
         state.playerResources[playerId] || {
           wood: 0,
           brick: 0,
           sheep: 0,
           wheat: 0,
           ore: 0,
         },
     );
   ```

This provides the state foundation needed by the UI components.
</action>
<verify>

1. Run `npx nx typecheck web` to verify TypeScript types are correct
2. Check that PlayerResources is imported from @catan/shared
3. Verify updatePlayerResources action signature matches backend resourcesGranted format
   </verify>
   <done>

- playerResources state exists in gameStore (Record<string, PlayerResources>)
- updatePlayerResources action can process backend resourcesGranted array
- usePlayerResources selector hook available for components
- TypeScript compiles without errors
  </done>
  </task>

<task type="auto">
  <name>Wire settlement_placed handler to process resourcesGranted</name>
  <files>apps/web/src/components/Lobby.tsx</files>
  <action>
Update the settlement_placed message handler in Lobby.tsx (lines 194-200):

Currently ignores resourcesGranted field. Change:

```typescript
case 'settlement_placed': {
  useGameStore.getState().addSettlement({
    vertexId: message.vertexId,
    playerId: message.playerId,
    isCity: false,
  });
  break;
}
```

To:

```typescript
case 'settlement_placed': {
  useGameStore.getState().addSettlement({
    vertexId: message.vertexId,
    playerId: message.playerId,
    isCity: false,
  });

  // Process starting resources from second settlement
  if (message.resourcesGranted && message.resourcesGranted.length > 0) {
    useGameStore.getState().updatePlayerResources(message.playerId, message.resourcesGranted);
  }
  break;
}
```

This wires the backend-calculated resources to the client state.
</action>
<verify>

1. Run `npx nx typecheck web` to verify changes compile
2. Check that handler calls updatePlayerResources when resourcesGranted exists
3. Verify TypeScript accepts message.resourcesGranted (should be typed from shared schema)
   </verify>
   <done>

- settlement_placed handler processes resourcesGranted field
- updatePlayerResources called with playerId and resources array
- TypeScript compiles without errors
- Handler preserves existing settlement placement logic
  </done>
  </task>

<task type="auto">
  <name>Add resource count display to GamePlayerList</name>
  <files>apps/web/src/components/GamePlayerList.tsx</files>
  <action>
Extend GamePlayerList component to display resource counts below the player nickname:

1. Import usePlayerResources hook from gameStore
2. Import ResourceType from @catan/shared for type safety
3. Add resource icon mapping (use emoji for now, can be replaced with SVG later):
   ```typescript
   const RESOURCE_ICONS: Record<string, string> = {
     wood: 'ü™µ',
     brick: 'üß±',
     sheep: 'üêë',
     wheat: 'üåæ',
     ore: '‚õ∞Ô∏è',
   };
   ```
4. Inside the player map loop, fetch resources for each player:
   ```typescript
   const playerResources = usePlayerResources(player.id);
   ```
5. Add resource count display between nickname and turn badge:
   ```typescript
   {/* Resource counts */}
   <Stack gap={2} mt="xs">
     {Object.entries(playerResources).map(([type, count]) => (
       <Text key={type} size="xs" c="dimmed" style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
         <span>{RESOURCE_ICONS[type]}</span>
         <span>{count}</span>
       </Text>
     ))}
   </Stack>
   ```

Keep the layout compact. Resource counts should be visible but not overwhelming. All 5 resource types should display (even when 0) so the layout is consistent across all players.

Design consideration: Display resources vertically to save horizontal space in the 2x2 grid.
</action>
<verify>

1. Run `npx nx typecheck web` to verify changes compile
2. Check that usePlayerResources hook is called for each player
3. Verify all 5 resource types render with icons and counts
4. Run `npm run format` to ensure code style is correct
   </verify>
   <done>

- GamePlayerList displays resource counts for all players
- All 5 resource types shown with icons (wood, brick, sheep, wheat, ore)
- Resource counts update when playerResources state changes
- Layout remains compact and readable in 2x2 grid
- TypeScript compiles without errors
  </done>
  </task>

</tasks>

<verification>
After completing all tasks:

1. **Type check:** `npx nx typecheck web` passes
2. **Build check:** `npx nx build web` succeeds
3. **Manual smoke test:** Start backend and frontend, create game, place settlements:
   - Check that resource counts render in player list (initially all zeros)
   - Place second settlement on hexes with resources
   - Verify resource counts update for the player who placed the settlement
   - Confirm all players see the updated resource counts
     </verification>

<success_criteria>

- playerResources state exists in gameStore and can track resources for all players
- settlement_placed handler processes resourcesGranted from backend
- GamePlayerList displays resource counts with icons for all players
- Resource counts update in real-time when second settlements are placed
- All TypeScript compilation passes
- UAT Test 7 expectation met: "After placing your second settlement, you immediately receive resources based on the adjacent hexes and your resource count updates visibly in the UI"
  </success_criteria>

<output>
After completion, create `.planning/phases/03-initial-placement/03-08-SUMMARY.md`
</output>
